<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>




  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Miibotree'thinking">
<meta property="og:url" content="http://yoursite.com/page/16/index.html">
<meta property="og:site_name" content="Miibotree'thinking">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Miibotree'thinking">
<meta name="twitter:description">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

    <title> Miibotree'thinking </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->




<div class="container one-column 
   page-home 
">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Miibotree'thinking</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-about"></i> <br />
            关于
          </a>
        </li>
      
    </ul>
  

  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/05/01/利用socket做的帮室友找对象小软件/" itemprop="url">
                利用socket做的帮室友找对象小软件
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-05-01T16:00:01+08:00" content="2012-05-01">
            2012-05-01
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>以前在linux上面写过socket的通信，今天想在windows下面再用SDK重新写一遍</p>
<p>下面先附张图片来看看整个框架：</p>
<p>然后自己先在控制台下实现：</p>
<p>服务器端：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#include &amp;lt;stdio.h&amp;gt;</span></span><br><span class="line"><span class="preprocessor">#include &amp;lt;WinSock2.h&amp;gt;</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> comment (lib, "ws2_32.lib")</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MAXLINE 4096</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">WSADATA wsaData;</span><br><span class="line">SOCKET ListeningSocket;</span><br><span class="line">SOCKET NewConnection;</span><br><span class="line">SOCKADDR_IN ServerAddr;</span><br><span class="line">SOCKADDR_IN ClientAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Port = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">int</span> ClientAddrLen;</span><br><span class="line"><span class="keyword">int</span> iResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> buff[MAXLINE];</span><br><span class="line"><span class="keyword">char</span> sendline[MAXLINE];</span><br><span class="line"><span class="keyword">int</span> send_bytes;</span><br><span class="line"><span class="comment">//初始化Windows Socket 2.2</span></span><br><span class="line">WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;amp;wsaData );</span><br><span class="line"><span class="comment">//创建socket</span></span><br><span class="line">ListeningSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"><span class="comment">//填写服务端地址信息</span></span><br><span class="line"><span class="comment">//端口为10000</span></span><br><span class="line"><span class="comment">//IP地址</span></span><br><span class="line">ServerAddr.sin_family = AF_INET;</span><br><span class="line">ServerAddr.sin_port = htons(Port);</span><br><span class="line">ServerAddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"><span class="comment">//绑定监听端口</span></span><br><span class="line">iResult = bind(ListeningSocket, (SOCKADDR*) &amp;amp;ServerAddr, <span class="keyword">sizeof</span>(ServerAddr));</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"bind faied: %dn"</span>, WSAGetLastError());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"bind succeed!n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//监听</span></span><br><span class="line">iResult = listen(ListeningSocket, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"listen failed %dn"</span>, WSAGetLastError());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"listen succeed!n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//接受建立连接</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"wait for linking........n"</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//NewConnection = accept(ListeningSocket, (SOCKADDR*)&amp;amp;ClientAddr, &amp;amp;ClientAddrLen);</span></span><br><span class="line">NewConnection = accept(ListeningSocket, NULL, NULL);</span><br><span class="line"><span class="built_in">memset</span>(buff, <span class="number">0</span>, MAXLINE);</span><br><span class="line"><span class="keyword">if</span> (NewConnection == INVALID_SOCKET)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//printf("accept socket error!n");</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"accept failed %dn"</span>, WSAGetLastError());</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//服务器端接受消息</span></span><br><span class="line">n = recv(NewConnection, buff, MAXLINE, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (n == -<span class="number">1</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">buff[n] = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"从客户端来的消息:%sn"</span>, buff);</span><br><span class="line"><span class="comment">//closesocket(NewConnection);</span></span><br><span class="line"><span class="comment">//continue;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//服务器端发送消息</span></span><br><span class="line"><span class="built_in">memset</span>(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"请输入发送消息n"</span>);</span><br><span class="line">gets(sendline);</span><br><span class="line"></span><br><span class="line">send_bytes = send(NewConnection, sendline, <span class="built_in">strlen</span>(sendline), <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (send_bytes &amp;gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"发送消息成功,发送消息字节数为%dn"</span>, send_bytes);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"发送消息失败,发送消息字节数为%dn"</span>, send_bytes);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭监听Socket</span></span><br><span class="line">closesocket(NewConnection);</span><br><span class="line">closesocket(ListeningSocket);</span><br><span class="line"><span class="comment">//释放windows socket DLL的相关资源</span></span><br><span class="line">WSACleanup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#include &amp;lt;stdio.h&amp;gt;</span></span><br><span class="line"><span class="preprocessor">#include &amp;lt;WinSock2.h&amp;gt;</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> comment (lib, "ws2_32.lib")</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MAXLINE 4096</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">WSADATA wsaData;<span class="comment">//库文件</span></span><br><span class="line">SOCKET s;<span class="comment">//socket</span></span><br><span class="line">SOCKADDR_IN ServerAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Port = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">int</span> send_bytes;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> buff[MAXLINE];</span><br><span class="line"><span class="keyword">char</span> sendline[MAXLINE];</span><br><span class="line"><span class="comment">//初始化Windows Socket 2.2</span></span><br><span class="line">WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;amp;wsaData );</span><br><span class="line"><span class="comment">//创建socket</span></span><br><span class="line">s = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"><span class="comment">//填写服务端地址信息</span></span><br><span class="line"><span class="comment">//端口为10000</span></span><br><span class="line"><span class="comment">//IP地址</span></span><br><span class="line">ServerAddr.sin_family = AF_INET;</span><br><span class="line">ServerAddr.sin_port = htons(Port);</span><br><span class="line">ServerAddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"><span class="comment">//绑定监听端口 因为是客户端，这里我们就不需要绑定了</span></span><br><span class="line"><span class="comment">//bind(ListeningSocket, (SOCKADDR*) &amp;amp;ServerAddr, sizeof(ServerAddr));</span></span><br><span class="line"><span class="comment">//接受新的连接 服务器端才接受连接</span></span><br><span class="line"><span class="comment">//NewConnection = accept(ListeningSocket, (SOCKADDR*)&amp;amp;ClientAddr, &amp;amp;ClientAddrLen);</span></span><br><span class="line"><span class="comment">//这里是客户端， 所以应该请求连接</span></span><br><span class="line"><span class="keyword">if</span> (connect(s, (SOCKADDR*) &amp;amp;ServerAddr, <span class="keyword">sizeof</span>(ServerAddr)) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"连接错误！n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"连接成功！n"</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//客户端发送消息</span></span><br><span class="line"><span class="built_in">memset</span>(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"请输入发送消息n"</span>);</span><br><span class="line">gets(sendline);</span><br><span class="line"></span><br><span class="line">send_bytes = send(s, sendline, <span class="built_in">strlen</span>(sendline), <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (send_bytes &amp;gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"发送消息成功,发送消息字节数为%dn"</span>, send_bytes);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"发送消息失败,发送消息字节数为%dn"</span>, send_bytes);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//客户端接受消息</span></span><br><span class="line">n = recv(s, buff, MAXLINE, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (n == -<span class="number">1</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">buff[n] = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"从客户端来的消息:%sn"</span>, buff);</span><br><span class="line"><span class="comment">//closesocket(NewConnection);</span></span><br><span class="line"><span class="comment">//continue;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭监听Socket</span></span><br><span class="line">closesocket(s);</span><br><span class="line"><span class="comment">//释放windows socket DLL的相关资源</span></span><br><span class="line">WSACleanup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在控制台实现的基础上，尝试用SDK写一下，加上了点自己的创意，做个帮室友找对象的小软件。</p>
<p>客户端用到了对话框和菜单资源，服务器端没有用资源，直接用的窗口子类化写的。</p>
<p>client</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#include &amp;lt;windows.h&amp;gt;</span></span><br><span class="line"><span class="preprocessor">#include <span class="title">"resource.h"</span></span></span><br><span class="line"><span class="preprocessor">#include &amp;lt;stdio.h&amp;gt;</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma comment (lib, <span class="title">"ws2_32.lib"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#define MAXLINE 4096</span></span><br><span class="line"></span><br><span class="line">LRESULT <span class="built_in">CALLBACK</span> WndProc (HWND, <span class="built_in">UINT</span>, WPARAM, LPARAM) ;</span><br><span class="line"><span class="built_in">BOOL</span> <span class="built_in">CALLBACK</span> AboutDlgProc (HWND, <span class="built_in">UINT</span>, WPARAM, LPARAM) ;</span><br><span class="line"><span class="built_in">BOOL</span> <span class="built_in">CALLBACK</span> ServerDlgProc (HWND, <span class="built_in">UINT</span>, WPARAM, LPARAM) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> WINAPI WinMain (HI<span class="built_in">NSTANCE</span> hInstance, HI<span class="built_in">NSTANCE</span> hPrevInstance,</span><br><span class="line">PSTR szCmdLine, <span class="keyword">int</span> iCmdShow)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">static</span> TCHAR szAppName[] = TEXT (<span class="string">"ModeDia"</span>) ;</span><br><span class="line">HWND hwnd ;</span><br><span class="line">MSG msg ;</span><br><span class="line">WNDCLASS wndclass ;</span><br><span class="line"></span><br><span class="line">wndclass<span class="variable">.style</span> = CS_HREDRAW | CS_VREDRAW ;</span><br><span class="line">wndclass<span class="variable">.lpfnWndProc</span> = WndProc ;</span><br><span class="line">wndclass<span class="variable">.cbClsExtra</span> = <span class="number">0</span> ;</span><br><span class="line">wndclass<span class="variable">.cbWndExtra</span> = <span class="number">0</span> ;</span><br><span class="line">wndclass<span class="variable">.hInstance</span> = hInstance ;</span><br><span class="line">wndclass<span class="variable">.hIcon</span> = LoadIcon (<span class="literal">NULL</span>, IDI_APPLI<span class="built_in">CATION</span>) ;</span><br><span class="line">wndclass<span class="variable">.hCursor</span> = LoadCursor (<span class="literal">NULL</span>, IDC_ARROW) ;</span><br><span class="line">wndclass<span class="variable">.hbrBackground</span> = (HBRUSH) GetStockObject (WHITE_BRUSH) ;</span><br><span class="line">wndclass<span class="variable">.lpszMenuName</span> = szAppName ;</span><br><span class="line">wndclass<span class="variable">.lpszClassName</span> = szAppName ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!RegisterClass (&amp;amp;wndclass))</span><br><span class="line">&#123;</span><br><span class="line">MessageBox (<span class="literal">NULL</span>, TEXT (<span class="string">"This program requires Windows NT!"</span>),</span><br><span class="line">szAppName, MB_ICONERROR) ;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hwnd = CreateWindow (szAppName,</span><br><span class="line">TEXT (<span class="string">"帮室友找对象"</span>),</span><br><span class="line">WS_OVERLAPPEDWINDOW,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">hInstance,</span><br><span class="line"><span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">ShowWindow (hwnd, iCmdShow) ;</span><br><span class="line">UpdateWindow (hwnd) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (GetMessage (&amp;amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">TranslateMessage (&amp;amp;msg) ;</span><br><span class="line">DispatchMessage (&amp;amp;msg) ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> msg<span class="variable">.wParam</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LRESULT <span class="built_in">CALLBACK</span> WndProc (HWND hwnd, <span class="built_in">UINT</span> message, WPARAM wParam, LPARAM lParam)</span><br><span class="line">&#123;</span><br><span class="line">HDC hdc ;</span><br><span class="line">PAINTSTRUCT ps ;</span><br><span class="line">RECT rect ;</span><br><span class="line"><span class="keyword">static</span> HI<span class="built_in">NSTANCE</span> hInstance;</span><br><span class="line"><span class="keyword">switch</span> (message)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> WM_CREATE:</span><br><span class="line">hInstance = ((LPCREATESTRUCT) lParam) -&amp;gt; hInstance;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> WM_COMMAND:</span><br><span class="line"><span class="keyword">switch</span> (LOWORD (wParam))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> IDM_APP_ABOUT :</span><br><span class="line">DialogBox (hInstance, TEXT(<span class="string">"AboutBox"</span>), hwnd, AboutDlgProc);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> IDM_APP_SERVER :</span><br><span class="line">DialogBox(hInstance, TEXT(<span class="string">"ServerInfo"</span>),hwnd,ServerDlgProc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> WM_PAINT:</span><br><span class="line">hdc = BeginPaint (hwnd, &amp;amp;ps) ;</span><br><span class="line"></span><br><span class="line">GetClientRect (hwnd, &amp;amp;rect) ;</span><br><span class="line"></span><br><span class="line">DrawText (hdc, TEXT (<span class="string">"还在搞基？你OUT了!帮室友找对象，去寻找你心中的她把!!"</span>), -<span class="number">1</span>, &amp;amp;rect,</span><br><span class="line">DT_SINGLELINE | DT_CENTER | DT_VCENTER) ;</span><br><span class="line"></span><br><span class="line">EndPaint (hwnd, &amp;amp;ps) ;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">PostQuitMessage (<span class="number">0</span>) ;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> DefWindowProc (hwnd, message, wParam, lParam) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> <span class="built_in">CALLBACK</span> AboutDlgProc(HWND hDlg, <span class="built_in">UINT</span> message, WPARAM wParam, LPARAM lParam)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span> (message)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> WM_INITDIALOG:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> WM_COMMAND:</span><br><span class="line"><span class="keyword">switch</span> (LOWORD(wParam))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> IDOK:</span><br><span class="line"><span class="comment">//这里我们来处理socket</span></span><br><span class="line">&#123;</span><br><span class="line">WSADATA wsaData;<span class="comment">//库文件</span></span><br><span class="line">SOCKET s;<span class="comment">//socket</span></span><br><span class="line">SOCKADDR_IN ServerAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buff1[MAXLINE];</span><br><span class="line"><span class="keyword">char</span> buff2[MAXLINE];</span><br><span class="line"><span class="keyword">char</span> buff3[MAXLINE];</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Port = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">int</span> send_bytes;</span><br><span class="line">TCHAR sendline[MAXLINE];</span><br><span class="line"><span class="comment">//初始化Windows Socket 2.2</span></span><br><span class="line">WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;amp;wsaData );</span><br><span class="line"><span class="comment">//创建socket</span></span><br><span class="line">s = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"><span class="comment">//填写服务端地址信息</span></span><br><span class="line"><span class="comment">//端口为10000</span></span><br><span class="line"><span class="comment">//IP地址</span></span><br><span class="line">ServerAddr<span class="variable">.sin_family</span> = AF_INET;</span><br><span class="line">ServerAddr<span class="variable">.sin_port</span> = htons(Port);</span><br><span class="line">ServerAddr<span class="variable">.sin_addr</span><span class="variable">.s_addr</span> = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (connect(s, (SOCKADDR*) &amp;amp;ServerAddr, <span class="keyword">sizeof</span>(ServerAddr)) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hDlg, TEXT(<span class="string">"连接错误"</span>), TEXT(<span class="string">"错误啦"</span>), MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hDlg, TEXT(<span class="string">"连接成功"</span>), TEXT(<span class="string">"成功啦"</span>), MB_OK);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端发送消息</span></span><br><span class="line">memset(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line">GetDlgItemText(hDlg, IDC_NAME, sendline, <span class="keyword">sizeof</span>(sendline));</span><br><span class="line">send_bytes = send(s, (<span class="keyword">const</span> <span class="keyword">char</span>*)sendline, <span class="keyword">sizeof</span>(sendline)/<span class="keyword">sizeof</span>(TCHAR), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">memset(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line">GetDlgItemText(hDlg, IDC_AGE, sendline, <span class="keyword">sizeof</span>(sendline));</span><br><span class="line">send_bytes = send(s, (<span class="keyword">const</span> <span class="keyword">char</span>*)sendline, <span class="keyword">sizeof</span>(sendline)/<span class="keyword">sizeof</span>(TCHAR), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">memset(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line">GetDlgItemText(hDlg, IDC_INFO, sendline, <span class="keyword">sizeof</span>(sendline));</span><br><span class="line">send_bytes = send(s, (<span class="keyword">const</span> <span class="keyword">char</span>*)sendline, <span class="keyword">sizeof</span>(sendline)/<span class="keyword">sizeof</span>(TCHAR), <span class="number">0</span>);</span><br><span class="line"><span class="comment">//客户端接收消息</span></span><br><span class="line">memset(buff1, <span class="number">0</span>, MAXLINE);</span><br><span class="line">memset(buff2, <span class="number">0</span>, MAXLINE);</span><br><span class="line">memset(buff3, <span class="number">0</span>, MAXLINE);</span><br><span class="line"></span><br><span class="line">n = recv(s, buff1, MAXLINE, <span class="number">0</span>);</span><br><span class="line">n = recv(s, buff2, MAXLINE, <span class="number">0</span>);</span><br><span class="line">n = recv(s, buff3, MAXLINE, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">SetDlgItemText(hDlg, IDC_NAME1, (LPCWSTR)buff1);</span><br><span class="line">SetDlgItemText(hDlg, IDC_AGE1, (LPCWSTR)buff2);</span><br><span class="line">SetDlgItemText(hDlg, IDC_INFO1, (LPCWSTR)buff3);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (send_bytes &amp;gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hDlg, TEXT(<span class="string">"发送消息成功"</span>), TEXT(<span class="string">"成功啦"</span>), MB_OK);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hDlg, TEXT(<span class="string">"发送消息失败"</span>), TEXT(<span class="string">"失败啦"</span>), MB_OK);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭监听Socket</span></span><br><span class="line">closesocket(s);</span><br><span class="line"><span class="comment">//释放windows socket DLL的相关资源</span></span><br><span class="line">WSACleanup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> ID<span class="built_in">CANCEL</span>:</span><br><span class="line">EndDialog(hDlg, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> <span class="built_in">CALLBACK</span> ServerDlgProc(HWND hDlg, <span class="built_in">UINT</span> message, WPARAM wParam, LPARAM lParam)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span> (message)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> WM_INITDIALOG:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> WM_COMMAND:</span><br><span class="line"><span class="keyword">switch</span> (LOWORD(wParam))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> IDOK:</span><br><span class="line">EndDialog(hDlg, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*------------------------------------------------------------</span><br><span class="line">TCP 通信之帮室友找对象 服务器端</span><br><span class="line"></span><br><span class="line">Powered by Miibotree</span><br><span class="line">------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#include &amp;lt;stdio.h&amp;gt;</span></span><br><span class="line"><span class="preprocessor">#include &amp;lt;windows.h&amp;gt;</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma comment (lib, <span class="title">"ws2_32.lib"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#define MAXLINE 4096</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#define IDC_BUTTON1 1001</span></span><br><span class="line"><span class="preprocessor">#define IDC_BUTTON2 1002</span></span><br><span class="line"><span class="preprocessor">#define IDC_EDIT1 1003</span></span><br><span class="line"><span class="preprocessor">#define IDC_EDIT2 1004</span></span><br><span class="line"><span class="preprocessor">#define IDC_EDIT3 1005</span></span><br><span class="line"><span class="preprocessor">#define IDC_EDIT4 1006</span></span><br><span class="line"><span class="preprocessor">#define IDC_EDIT5 1007</span></span><br><span class="line"><span class="preprocessor">#define IDC_EDIT6 1008</span></span><br><span class="line"></span><br><span class="line">LRESULT <span class="built_in">CALLBACK</span> WndProc (HWND, <span class="built_in">UINT</span>, WPARAM, LPARAM);</span><br><span class="line"></span><br><span class="line"><span class="comment">//int Listen_socket(HWND hwnd, int choose);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> WINAPI WinMain (HI<span class="built_in">NSTANCE</span> hInstance, HI<span class="built_in">NSTANCE</span> hPrevInstance,</span><br><span class="line">PSTR szCmdLine, <span class="keyword">int</span> iCmdShow)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">static</span> TCHAR szAppName[] = TEXT(<span class="string">"server"</span>);</span><br><span class="line">HWND hwnd;</span><br><span class="line">MSG msg;</span><br><span class="line">WNDCLASS wndclass;</span><br><span class="line"></span><br><span class="line">wndclass<span class="variable">.style</span> = CS_HREDRAW | CS_VREDRAW ;</span><br><span class="line">wndclass<span class="variable">.lpfnWndProc</span> = WndProc ;</span><br><span class="line">wndclass<span class="variable">.cbClsExtra</span> = <span class="number">0</span> ;</span><br><span class="line">wndclass<span class="variable">.cbWndExtra</span> = <span class="number">0</span> ;</span><br><span class="line">wndclass<span class="variable">.hInstance</span> = hInstance ;</span><br><span class="line">wndclass<span class="variable">.hIcon</span> = LoadIcon (<span class="literal">NULL</span>, IDI_APPLI<span class="built_in">CATION</span>) ;</span><br><span class="line">wndclass<span class="variable">.hCursor</span> = LoadCursor (<span class="literal">NULL</span>, IDC_ARROW) ;</span><br><span class="line">wndclass<span class="variable">.hbrBackground</span> = (HBRUSH) GetStockObject (WHITE_BRUSH) ;</span><br><span class="line">wndclass<span class="variable">.lpszMenuName</span> = <span class="literal">NULL</span> ;</span><br><span class="line">wndclass<span class="variable">.lpszClassName</span> = szAppName ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!RegisterClass (&amp;amp;wndclass))</span><br><span class="line">&#123;</span><br><span class="line">MessageBox (<span class="literal">NULL</span>, TEXT (<span class="string">"This program requires Windows NT!"</span>),</span><br><span class="line">szAppName, MB_ICONERROR) ;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hwnd = CreateWindow (szAppName,</span><br><span class="line">TEXT (<span class="string">"这里是天堂社区，负责牵红线射丘比特之箭"</span>),</span><br><span class="line">WS_OVERLAPPEDWINDOW,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line">CW_USEDEFAULT,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">hInstance,</span><br><span class="line"><span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">ShowWindow (hwnd, iCmdShow);</span><br><span class="line">UpdateWindow (hwnd) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (GetMessage (&amp;amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">TranslateMessage (&amp;amp;msg) ;</span><br><span class="line">DispatchMessage (&amp;amp;msg) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> msg<span class="variable">.wParam</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LRESULT <span class="built_in">CALLBACK</span> WndProc (HWND hwnd, <span class="built_in">UINT</span> message, WPARAM wParam, LPARAM lParam)</span><br><span class="line">&#123;</span><br><span class="line">HDC hdc;</span><br><span class="line">PAINTSTRUCT ps;</span><br><span class="line">RECT rect;</span><br><span class="line">HWND hwndButton;</span><br><span class="line">HWND hwndEdit;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> cxChar, cyChar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>(message)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> WM_CREATE:</span><br><span class="line">cxChar = LOWORD (GetDialogBaseUnits ()) ;</span><br><span class="line">cyChar = HIWORD (GetDialogBaseUnits ()) ;</span><br><span class="line">hwndButton = CreateWindow ( TEXT(<span class="string">"button"</span>),</span><br><span class="line">TEXT(<span class="string">"月老/丘比特开始连线"</span>),</span><br><span class="line">WS_CHILD | WS_VISIBLE | BS_PUSHBUTTON,</span><br><span class="line">cxChar + <span class="number">420</span>, cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">350</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, <span class="number">7</span> * cyChar / <span class="number">4</span>,</span><br><span class="line">hwnd, (HMENU) IDC_BUTTON1,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">hwndEdit = CreateWindow (TEXT(<span class="string">"edit"</span>),<span class="literal">NULL</span>,</span><br><span class="line">WS_CHILD | WS_VISIBLE |</span><br><span class="line">WS_BORDER|ES_LEFT | ES_MULTILINE |</span><br><span class="line">ES_AUTOVSCROLL,</span><br><span class="line">cxChar+<span class="number">200</span> , cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">40</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, (<span class="number">7</span> * cyChar / <span class="number">4</span>)*<span class="number">2</span>,</span><br><span class="line">hwnd, (HMENU)IDC_EDIT1,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">hwndEdit = CreateWindow (TEXT(<span class="string">"edit"</span>),<span class="literal">NULL</span>,</span><br><span class="line">WS_CHILD | WS_VISIBLE |</span><br><span class="line">WS_BORDER|ES_LEFT | ES_MULTILINE |</span><br><span class="line">ES_AUTOVSCROLL,</span><br><span class="line">cxChar+<span class="number">200</span> , cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">140</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, (<span class="number">7</span> * cyChar / <span class="number">4</span>)*<span class="number">2</span>,</span><br><span class="line">hwnd, (HMENU)IDC_EDIT2,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">hwndEdit = CreateWindow (TEXT(<span class="string">"edit"</span>),<span class="literal">NULL</span>,</span><br><span class="line">WS_CHILD | WS_VISIBLE |</span><br><span class="line">WS_BORDER|ES_LEFT | ES_MULTILINE |</span><br><span class="line">ES_AUTOVSCROLL,</span><br><span class="line">cxChar+<span class="number">200</span> , cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">240</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, (<span class="number">7</span> * cyChar / <span class="number">4</span>)*<span class="number">2</span>,</span><br><span class="line">hwnd, (HMENU)IDC_EDIT3,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">hwndEdit = CreateWindow (TEXT(<span class="string">"edit"</span>),<span class="literal">NULL</span>,</span><br><span class="line">WS_CHILD | WS_VISIBLE |</span><br><span class="line">WS_BORDER|ES_LEFT | ES_MULTILINE |</span><br><span class="line">ES_AUTOVSCROLL,</span><br><span class="line">cxChar+<span class="number">700</span> , cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">40</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, (<span class="number">7</span> * cyChar / <span class="number">4</span>)*<span class="number">2</span>,</span><br><span class="line">hwnd, (HMENU)IDC_EDIT4,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">hwndEdit = CreateWindow (TEXT(<span class="string">"edit"</span>),<span class="literal">NULL</span>,</span><br><span class="line">WS_CHILD | WS_VISIBLE |</span><br><span class="line">WS_BORDER|ES_LEFT | ES_MULTILINE |</span><br><span class="line">ES_AUTOVSCROLL,</span><br><span class="line">cxChar+<span class="number">700</span> , cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">140</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, (<span class="number">7</span> * cyChar / <span class="number">4</span>)*<span class="number">2</span>,</span><br><span class="line">hwnd, (HMENU)IDC_EDIT5,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line">hwndEdit = CreateWindow (TEXT(<span class="string">"edit"</span>),<span class="literal">NULL</span>,</span><br><span class="line">WS_CHILD | WS_VISIBLE |</span><br><span class="line">WS_BORDER|ES_LEFT | ES_MULTILINE |</span><br><span class="line">ES_AUTOVSCROLL,</span><br><span class="line">cxChar+<span class="number">700</span> , cyChar * (<span class="number">1</span> + <span class="number">2</span> * <span class="number">1</span>)+<span class="number">240</span>,</span><br><span class="line"><span class="number">20</span> * cxChar, (<span class="number">7</span> * cyChar / <span class="number">4</span>)*<span class="number">2</span>,</span><br><span class="line">hwnd, (HMENU)IDC_EDIT6,</span><br><span class="line">((LPCREATESTRUCT) lParam)-&amp;gt;hInstance, <span class="literal">NULL</span>) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> WM_PAINT:</span><br><span class="line"><span class="comment">//GetClientRect(hwnd, &amp;amp;rect);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DrawText(hdc, TEXT("我是万能的牵红线的死老头，我是万能的乱射箭的丘比特"), -1, &amp;amp;rect,</span></span><br><span class="line"><span class="comment">// DT_SINGLELINE | DT_CENTER | DT_VCENTER);</span></span><br><span class="line">LOGFONT a;</span><br><span class="line">a<span class="variable">.lfHeight</span>=<span class="number">25</span>;</span><br><span class="line">a<span class="variable">.lfWidth</span>=<span class="number">10</span>;</span><br><span class="line">a<span class="variable">.lfEscapement</span>=<span class="number">0</span>;</span><br><span class="line">a<span class="variable">.lfWeight</span>=<span class="number">700</span>;</span><br><span class="line">a<span class="variable">.lfItalic</span>=<span class="literal">FALSE</span>;</span><br><span class="line">a<span class="variable">.lfUnderline</span>=<span class="literal">FALSE</span>;</span><br><span class="line">a<span class="variable">.lfStrikeOut</span>=<span class="literal">FALSE</span>;</span><br><span class="line">a<span class="variable">.lfCharSet</span> =GB2312_CHARSET;</span><br><span class="line"></span><br><span class="line">hdc = BeginPaint (hwnd, &amp;amp;ps);</span><br><span class="line">GetClientRect (hwnd, &amp;amp;rect);</span><br><span class="line">SelectObject(hdc,CreateFontIndirect(&amp;amp;a));</span><br><span class="line">SetTextColor(hdc,(<span class="number">100</span>,<span class="number">200</span>,<span class="number">50</span>));</span><br><span class="line">TextOut(hdc, <span class="number">100</span>, <span class="number">30</span>, L<span class="string">"征婚启事"</span>, wcslen(L<span class="string">"征婚启事"</span>));</span><br><span class="line">TextOut(hdc, <span class="number">100</span>, <span class="number">100</span>, L<span class="string">"姓名"</span>, wcslen(L<span class="string">"姓名"</span>));</span><br><span class="line">TextOut(hdc, <span class="number">100</span>, <span class="number">200</span>, L<span class="string">"年龄"</span>, wcslen(L<span class="string">"年龄"</span>));</span><br><span class="line">TextOut(hdc, <span class="number">100</span>, <span class="number">300</span>, L<span class="string">"信息"</span>, wcslen(L<span class="string">"信息"</span>) );</span><br><span class="line"></span><br><span class="line">TextOut(hdc, <span class="number">600</span>, <span class="number">30</span>, L<span class="string">"应婚启事"</span>, wcslen(L<span class="string">"应婚启事"</span>));</span><br><span class="line">TextOut(hdc, <span class="number">600</span>, <span class="number">100</span>, L<span class="string">"姓名"</span>, wcslen(L<span class="string">"姓名"</span>));</span><br><span class="line">TextOut(hdc, <span class="number">600</span>, <span class="number">200</span>, L<span class="string">"年龄"</span>, wcslen(L<span class="string">"年龄"</span>));</span><br><span class="line">TextOut(hdc, <span class="number">600</span>, <span class="number">300</span>, L<span class="string">"信息"</span>, wcslen(L<span class="string">"信息"</span>) );</span><br><span class="line"></span><br><span class="line">TextOut(hdc, <span class="number">800</span>, <span class="number">450</span>, L<span class="string">"MiiBotree制作"</span>, wcslen(L<span class="string">"MiiBotree制作"</span>) );</span><br><span class="line">EndPaint(hwnd, &amp;amp;ps);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> WM_COMMAND:</span><br><span class="line"><span class="keyword">switch</span>(LOWORD(wParam))</span><br><span class="line"><span class="keyword">case</span> IDC_BUTTON1:</span><br><span class="line">&#123;</span><br><span class="line">WSADATA wsaData;</span><br><span class="line">SOCKET ListeningSocket;</span><br><span class="line">SOCKET NewConnection;</span><br><span class="line">SOCKADDR_IN ServerAddr;</span><br><span class="line">SOCKADDR_IN ClientAddr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Port = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">int</span> ClientAddrLen;</span><br><span class="line"><span class="keyword">int</span> iResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> buff1[MAXLINE];</span><br><span class="line"><span class="keyword">char</span> buff2[MAXLINE];</span><br><span class="line"><span class="keyword">char</span> buff3[MAXLINE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> send_bytes;</span><br><span class="line">TCHAR sendline[MAXLINE];</span><br><span class="line"><span class="comment">//初始化Windows Socket 2.2</span></span><br><span class="line">WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;amp;wsaData );</span><br><span class="line"><span class="comment">//创建socket</span></span><br><span class="line">ListeningSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"><span class="comment">//填写服务端地址信息</span></span><br><span class="line"><span class="comment">//端口为10000</span></span><br><span class="line"><span class="comment">//IP地址</span></span><br><span class="line">ServerAddr<span class="variable">.sin_family</span> = AF_INET;</span><br><span class="line">ServerAddr<span class="variable">.sin_port</span> = htons(Port);</span><br><span class="line">ServerAddr<span class="variable">.sin_addr</span><span class="variable">.s_addr</span> = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"><span class="comment">//绑定监听端口</span></span><br><span class="line">iResult = bind(ListeningSocket, (SOCKADDR*) &amp;amp;ServerAddr, <span class="keyword">sizeof</span>(ServerAddr));</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hwnd, TEXT(<span class="string">"bind faild"</span>), TEXT(<span class="string">"wrong"</span>), MB_OK);</span><br><span class="line"><span class="comment">//printf("bind faied: %dn", WSAGetLastError());</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hwnd, TEXT(<span class="string">"bind success"</span>), TEXT(<span class="string">"success"</span>), MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//监听</span></span><br><span class="line">iResult = listen(ListeningSocket, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hwnd, TEXT(<span class="string">"listen faild"</span>), TEXT(<span class="string">"wrong"</span>), MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hwnd, TEXT(<span class="string">"listen success"</span>), TEXT(<span class="string">"success"</span>), MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//接受建立连接</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">NewConnection = accept(ListeningSocket, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (NewConnection == INVALID_SOCKET)</span><br><span class="line">&#123;</span><br><span class="line">MessageBox(hwnd, TEXT(<span class="string">"accept faild"</span>), TEXT(<span class="string">"wrong"</span>), MB_OK);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">memset(buff1, <span class="number">0</span>, MAXLINE);</span><br><span class="line">memset(buff2, <span class="number">0</span>, MAXLINE);</span><br><span class="line">memset(buff3, <span class="number">0</span>, MAXLINE);</span><br><span class="line"></span><br><span class="line">n = recv(NewConnection, buff1, MAXLINE, <span class="number">0</span>);</span><br><span class="line">n = recv(NewConnection, buff2, MAXLINE, <span class="number">0</span>);</span><br><span class="line">n = recv(NewConnection, buff3, MAXLINE, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (n == -<span class="number">1</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">SetDlgItemText(hwnd, IDC_EDIT1, (LPCWSTR)buff1);</span><br><span class="line">SetDlgItemText(hwnd, IDC_EDIT2, (LPCWSTR)buff2);</span><br><span class="line">SetDlgItemText(hwnd, IDC_EDIT3, (LPCWSTR)buff3);</span><br><span class="line"><span class="comment">//closesocket(NewConnection);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">memset(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line">GetDlgItemText(hwnd, IDC_EDIT4, sendline, <span class="keyword">sizeof</span>(sendline));</span><br><span class="line">send_bytes = send(NewConnection, (<span class="keyword">const</span> <span class="keyword">char</span>*)sendline, <span class="keyword">sizeof</span>(sendline)/<span class="keyword">sizeof</span>(TCHAR), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">memset(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line">GetDlgItemText(hwnd, IDC_EDIT5, sendline, <span class="keyword">sizeof</span>(sendline));</span><br><span class="line">send_bytes = send(NewConnection, (<span class="keyword">const</span> <span class="keyword">char</span>*)sendline, <span class="keyword">sizeof</span>(sendline)/<span class="keyword">sizeof</span>(TCHAR), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">memset(sendline, <span class="number">0</span>, MAXLINE);</span><br><span class="line">GetDlgItemText(hwnd, IDC_EDIT6, sendline, <span class="keyword">sizeof</span>(sendline));</span><br><span class="line">send_bytes = send(NewConnection, (<span class="keyword">const</span> <span class="keyword">char</span>*)sendline, <span class="keyword">sizeof</span>(sendline)/<span class="keyword">sizeof</span>(TCHAR), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭监听Socket</span></span><br><span class="line">closesocket(NewConnection);</span><br><span class="line">closesocket(ListeningSocket);</span><br><span class="line"><span class="comment">//释放windows socket DLL的相关资源</span></span><br><span class="line">WSACleanup();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">PostQuitMessage(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> DefWindowProc(hwnd, message, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后发个效果图：</p>
<p><img src="http://my.csdn.net/uploads/201205/01/1335846964_9907.png" alt=""></p>
<p><img src="http://my.csdn.net/uploads/201205/01/1335847037_2610.png" alt=""></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/28/关于socket的阻塞/" itemprop="url">
                关于socket的阻塞
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-28T20:51:09+08:00" content="2012-04-28">
            2012-04-28
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>今天在写socket的时候遇到了一个问题。首先附上我的服务器端代码：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">#include &amp;lt<span class="comment">;stdio.h&amp;gt;</span></span><br><span class="line">#include &amp;lt<span class="comment">;WinSock2.h&amp;gt;</span></span><br><span class="line"></span><br><span class="line">#pragma comment <span class="list">(<span class="keyword">lib</span>, <span class="keyword">&amp;quot</span><span class="comment">;ws2_32.lib&amp;quot;)</span></span><br><span class="line"></span><br><span class="line">#define MAXLINE <span class="number">4096</span></span><br><span class="line">int main<span class="list">()</span></span><br><span class="line">&#123;</span><br><span class="line">WSADATA wsaData<span class="comment">;</span></span><br><span class="line">SOCKET ListeningSocket<span class="comment">;</span></span><br><span class="line">SOCKET NewConnection<span class="comment">;</span></span><br><span class="line">SOCKADDR_IN ServerAddr<span class="comment">;</span></span><br><span class="line">SOCKADDR_IN ClientAddr<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">int Port = <span class="number">10000</span><span class="comment">;</span></span><br><span class="line">int ClientAddrLen<span class="comment">;</span></span><br><span class="line">int iResult<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">int n<span class="comment">;</span></span><br><span class="line">char buff[MAXLINE]<span class="comment">;</span></span><br><span class="line">//初始化Windows Socket <span class="number">2.2</span></span><br><span class="line">WSAStartup<span class="list">(<span class="keyword">MAKEWORD</span><span class="list">(<span class="number">2</span>, <span class="number">2</span>)</span>, <span class="keyword">&amp;amp</span><span class="comment">;amp;wsaData );</span></span><br><span class="line">//创建socket</span><br><span class="line">ListeningSocket = socket<span class="list">(<span class="keyword">AF_INET</span>, SOCK_STREAM, IPPROTO_TCP)</span><span class="comment">;</span></span><br><span class="line">//填写服务端地址信息</span><br><span class="line">//端口为<span class="number">10000</span></span><br><span class="line">//IP地址</span><br><span class="line">ServerAddr.sin_family = AF_INET<span class="comment">;</span></span><br><span class="line">ServerAddr.sin_port = htons<span class="list">(<span class="keyword">Port</span>)</span><span class="comment">;</span></span><br><span class="line">ServerAddr.sin_addr.s_addr = inet_addr<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;127.0.0.1&amp;quot;);</span></span><br><span class="line">//绑定监听端口</span><br><span class="line">iResult = bind<span class="list">(<span class="keyword">ListeningSocket</span>, <span class="list">(<span class="keyword">SOCKADDR*</span>)</span> <span class="keyword">&amp;amp</span><span class="comment">;amp;ServerAddr, sizeof(ServerAddr));</span></span><br><span class="line">if <span class="list">(<span class="keyword">iResult</span> == SOCKET_ERROR)</span></span><br><span class="line">&#123;</span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;bind faied: %dn&amp;quot;, WSAGetLastError());</span></span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;bind succeed!n&amp;quot;);</span></span><br><span class="line">&#125;</span><br><span class="line">//监听</span><br><span class="line">iResult = listen<span class="list">(<span class="keyword">ListeningSocket</span>, <span class="number">10</span>)</span><span class="comment">;</span></span><br><span class="line">if <span class="list">(<span class="keyword">iResult</span> == SOCKET_ERROR)</span></span><br><span class="line">&#123;</span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;listen failed %dn&amp;quot;, WSAGetLastError());</span></span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;listen succeed!n&amp;quot;);</span></span><br><span class="line">&#125;</span><br><span class="line">//接受建立连接</span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;wait for linking........n&amp;quot;);</span></span><br><span class="line">while <span class="list">(<span class="number">1</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">//NewConnection = accept<span class="list">(<span class="keyword">ListeningSocket</span>, <span class="list">(<span class="keyword">SOCKADDR*</span>)</span><span class="keyword">&amp;amp</span><span class="comment">;amp;ClientAddr, &amp;amp;amp;ClientAddrLen);</span></span><br><span class="line">NewConnection = accept<span class="list">(<span class="keyword">ListeningSocket</span>, NULL, NULL)</span><span class="comment">;</span></span><br><span class="line">memset<span class="list">(<span class="keyword">buff</span>, <span class="number">0</span>, MAXLINE)</span><span class="comment">;</span></span><br><span class="line">if <span class="list">(<span class="keyword">NewConnection</span> == INVALID_SOCKET)</span></span><br><span class="line">&#123;</span><br><span class="line">//printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;accept socket error!n&amp;quot;);</span></span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;accept failed %dn&amp;quot;, WSAGetLastError());</span></span><br><span class="line">continue<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">//while<span class="list">(<span class="number">1</span>)</span> <span class="keyword">&amp;nbsp</span><span class="comment">; 一开始的时候这里没有加上while这个循环</span></span><br><span class="line">//&#123;</span><br><span class="line">n = recv<span class="list">(<span class="keyword">NewConnection</span>, buff, MAXLINE, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">buff[n] = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">printf<span class="list">(<span class="keyword">&amp;quot</span><span class="comment">;从客户端来的消息:%sn&amp;quot;, buff);</span></span><br><span class="line">//closesocket<span class="list">(<span class="keyword">NewConnection</span>)</span><span class="comment">;</span></span><br><span class="line">//continue<span class="comment">;</span></span><br><span class="line">//&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">//关闭监听Socket</span><br><span class="line">closesocket<span class="list">(<span class="keyword">NewConnection</span>)</span><span class="comment">;</span></span><br><span class="line">closesocket<span class="list">(<span class="keyword">ListeningSocket</span>)</span><span class="comment">;</span></span><br><span class="line">//释放windows socket DLL的相关资源</span><br><span class="line">WSACleanup<span class="list">()</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">return <span class="number">0</span><span class="comment">;</span></span><br><span class="line">&#125;</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br></pre></td></tr></table></figure>
<p>情况是这样的，首先打开我的服务器端，然后再打开我的客户端。</p>
<p>在一个客户端应用程序中，客户端只能发送一条消息，以后再发送消息，就无法在服务器端接收到消息。</p>
<p>但是如果重新打开客户端程序，那么又可以发送一次消息。</p>
<p>为了解决这里的疑惑，再仔细看看这里的代码：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">while <span class="params">(<span class="number">1</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//NewConnection = accept(ListeningSocket, (SOCKADDR*)&amp;amp;ClientAddr, &amp;amp;ClientAddrLen);</span></span><br><span class="line">NewConnection = accept<span class="params">(ListeningSocket, NULL, NULL)</span>;</span><br><span class="line">memset<span class="params">(buff, <span class="number">0</span>, MAXLINE)</span>;</span><br><span class="line"><span class="keyword">if</span> <span class="params">(NewConnection == INVALID_SOCKET)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//printf("accept socket error!n");</span></span><br><span class="line">printf<span class="params">(<span class="string">"accept failed %dn"</span>, WSAGetLastError<span class="params">()</span>)</span>;</span><br><span class="line">continue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//while(1) 一开始的时候这里没有加上while这个循环，加上这个while后就可以一直接收从同一个connect的消息了</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line">n = recv<span class="params">(NewConnection, buff, MAXLINE, <span class="number">0</span>)</span>;</span><br><span class="line">buff[n] = <span class="number">0</span>;</span><br><span class="line">printf<span class="params">(<span class="string">"从客户端来的消息:%sn"</span>, buff)</span>;</span><br><span class="line"><span class="comment">//closesocket(NewConnection);</span></span><br><span class="line"><span class="comment">//continue;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一开始的while循环里面，通过accept接收客户端的connect连接。这个时候没有返回错误码，说明已经连通了，那么这个时候下面就开始发送和接收数据了。</p>
<p>第一次能接收到数据，说明这里的代码确实运行了，那么为什么第二次就不能显示数据了呢？</p>
<p>其实当第一次收到客户端的数据以后，又回到了accept 由于我们这里的TCP是阻塞模式，所以服务器一直在等待其他从客户端发送过来的connect连接。</p>
<p>所以想让同一个客户端的连接一直进行下去，那么我们就应该再加一个while（1）循环。这样就可以无限循环操纵了。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/25/分析QQ-exe资源目录结构/" itemprop="url">
                分析QQ.exe资源目录结构
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-25T15:54:59+08:00" content="2012-04-25">
            2012-04-25
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>看完视频想自己动手实践一下看看QQ.exe的PE格式</p>
<p>2012版的qq中protect版本和本来的版本是有大的不一样的。这里从两个exe文件大小的不同就可以看出来了。这里就先分析一下普通的qq.exe文件好了。</p>
<p>首先用Resource Hacker工具查看一下资源文件，发现在图标这一栏里面有8只大小不一样的企鹅。。。。。。</p>
<p>我这里第4只好像特别大。。。。这里就先分析下第1只企鹅的图标资源吧。。。。</p>
<p>关于资源表这里就不特别讲解了，大家可以参考一下小甲鱼的课件，讲的很清楚的哦。</p>
<p><a href="http://www.fishc.com/a/shipin/jiemixilie/_PExilie_/1051.html" target="_blank" rel="external">http://www.fishc.com/a/shipin/jiemixilie/_PExilie_/1051.html</a></p>
<p>这里就把课件里面的一张最重要的图片贴出来吧：</p>
<p><img src="http://my.csdn.net/uploads/201204/25/1335339414_2497.gif" alt=""></p>
<p>然后自己就跟着这张图片还有小甲鱼的讲解自己也演练了一遍：</p>
<p>&nbsp;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#9;&#9;qq.exe resource analyse&#10;&#9;&#9;by Miibotree&#10;*/&#10;//&#22359;&#23545;&#40784;&#21644;&#25991;&#20214;&#23545;&#40784;&#37117;&#26159;1000H  &#25152;&#20197;&#36825;&#37324;&#30340;RVA&#21644;offset&#26159;&#19968;&#26679;&#30340;&#65292;&#26041;&#20415;&#20102;&#35745;&#31639;&#10;//&#36164;&#28304;&#34920;&#30340;RVA&#26159;1A000  &#22823;&#23567;&#26159;10790&#10;//&#31532;&#22235;&#20010;&#21306;&#22359;.rsrc&#30340;&#36215;&#22987;&#22320;&#22336;&#26159;1A000 &#22823;&#23567;&#26159;10790 &#35828;&#26126;&#36825;&#20010;&#21306;&#22359;&#37324;&#38754;&#23384;&#30340;&#20840;&#37096;&#37117;&#26159;&#36164;&#28304;&#10;//&#28982;&#21518;&#29992;WinHex&#25171;&#24320;qq.exe&#27491;&#24335;&#26469;&#20998;&#26512;&#19968;&#19979;&#10;&#10;//&#31532;&#19968;&#23618;&#30446;&#24405; &#36164;&#28304;&#31867;&#22411;&#10;typedef struct _IMAGE_RESOURCE_DIRECTORY &#123;&#10;    DWORD   Characteristics;   &#9;&#9;00 00 00 00H&#10;    DWORD   TimeDateStamp; &#9;&#9;&#9;00 00 00 00H&#10;    WORD    MajorVersion;      &#9;&#9;00 04H&#10;    WORD    MinorVersion;      &#9;&#9;00 00H&#10;    WORD    NumberOfNamedEntries; &#9;00 00H&#10;    WORD    NumberOfIdEntries;      00 04H//&#36825;&#37324;&#35828;&#26126;&#26377;4&#31181;&#36164;&#28304;&#31867;&#22411;&#10;//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];&#10;&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;&#10;&#10;typedef struct _IMAGE_RESOURCE_DIRECTORY_ENTRY &#123;&#10;    union &#123;&#10;        struct &#123;&#10;            DWORD NameOffset:31;&#10;            DWORD NameIsString:1;&#10;        &#125;;&#10;        DWORD   Name;&#10;        WORD    Id;&#10;    &#125;;&#10;    union &#123;&#10;        DWORD   OffsetToData;&#10;        struct &#123;&#10;            DWORD   OffsetToDirectory:31;&#10;            DWORD   DataIsDirectory:1;&#10;        &#125;;&#10;    &#125;;&#10;&#125; IMAGE_RESOURCE_DIRECTORY_ENTRY, *PIMAGE_RESOURCE_DIRECTORY_ENTRY;&#10;//&#9;&#9;&#9;name           OffsetToData&#10;//&#19968;&#12290;1 &#9;0000 0003H&#9;    8000 0030H &#22270;&#26631;  8&#65288;&#21313;&#20845;&#36827;&#21046;&#65289; = 1000&#65288;&#20108;&#36827;&#21046;&#65289;&#26368;&#39640;&#20301;&#20026;1&#65292;&#20302;31&#20301;&#20316;&#20026;&#25351;&#38024;&#20351;&#29992;&#10;//&#19968;&#12290;2&#9;    0000 000EH&#9;&#9;8000 0080H &#29256;&#26412;&#20449;&#24687;&#10;//&#19968;&#12290;3&#9;&#9;0000 0010H&#9;&#9;8000 0098H qq&#33258;&#23450;&#20041;&#30340;&#10;//&#19968;&#12290;4&#9;&#9;0000 0018H&#9;&#9;8000 00B0H &#24212;&#35813;&#20063;&#26159;qq&#33258;&#23450;&#20041;&#30340;&#10;//&#19968;&#12290;5 &#9;0000 0000H&#9;&#9;0000 0000H &#26368;&#21518;&#19968;&#20010;&#20840;&#37096;&#37117;&#26159;0&#34920;&#31034;&#32467;&#26463;&#20102;&#21543;&#10;//&#31532;&#19968;&#23618;&#32467;&#26463;&#65292;&#25105;&#20204;&#39318;&#20808;&#36861;&#36394;&#19968;&#19979;qq&#22270;&#26631;&#21543;&#65292;&#25152;&#20197;&#20808;&#39134;&#21040;&#31532;&#20108;&#23618;&#21435;&#20102;&#65292;&#21704;&#21704;&#10;&#10;//&#31532;&#20108;&#23618;&#30446;&#24405;  &#36164;&#28304;ID&#10;//&#19968;.1.&#20108;&#10;typedef struct _IMAGE_RESOURCE_DIRECTORY &#123;&#10;    DWORD   Characteristics;   &#9;&#9;00 00 00 00H&#10;    DWORD   TimeDateStamp; &#9;&#9;&#9;00 00 00 00H&#10;    WORD    MajorVersion;      &#9;&#9;00 04H&#10;    WORD    MinorVersion;      &#9;&#9;00 00H&#10;    WORD    NumberOfNamedEntries; &#9;00 00H&#10;    WORD    NumberOfIdEntries;      00 08H//&#36825;&#37324;&#35828;&#26126;&#26377;8&#20010;&#22270;&#26631;&#10;//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];&#10;&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;&#10;&#10;//&#19968;&#12290;1.&#20108;&#12290;1-8&#10;//&#9;&#9;&#9;name           OffsetToData&#10;//&#9;&#9;&#9;0000 0001H&#9;&#9;8000 00C8H&#10;//&#9;&#9;&#9;0000 0002H&#9;&#9;8000 00E0H&#10;//&#9;&#9;&#9;0000 0003H&#9;&#9;8000 00F8H&#10;//&#9;&#9;&#9;0000 0004H&#9;&#9;8000 0110H&#10;//&#9;&#9;&#9;0000 0005H&#9;&#9;8000 0128H&#10;//&#9;&#9;&#9;0000 0006H&#9;&#9;8000 0140H&#10;//&#9;&#9;&#9;0000 0007H&#9;&#9;8000 0158H&#10;//&#9;&#9;&#9;0000 0008H&#9;&#9;8000 0170H&#10;//&#9;&#9;&#9;0000 0000H&#9;&#9;0000 0000H&#10;//&#31532;&#20108;&#23618;&#32467;&#26463;&#65292;&#39134;&#21040;&#31532;&#19977;&#23618;&#21435;&#21543;&#65292;&#21621;&#21621;&#21621;&#21621;&#10;&#10;//&#31532;&#19977;&#23618;&#30446;&#24405;  &#36164;&#28304;&#20195;&#30721;&#39029;&#10;//&#19968;&#12290;1.&#20108;&#12290;1&#12290;&#19977;&#10;typedef struct _IMAGE_RESOURCE_DIRECTORY &#123;&#10;    DWORD   Characteristics;   &#9;&#9;00 00 00 00H&#10;    DWORD   TimeDateStamp; &#9;&#9;&#9;00 00 00 00H&#10;    WORD    MajorVersion;      &#9;&#9;00 04H&#10;    WORD    MinorVersion;      &#9;&#9;00 00H&#10;    WORD    NumberOfNamedEntries; &#9;00 00H&#10;    WORD    NumberOfIdEntries;      00 01H//&#36825;&#37324;&#35828;&#26126;&#21482;&#26377;&#19968;&#20010;&#36164;&#28304;&#20195;&#30721;&#39029;&#10;//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];&#10;&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;&#10;&#10;//&#19968;&#12290;1.&#20108;&#12290;1&#12290;&#19977;&#12290;1&#10;//&#9;&#9;&#9;name           OffsetToData&#10;//&#9;&#9;&#9;0000 0409H&#9;   0000 01D0H&#10;//&#9;&#9;&#9;0000 0000H&#9;   0000 0000H&#10;//&#31532;&#19977;&#23618;&#32467;&#26463;&#65292;&#31163;&#25105;&#20204;&#30340;&#26368;&#32456;&#32988;&#21033;&#36234;&#26469;&#36234;&#36817;&#20102;&#65292;&#21152;&#27833;&#21834;&#21834;&#21834;&#21834;&#21834;&#10;&#10;//&#33410;&#28857; &#36164;&#28304;&#25968;&#25454;&#25351;&#38024;&#10;//&#19968;&#12290;1.&#20108;&#12290;1&#12290;&#19977;&#12290;1&#12290;&#22235;&#10;IMAGE_RESOURCE_DATA_ENTRY STRUCT&#10;&#10;    OffsetToData     DWORD     ?    ; &#36164;&#28304;&#25968;&#25454;&#30340;RVA  &#9;00 01 A2 80H&#10;    Size             DWORD     ?    ; &#36164;&#28304;&#25968;&#25454;&#30340;&#38271;&#24230; &#9;00 00 01 28H &#10;    CodePage         DWORD     ?    ; &#20195;&#30721;&#39029;, &#19968;&#33324;&#20026;0&#9;00 00 04 E0H&#10;    Reserved         DWORD     ?    ; &#20445;&#30041;&#23383;&#27573;&#9;&#9;&#9;00 00 00 00H&#10;&#10;IMAGE_RESOURCE_DATA_ENTRY ENDS&#10;//&#33410;&#28857; &#36164;&#28304;&#25968;&#25454;&#25351;&#38024;&#32467;&#26463;&#65292;&#29616;&#22312;&#32456;&#20110;&#21487;&#20197;&#36827;&#20837;&#25105;&#20204;&#30340;&#26368;&#32456;&#23567;&#20225;&#40517;&#22270;&#26631;&#30340;&#24208;&#23665;&#30495;&#38754;&#30446;&#20102;&#12290;&#12290;&#12290;&#10;&#10;//&#22270;&#26631;&#36164;&#28304;&#10;//1A280 - 1A3A8</span><br></pre></td></tr></table></figure>
<p>最后得到了图标资源的位置。用eXeScope打开看一下，发现是一样的。呵呵，简单就分析到这里了。</p>
<p>&nbsp;</p>
<p><img src="http://static.blog.csdn.net/xheditor/xheditor_emot/default/laugh.gif" alt="大笑"><img src="http://static.blog.csdn.net/xheditor/xheditor_emot/default/laugh.gif" alt="大笑"></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/24/手动PE编辑-写出MessageBox/" itemprop="url">
                手动PE编辑 写出MessageBox
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-24T16:45:20+08:00" content="2012-04-24">
            2012-04-24
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>自己第一遍想手动写PE格式的时候，以为一个字段都不能错，小心翼翼的开始写。这得写到猴年马月去了呀。每次字段都仔细地琢磨一下，研究一下，结果到头来程序还是不能运行。</p>
<p>&nbsp;</p>
<p>第二遍写的时候，参考了网上的“手工打造微型win32可执行文件”这篇文章。</p>
<p><a href="http://www.xfocus.net/articles/200302/482.html" target="_blank" rel="external">http://www.xfocus.net/articles/200302/482.html</a></p>
<p>文章写的很早了，自己看了这篇文章以后觉得收获非常的大。</p>
<p>在下面分析的过程中不懂的可以参考下小甲鱼的课件</p>
<p><a href="http://www.fishc.com/a/shipin/jiemixilie/_PExilie_/1033.html" target="_blank" rel="external">http://www.fishc.com/a/shipin/jiemixilie/_PExilie_/1033.html</a></p>
<p>&nbsp;</p>
<p>自己首先将他的PE文件分析了一遍，在这次分析的过程中明白了很多东西：很多PE结构的字段都是鸡肋，  而有些字段十分重要，绝对不能出差错。</p>
<p><span style="font-size: x-small;">那么哪些字段不能出差错呢？其实不外乎就是涉及到地址的，涉及到offset的，RVA的，这些都是一点都不能出差错的。</span></p>
<p>如果自己手工编写PE文件的话，自己应该先在草稿纸上画下草图，先设定好对齐方式，然后算好每个区块的大小以及它的RVA，把全部数据都算好后在填充数据结构字段的时候就可以减小差错了。</p>
<p>&nbsp;</p>
<p>首先还是来分析一下手工打造微型win32可执行文件里面的第1个例子</p>
<figure class="highlight"><figcaption><span>0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;00000000   4D 5A D5 E2 C0 EF BB F9  B1 BE B6 BC C3 BB D3 D0   MZ&#36825;&#37324;&#22522;&#26412;&#37117;&#27809;&#26377;&#10;00000010   D3 C3 2C 44 4F 53 B1 A3  C1 F4 B5 C4 CD B7 B2 BF   &#29992;,DOS&#20445;&#30041;&#30340;&#22836;&#37096;&#10;00000020   D0 C5 CF A2 2C CE D2 C3  C7 B6 BC B2 BB D3 C3 2E   &#20449;&#24687;,&#25105;&#20204;&#37117;&#19981;&#29992;.&#10;00000030   D2 BB D6 B1 B5 BD D5 E2  C0 EF C0 B2 40 00 00 00   &#19968;&#30452;&#21040;&#36825;&#37324;&#21862;@...&#10;00000040   50 45 00 00 4C 01 02 00  00 00 00 00 00 00 00 00   PE..L...........&#10;00000050   00 00 00 00 E0 00 0F 01  0B 01 00 00 00 02 00 00   ....?..........&#10;00000060   00 00 00 00 00 00 00 00  00 10 00 00 00 00 00 00   ................&#10;00000070   00 00 00 00 00 00 40 00  00 10 00 00 00 02 00 00   ......@.........&#10;00000080   00 00 00 00 00 00 00 00  04 00 00 00 00 00 00 00   ................&#10;00000090   00 30 00 00 00 02 00 00  00 00 00 00 02 00 00 00   .0..............&#10;000000A0   00 01 00 00 00 00 00 00  00 01 00 00 00 10 00 00   ................&#10;000000B0   00 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00   ................&#10;000000C0   10 11 00 00 3C 00 00 00  00 00 00 00 00 00 00 00   ....&#38;lt;...........&#10;000000D0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;000000E0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;000000F0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;00000100   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;00000110   00 00 00 00 00 00 00 00  00 11 00 00 10 00 00 00   ................&#10;00000120   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;00000130   00 00 00 00 00 00 00 00  43 6C 6F 75 64 00 00 00   ........Cloud...&#10;00000140   00 02 00 00 00 10 00 00  00 02 00 00 00 02 00 00   ................&#10;00000150   00 00 00 00 00 00 00 00  00 00 00 00 60 00 00 60   ............`..`&#10;00000160   4E 53 46 4F 43 55 53 00  00 02 00 00 00 20 00 00   NSFOCUS...... ..&#10;00000170   00 02 00 00 00 02 00 00  00 00 00 00 00 00 00 00   ................&#10;00000180   00 00 00 00 60 00 00 60  D5 E2 C0 EF BF AA CA BC   ....`..`&#36825;&#37324;&#24320;&#22987;&#10;00000190   CA C7 B6 D4 C6 EB CC EE  B3 E4 D0 C5 CF A2 A3 AC   &#26159;&#23545;&#40784;&#22635;&#20805;&#20449;&#24687;&#65292;&#10;000001A0   C3 BB D3 D0 D3 C3 2E 20  D2 BB D6 B1 B5 BD 30 78   &#27809;&#26377;&#29992;. &#19968;&#30452;&#21040;0x&#10;000001B0   32 30 30 68 BF AA CA BC  CE AA 2E 74 65 78 74 28   200h&#24320;&#22987;&#20026;.text(&#10;000001C0   D2 B2 BE CD CA C7 43 6C  6F 75 64 29 B6 CE BF AA   &#20063;&#23601;&#26159;Cloud)&#27573;&#24320;&#10;000001D0   CA BC 2C CE D2 C3 C7 B0  D1 20 49 6D 70 6F 72 74   &#22987;,&#25105;&#20204;&#25226; Import&#10;000001E0   B1 ED D2 B2 B7 C5 B5 BD  D5 E2 B8 F6 B6 CE C0 EF   &#34920;&#20063;&#25918;&#21040;&#36825;&#20010;&#27573;&#37324;&#10;000001F0   C0 B4 C1 CB 2F 2F BA C7  BA C7 20 3A 29 20 20 20   &#26469;&#20102;//&#21621;&#21621; :)  &#10;00000200   33 DB 74 13 58 53 50 83  C0 07 50 53 68 2A 10 40   3&#36397;.XSP&#20829;.PSh*.@&#10;00000210   00 68 30 10 40 00 C3 E8  E8 FF FF FF 45 78 65 44   .h0.@.&#25551;?&#65533;&#65533;ExeD&#10;00000220   49 59 00 48 65 6C 6C 6F  21 00 FF 25 00 11 40 00   IY.Hello!.&#65533;%..@.&#10;00000230   FF 25 08 11 40 00 00 00  00 00 00 00 00 00 00 00   &#65533;%..@...........&#10;00000240   B4 FA C2 EB BE CD D5 E2  C3 B4 D2 BB B5 E3 A3 AC   &#58129;&#21014;&#39548;&#39287;&#21254;&#22351;&#24726;?&#10;00000250   D5 E2 C0 EF D3 D6 CA C7  CC EE B3 E4 A3 AC 49 6D   &#36825;&#37324;&#21448;&#26159;&#22635;&#20805;&#65292;Im&#10;00000260   70 6F 72 74 B1 ED CE D2  C3 C7 D2 B2 B7 C5 B5 BD   port&#34920;&#25105;&#20204;&#20063;&#25918;&#21040;&#10;00000270   D5 E2 B8 F6 B6 CE C0 B4  C1 CB A3 AC CE AA C1 CB   &#36825;&#20010;&#27573;&#26469;&#20102;&#65292;&#20026;&#20102;&#10;00000280   BC C6 CB E3 B5 D8 D6 B7  B7 BD B1 E3 CE D2 C3 C7   &#35745;&#31639;&#22320;&#22336;&#26041;&#20415;&#25105;&#20204;&#10;00000290   B0 D1 CB FC B7 C5 B5 BD  30 78 33 31 30 68 B4 A6   &#25226;&#23427;&#25918;&#21040;0x310h&#22788;&#10;000002A0   C1 CB C6 E4 B6 D4 D3 A6  C4 DA B4 E6 B5 D8 D6 B7   &#20102;&#20854;&#23545;&#24212;&#20869;&#23384;&#22320;&#22336;&#10;000002B0   CE AA A3 BA 30 78 34 30  31 31 30 30 00 00 00 00   &#20026;&#65306;0x401100....&#10;000002C0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;000002D0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;000002E0   00 00 00 00 00 00 00 00  B5 BD D5 E2 C0 EF BF AA   ........&#21040;&#36825;&#37324;&#24320;&#10;000002F0   CA BC 49 6D 70 6F 72 74  B1 ED D0 C5 CF A2 A3 BA   &#22987;Import&#34920;&#20449;&#24687;&#65306;&#10;00000300   5C 11 00 00 00 00 00 00  78 11 00 00 00 00 00 00   .......x.......&#10;00000310   4C 11 00 00 00 00 00 00  00 00 00 00 6A 11 00 00   L...........j...&#10;00000320   00 11 00 00 54 11 00 00  00 00 00 00 00 00 00 00   ....T...........&#10;00000330   86 11 00 00 08 11 00 00  00 00 00 00 00 00 00 00   ?..............&#10;00000340   00 00 00 00 00 00 00 00  00 00 00 00 5C 11 00 00   ...............&#10;00000350   00 00 00 00 78 11 00 00  00 00 00 00 AB 00 45 78   ....x.......?Ex&#10;00000360   69 74 50 72 6F 63 65 73  73 00 4B 45 52 4E 45 4C   itProcess.KERNEL&#10;00000370   33 32 2E 64 6C 6C 00 00  BB 01 4D 65 73 73 61 67   32.dll..?Messag&#10;00000380   65 42 6F 78 41 00 55 53  45 52 33 32 2E 64 6C 6C   eBoxA.USER32.dll&#10;00000390   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................&#10;000003A0   BA C3 C1 CB A3 AC BD E1  CA F8 A3 AC D5 E2 C0 EF   &#22909;&#20102;&#65292;&#32467;&#26463;&#65292;&#36825;&#37324;&#10;000003B0   CA C7 D7 EE BA F3 D2 BB  B8 F6 B6 D4 C6 EB D3 C3   &#26159;&#26368;&#21518;&#19968;&#20010;&#23545;&#40784;&#29992;&#10;000003C0   B5 C4 CC EE B3 E4 D6 B5  C1 CB A1 A3 20 20 20 20   &#30340;&#22635;&#20805;&#20540;&#20102;&#12290;    &#10;000003D0   77 61 74 65 72 63 6C 6F  75 64 40 6E 73 66 6F 63   watercloud@nsfoc&#10;000003E0   75 73 2E 63 6F 6D 20 20  32 30 30 32 C4 EA 31 32   us.com  2002&#24180;12&#10;000003F0   D4 C2 31 38 C8 D5 20 20  20 CD FB B8 AB D5 FD 21   &#26376;18&#26085;   &#26395;&#26023;&#27491;!</span><br></pre></td></tr></table></figure>
<p><span style="font-size: x-small;"><span style="color: #3366ff;">（一）DOS头</span></span></p>
<p>对于DOS头而言，只有最开始的e_magic字段MZ 和e_lfanew  指向PE文件头开始是有用的，其它全部可以随便填！！！</p>
<p>dos_stub也是鸡肋，我们根本连写都可以不写它！！！</p>
<p><span style="color: #3366ff; font-size: x-small;">（二）NT头</span></p>
<p>然后是NT头，先发个NT头的数据结构上来</p>
<figure class="highlight"><figcaption><span>STRUCT </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#123;&#10;&#10;+0h       DWORDSignature  &#10;&#10;+4h       IMAGE_FILE_HEADER FileHeader &#10;&#10;+18h     IMAGE_OPTIONAL_HEADER32OptionalHeader   &#10;&#10;&#125; IMAGE_NT_HEADERS ENDS&#10;&#10;typedef struct _IMAGE_FILE_HEADER &#10;&#10;&#123;&#10;&#10;+04h WORD   Machine;   // &#36816;&#34892;&#24179;&#21488;&#10;&#10;+06h   WORD   NumberOfSections; // &#25991;&#20214;&#30340;&#21306;&#22359;&#25968;&#30446;  &#36825;&#37324;&#33258;&#24049;&#23581;&#35797;&#20102;&#19968;&#19979;&#65292;&#22909;&#20687;&#19981;&#33021;&#26159;1&#20010;&#65292;&#24517;&#39035;&#26159;&#20004;&#20010;&#20197;&#19978;&#65292;&#21542;&#21017;&#31243;&#24207;&#20250;&#25253;&#38169;&#35823;&#10;&#10;+08h DWORD TimeDateStamp; // &#25991;&#20214;&#21019;&#24314;&#26085;&#26399;&#21644;&#26102;&#38388;  &#10;&#10;+0Ch   DWORD PointerToSymbolTable; // &#25351;&#21521;&#31526;&#21495;&#34920;(&#20027;&#35201;&#29992;&#20110;&#35843;&#35797;)  &#10;&#10;+10h DWORD NumberOfSymbols; // &#31526;&#21495;&#34920;&#20013;&#31526;&#21495;&#20010;&#25968;(&#21516;&#19978;)&#10;&#10;+14h   WORD   SizeOfOptionalHeader; // IMAGE_OPTIONAL_HEADER32 &#32467;&#26500;&#22823;&#23567; 00E0&#10;&#10;+16h   WORD   Characteristics; // &#25991;&#20214;&#23646;&#24615;&#10;&#10;&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;&#10;&#10;typedef struct _IMAGE_OPTIONAL_HEADER &#10;&#10;&#123;&#10;&#10;    //&#10;&#10;    // Standard fields.  &#10;&#10;    //&#10;&#10;+18h    WORD    Magic;                      // &#26631;&#24535;&#23383;, ROM &#26144;&#20687;&#65288;0107h&#65289;,&#26222;&#36890;&#21487;&#25191;&#34892;&#25991;&#20214;&#65288;010Bh&#65289;&#10;&#10;+1Ah    BYTE      MajorLinkerVersion;       // &#38142;&#25509;&#31243;&#24207;&#30340;&#20027;&#29256;&#26412;&#21495;&#10;&#10;+1Bh    BYTE      MinorLinkerVersion;       // &#38142;&#25509;&#31243;&#24207;&#30340;&#27425;&#29256;&#26412;&#21495;&#10;&#10;+1Ch    DWORD   SizeOfCode;                 // &#25152;&#26377;&#21547;&#20195;&#30721;&#30340;&#33410;&#30340;&#24635;&#22823;&#23567;&#10;&#10;+20h    DWORD   SizeOfInitializedData;    // &#25152;&#26377;&#21547;&#24050;&#21021;&#22987;&#21270;&#25968;&#25454;&#30340;&#33410;&#30340;&#24635;&#22823;&#23567;&#10;&#10;+24h    DWORD   SizeOfUninitializedData; // &#25152;&#26377;&#21547;&#26410;&#21021;&#22987;&#21270;&#25968;&#25454;&#30340;&#33410;&#30340;&#22823;&#23567;&#10;&#10;+28h    DWORD   AddressOfEntryPoint;    // &#31243;&#24207;&#25191;&#34892;&#20837;&#21475;RVA&#10;&#10;+2Ch    DWORD   BaseOfCode;                // &#20195;&#30721;&#30340;&#21306;&#22359;&#30340;&#36215;&#22987;RVA&#10;&#10;+30h    DWORD   BaseOfData;                 // &#25968;&#25454;&#30340;&#21306;&#22359;&#30340;&#36215;&#22987;RVA&#10;&#10;    //&#10;&#10;    // NT additional fields.    &#20197;&#19979;&#26159;&#23646;&#20110;NT&#32467;&#26500;&#22686;&#21152;&#30340;&#39046;&#22495;&#12290;&#10;&#10;    //&#10;&#10;+34h    DWORD   ImageBase;                               // &#31243;&#24207;&#30340;&#39318;&#36873;&#35013;&#36733;&#22320;&#22336;&#10;&#10;+38h    DWORD   SectionAlignment;                     // &#20869;&#23384;&#20013;&#30340;&#21306;&#22359;&#30340;&#23545;&#40784;&#22823;&#23567;&#10;&#10;+3Ch    DWORD   FileAlignment;                           // &#25991;&#20214;&#20013;&#30340;&#21306;&#22359;&#30340;&#23545;&#40784;&#22823;&#23567;&#10;&#10;+40h    WORD    MajorOperatingSystemVersion;  // &#35201;&#27714;&#25805;&#20316;&#31995;&#32479;&#26368;&#20302;&#29256;&#26412;&#21495;&#30340;&#20027;&#29256;&#26412;&#21495;&#10;&#10;+42h    WORD    MinorOperatingSystemVersion;  // &#35201;&#27714;&#25805;&#20316;&#31995;&#32479;&#26368;&#20302;&#29256;&#26412;&#21495;&#30340;&#21103;&#29256;&#26412;&#21495;&#10;&#10;+44h    WORD    MajorImageVersion;                    // &#21487;&#36816;&#34892;&#20110;&#25805;&#20316;&#31995;&#32479;&#30340;&#20027;&#29256;&#26412;&#21495;&#10;&#10;+46h    WORD    MinorImageVersion;                    // &#21487;&#36816;&#34892;&#20110;&#25805;&#20316;&#31995;&#32479;&#30340;&#27425;&#29256;&#26412;&#21495;&#10;&#10;+48h    WORD    MajorSubsystemVersion;            // &#35201;&#27714;&#26368;&#20302;&#23376;&#31995;&#32479;&#29256;&#26412;&#30340;&#20027;&#29256;&#26412;&#21495;&#10;&#10;+4Ah    WORD    MinorSubsystemVersion;           // &#35201;&#27714;&#26368;&#20302;&#23376;&#31995;&#32479;&#29256;&#26412;&#30340;&#27425;&#29256;&#26412;&#21495;&#10;&#10;+4Ch    DWORD   Win32VersionValue;                // &#33707;&#39035;&#26377;&#23383;&#27573;&#65292;&#19981;&#34987;&#30149;&#27602;&#21033;&#29992;&#30340;&#35805;&#19968;&#33324;&#20026;0&#10;&#10;+50h    DWORD   SizeOfImage;                            // &#26144;&#20687;&#35013;&#20837;&#20869;&#23384;&#21518;&#30340;&#24635;&#23610;&#23544;    &#36825;&#37324;&#19981;&#33021;&#38543;&#20415;&#25913;&#30340;&#12290;&#10;&#10;+54h    DWORD   SizeOfHeaders;                        // &#25152;&#26377;&#22836; + &#21306;&#22359;&#34920;&#30340;&#23610;&#23544;&#22823;&#23567;&#10;&#10;+58h    DWORD   CheckSum;                              // &#26144;&#20687;&#30340;&#26657;&#26816;&#21644;&#10;&#10;+5Ch    WORD    Subsystem;                               // &#21487;&#25191;&#34892;&#25991;&#20214;&#26399;&#26395;&#30340;&#23376;&#31995;&#32479;   &#33258;&#24049;&#23581;&#35797;&#20102;&#19979;&#65292;&#22909;&#20687;&#21482;&#33021;&#26159;1 &#21644; 2&#10;&#10;+5Eh    WORD    DllCharacteristics;                     // DllMain()&#20989;&#25968;&#20309;&#26102;&#34987;&#35843;&#29992;&#65292;&#40664;&#35748;&#20026; 0&#10;&#10;+60h    DWORD   SizeOfStackReserve;               // &#21021;&#22987;&#21270;&#26102;&#30340;&#26632;&#22823;&#23567;                   100&#10;&#10;+64h    DWORD   SizeOfStackCommit;                 // &#21021;&#22987;&#21270;&#26102;&#23454;&#38469;&#25552;&#20132;&#30340;&#26632;&#22823;&#23567;          0&#10;&#10;+68h    DWORD   SizeOfHeapReserve;                // &#21021;&#22987;&#21270;&#26102;&#20445;&#30041;&#30340;&#22534;&#22823;&#23567;               100&#10;&#10;+6Ch    DWORD   SizeOfHeapCommit;                 // &#21021;&#22987;&#21270;&#26102;&#23454;&#38469;&#25552;&#20132;&#30340;&#22534;&#22823;&#23567;           1000&#10;&#10;+70h    DWORD   LoaderFlags;                            // &#19982;&#35843;&#35797;&#26377;&#20851;&#65292;&#40664;&#35748;&#20026; 0 &#10;&#10;+74h    DWORD   NumberOfRvaAndSizes;           // &#19979;&#36793;&#25968;&#25454;&#30446;&#24405;&#30340;&#39033;&#25968;&#65292;&#36825;&#20010;&#23383;&#27573;&#33258;Windows NT &#21457;&#24067;&#20197;&#26469;&#19968;&#30452;&#26159;16&#10;&#10;+78h    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];   &#10;&#10;// &#25968;&#25454;&#30446;&#24405;&#34920;&#10;&#10;&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure>
<p><span style="color: #3366ff;">其中有个sizeofimage字段一开始一直搞不清楚，自己就参考了下面这篇文章</span><span style="font-family: monospace;"></span></p>
<p></p>
<p><a href="http://hi.baidu.com/triumphyuan/blog/item/b642423ee436413570cf6cf9.html" target="_blank" rel="external">http://hi.baidu.com/triumphyuan/blog/item/b642423ee436413570cf6cf9.html</a></p>
<p>然 后是区块个数，在XP下好像必须是两个或者是两个以上的区块，在win7下自己尝试了一下好像也必须是两个或者两个以上的区块，百度了一下好像也没有具体 的回答，不知道有没有人能够写出1个区块的PE程序来。请大家指教（当然在这个例子中，两个区块指向了同一个地方，这样就减小了PE文件的大小，但是在加 载到内存后，显示两个区块的RVA分别是1000 和 2000，不知道这里的映射是如何进行的，等会再研究研究！！）</p>
<p>&nbsp;</p>
<p>这里的PE头自己就不多介绍了，大家自己尝试着分析一下好了，能熟悉每个字段都是什么意思。呵呵</p>
<p>&nbsp;</p>
<p>然后是数据目录表部分，在这个例子中，只用到了输入表，但是我们知道数据目录表有16项，我们在填写数据目录表个数这个字段的时候，必须是大于等于2</p>
<p>因为输入表在第2项的位置嘛！！但是数据目录表的16项的位置必须保留，你可以全部用0来填充！！</p>
<p><span style="font-size: x-small;"><span style="color: #3333ff;">（三）程序入口的代码段（在第一个区块里面）：</span></span></p>
<p>通过换算得知offset为200的时候是程序入口点，这里执行的是messageboxA  和ExitProcess两个函数</p>
<figure class="highlight"><figcaption><span>33 DB 74 13 58 53 50 83  C0 07 50 53 68 2A 10 40   3踭.XSP兝.PSh*.@</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000210   00 68 30 10 40 00 C3 E8  E8 FF FF FF 45 78 65 44   .h0.@.&#25551;?&#65533;&#65533;ExeD&#10;00000220   49 59 00 48 65 6C 6C 6F  21 00 FF 25 00 11 40 00   IY.Hello!.&#65533;%..@.&#10;00000230   FF 25 08 11 40 00 00 00  00 00 00 00 00 00 00 00   &#65533;%..@...........</span><br></pre></td></tr></table></figure>
<p>这里自己汇编基础不是很好，大家可以看看原文的分析</p>
<p><span style="color: #000099; font-size: x-small;"><strong>（四）输入表的分析</strong></span></p>
<p>最后自己重点分析一下输入表的结构，是从310地方开始的，有两个IID</p>
<p>下面给大家分析一下第一个IID，画了张图片给大家参考一下：</p>
<p><img src="http://my.csdn.net/uploads/201204/21/1334978488_1400.png" alt=""></p>
<p>第二个IID就不画了，不然太乱了。大家自己可以看下。</p>
<p><strong><span style="color: #000099; font-size: x-small;">（五）要不自己来一下？？</span></strong></p>
<p>看看上面这个输入表的IID这么混乱，指来指去什么的最麻烦了，索性自己把它改的整齐一点不是很好吗？？</p>
<p>第一次改的时候不知道哪里出差错了，一直不行，可能是函数地址计算的时候出错了，但是一直找不到错误。</p>
<p>没办法，只好一步一步地来了。</p>
<p>尝试了第二遍，发现好像这里的结构是有顺序的，随便变换顺序的话程序会出错无法运行，网上查了下资料好像也没有解释。</p>
<p>那么这里究竟有什么顺序呢？自己这里先研究下，等研究出来了给大伙汇报一下。呵呵</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/22/关于dword-ptr-指令/" itemprop="url">
                关于dword ptr 指令
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-22T15:12:21+08:00" content="2012-04-22">
            2012-04-22
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>8086CPU的指令，可以处理两种尺寸的数据，byte和word。所以在机器指令中要指明，指令进行的是字操作还是字节操作。对于这个问题，汇编语言中用一下方法处理。</p>
<p>（1）通过寄存器名指明要处理的数据的尺寸。</p>
<p>例如：</p>
<p>下面的指令中，寄存器指明了指令进行的是字操作：</p>
<p>mov ax,1</p>
<p>mov bx,ds:[0]</p>
<p>mov ds,ax</p>
<p>mov ds:[0],ax</p>
<p>inc ax</p>
<p>add ax,1000</p>
<p>下面的指令中，寄存器指明了指令进行的是字节操作：</p>
<p>mov al,1</p>
<p>mov al,bl</p>
<p>mov al,ds:[0]</p>
<p>mov ds:[0],al</p>
<p>inc al</p>
<p>add al,100</p>
<p>(2)在没有寄存器名存在的情况下，用操作符 X ptr 指明内存单元的长度，X在汇编指令中可以为word或byte。</p>
<p>例如：</p>
<p>下面的指令中，用word ptr 指明了指令访问的内存单元是一个字单元：</p>
<p>mov word ptr ds:[0],1</p>
<p>inc word ptr [bx]</p>
<p>inc word ptr ds:[0]</p>
<p>add word ptr [bx],2</p>
<p>下面的指令中，用byte ptr 指明了指令访问的内存单元是一个字单元：</p>
<p>mov byte ptr ds:[0],1</p>
<p>inc byte ptr [bx]</p>
<p>inc byte ptr ds:[0]</p>
<p>add byte ptr [bx],2</p>
<p>在没有寄存器参与的内存单元访问指令中，用word prt 或byte ptr 显性地指明所要访问的内存单元的长度是很必要的。否则，CPU无法得知所要访问的单元，还是字节单元。</p>
<p>假如我们用Debug查看内存的结果如下：</p>
<p>2000:1000 FF FF FF FF FF FF &#8230;&#8230;</p>
<p>那么指令：</p>
<p>mov ax,2000H</p>
<p>mov ds,ax</p>
<p>mov byte ptr [1000H],1</p>
<p>将使内存中的内容变为：</p>
<p>2000: 1000 01 FF FF FF FF FF &#8230;&#8230;</p>
<p>而指令：</p>
<p>mov ax,2000H</p>
<p>mov ds,ax</p>
<p>mov word ptr [1000H],1</p>
<p>将使内存中的内容变为：</p>
<p>2000：1000 01 00 FF FF FF FF &#8230;&#8230;</p>
<p>这是因为 mov byte ptr [1000H],1访问的是地址为 ds:1000H 的字节单元，修改的是ds:1000H 单元的内容；而mov word ptr [1000H],1 访问的是地址为 ds:1000H 的字单元，修改的是 ds:1000H 和 ds:1001H 两个单元的内容。</p>
<p>PTR用来指出操作数的类型或尺寸,通常用在跳转/调子程序或寻址。寻址时用来指明是BYTE、WORD还是DWORD,跳转时则是FAR或NEAR。</p>
<p>（3） 其他方法</p>
<p>有些指令默认了访问的是字单元还是字节单元，比如：push [1000H] 就不用指明访问的是字单元还是字节单元，因为push指令只进行字操作。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/15/PE格式之输入表/" itemprop="url">
                PE格式之输入表
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-15T20:50:43+08:00" content="2012-04-15">
            2012-04-15
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="紧接着上一篇的千里追踪输入表，现在终于可以开始看输入表里面的神奇东东了。。。">紧接着上一篇的千里追踪输入表，现在终于可以开始看输入表里面的神奇东东了。。。</h2><div>还是copy小甲鱼的课件。。。。</div><br><div></div>

<h2 id="输入表结构">输入表结构</h2><p>回顾一下，在 PE文件头的 IMAGE_OPTIONAL_HEADER 结构中的 DataDirectory(数据目录表) 的第二个成员就是指向输入表的。而输入表是以一个 IMAGE_IMPORT_DESCRIPTOR(简称IID) 的数组开始。每个被 PE文件链接进来的 DLL文件都分别对应一个 IID数组结构。在这个 IID数组中，并没有指出有多少个项(就是没有明确指明有多少个链接文件)，但它最后是以一个全为NULL(0) 的 IID 作为结束的标志。</p>
<p>&nbsp;</p>
<p>IMAGE_IMPORT_DESCRIPTOR 结构定义如下：</p>
<p>IMAGE_IMPORT_DESCRIPTOR STRUCT</p>
<p>union</p>
<p>Characteristics              DWORD   ?</p>
<p>OriginalFirstThunk        DWORD   ?</p>
<p>ends</p>
<p>TimeDateStamp                 DWORD   ?</p>
<p>ForwarderChain                 DWORD   ?</p>
<p>Name                                  DWORD   ?</p>
<p>FirstThunk                          DWORD   ?</p>
<p>IMAGE_IMPORT_DESCRIPTOR ENDS</p>
<p>&nbsp;</p>
<h2 id="成员介绍:">成员介绍:</h2><h3 id="OriginalFirstThunk">OriginalFirstThunk</h3><p>它指向first thunk，IMAGE_THUNK_DATA，该 thunk 拥有 Hint 和 Function name 的地址。</p>
<p>&nbsp;</p>
<h3 id="TimeDateStamp">TimeDateStamp</h3><p>该字段可以忽略。如果那里有绑定的话它包含时间/数据戳（time/data stamp）。如果它是0，就没有绑定在被导入的DLL中发生。在最近，它被设置为0xFFFFFFFF以表示绑定发生。</p>
<p>&nbsp;</p>
<h3 id="ForwarderChain">ForwarderChain</h3><p>一般情况下我们也可以忽略该字段。在老版的绑定中，它引用API的第一个forwarder chain（传递器链表）。它可被设置为0xFFFFFFFF以代表没有forwarder。</p>
<p>&nbsp;</p>
<h3 id="Name">Name</h3><p>它表示DLL 名称的相对虚地址（译注：相对一个用null作为结束符的ASCII字符串的一个RVA，该字符串是该导入DLL文件的名称，如：KERNEL32.DLL）。</p>
<p>&nbsp;</p>
<h3 id="FirstThunk">FirstThunk</h3><p>它包含由IMAGE_THUNK_DATA定义的 first thunk数组的虚地址，通过loader用函数虚地址初始化thunk。在Orignal First Thunk缺席下，它指向first thunk：Hints和The Function names的thunks。</p>
<p>这个OriginalFirstThunk 和 FirstThunk明显是亲家，两家伙首先名字就差不多哈。那他们有什么不可告人的秘密呢？来，我们看下面一张图（画的很辛苦，大家仔细看哈）：</p>
<p>&nbsp;</p>
<div><img src="http://www.fishc.com/uploads/allimg/120113/9_120113233038_1.gif" alt="PE教程,PE视频教程,PE原理,PE头教程"></div><br><div></div><br><div><br><div>我们看到：OriginalFirstThunk 和 FirstThunk 他们都是两个类型为IMAGE_THUNK_DATA 的数组，它是一个指针大小的联合（union）类型。每一个IMAGE_THUNK_DATA 结构定义一个导入函数信息（即指向结构为IMAGE_IMPORT_BY_NAME 的家伙，这家伙稍后再议），然后数组最后以一个内容为0 的 IMAGE_THUNK_DATA 结构作为结束标志。</div><br><div></div><br><div>我们得到 IMAGE_THUNK_DATA 结构的定义如下：</div><br><div>IMAGE_THUNK_DATA STRUC</div><br><div>    union u1</div><br><div>    ForwarderString       DWORD  ?        ; 指向一个转向者字符串的RVA</div><br><div>    Function                   DWORD  ?        ; 被输入的函数的内存地址</div><br><div>    Ordinal                     DWORD  ?        ; 被输入的API 的序数值</div><br><div>    AddressOfData        DWORD  ?        ; 指向 IMAGE_IMPORT_BY_NAME</div><br><div>    ends</div><br><div>IMAGE_THUNK_DATA ENDS</div><br><div></div><br><div>我们可以看出由于是union结构，所以IMAGE_THUNK_DATA 事实上是一个双字大小。该结构在不同时候赋予不同的意义（伟大神奇不得鸟……）。其实union这种数据结构很容易理解：说白了就是当时穷，能省就省，再说白了，就是几兄弟姐妹轮流穿一条裤子去相亲！理解了吧？哈哈~</div><br><div></div><br><div>那我们怎么来区分何时是何意义呢？</div><br><div>规定如下：</div><br><div>当 IMAGE_THUNK_DATA 值的最高位为 1时，表示函数以序号方式输入，这时候低 31位被看作一个函数序号。</div><br><div>当 IMAGE_THUNK_DATA 值的最高位为 0时，表示函数以字符串类型的函数名方式输入，这时双字的值是一个 RVA，指向一个 IMAGE_IMPORT_BY_NAME 结构。（演示请看小甲鱼解密系列视频讲座）</div><br><div></div><br><div>好，那接着我们讨论下指向的这个 IMAGE_IMPORT_BY_NAME 结构。IMAGE_IMPORT_BY_NAME 结构仅仅只有一个字型数据的大小，存有一个输入函数的相关信息结构。其结构如下：</div><br><div>IMAGE_IMPORT_BY_NAME STRUCT</div><br><div>    Hint        WORD    ?</div><br><div>    Name      BYTE      ?</div><br><div>IMAGE_IMPORT_BY_NAME ENDS</div><br><div></div><br><div>结构中的 Hint 字段也表示函数的序号，不过这个字段是可选的，有些编译器总是将它设置为 0，Name 字段定义了导入函数的名称字符串，这是一个以 0 为结尾的字符串。</div><br><div>整个过程看起来有点绕有点烦，别急，后边我们有演示哈。</div><br><div></div><br><div></div>

<h2 id="输入地址表（IAT）">输入地址表（IAT）</h2><div></div><br><div>为什么由两个并行的指针数组同时指向 IMAGE_IMPORT_BY_NAME 结构呢？第一个数组（由 OriginalFirstThunk 所指向）是单独的一项，而且不能被改写，我们前边称为 INT。第二个数组（由 FirstThunk 所指向）事实上是由 PE 装载器重写的。</div><br><div></div><br><div>好了，那么 PE 装载器的核心操作时如何的呢？这里就给大家揭秘啦~</div><br><div>PE 装载器首先搜索 OriginalFirstThunk ，找到之后加载程序迭代搜索数组中的每个指针，找到每个 IMAGE_IMPORT_BY_NAME 结构所指向的输入函数的地址，然后加载器用函数真正入口地址来替代由 FirstThunk 数组中的一个入口，因此我们称为输入地址表（IAT）。所以，当我们的 PE 文件装载内存后准备执行时，刚刚的图就会转化为下图：</div><br><div></div><br><div><img src="http://www.fishc.com/uploads/allimg/120113/9_120113233224_1.gif" alt="PE教程,PE视频教程,PE原理,PE头教程"></div><br><div></div><br><div><br><div>此时，输入表中其他部分就不重要了，程序依靠 IAT 提供的函数地址就可正常运行。</div><br><div></div><br><div>自己在写的时候遇到了很多问题：</div><br><div>1.输入表一定在.idata区块里面吗？</div><br><div>答：当然不是了。在VC编译器下面是这样的，但是不同的编译器下面是不一样的。而且区块的名称只是名称而已，没有什么大用处。</div><br><div>2.注意一下IMAGE_THUNK_DATA这个数据结构，可以回上去看看小甲鱼的课件，它是一个联合体类型。</div><br><div></div><br><div><br><div></div><br><div>当 IMAGE_THUNK_DATA 值的最高位为 0时，表示函数以字符串类型的函数名方式输入，这时双字的值是一个 RVA，指向一个</div><br><div>这个时候很好办，我们可以找到这个RVA换算成offset 最终获得它的函数名称</div><br><div></div><br><div>当 IMAGE_THUNK_DATA 值的最高位为 1时，表示函数以序号方式输入，这时候低 31位被看作一个函数序号。</div><br><div>这个时候就讨厌了，如果没有考虑到这个情况的话，程序很可能会因为错误的指针而出错。</div><br><div>这个时候我们就应该用一个if语句来进行一下判断：</div><br><div></div><br><div><br><figure class="highlight"><figcaption><span>SrcImageThunkData = (PIMAGE_THUNK_DATA) PINT;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ( ! (SrcImageThunkData[i].u1.Ordinal &#38;amp; 0x80000000))</span><br></pre></td></tr></table></figure><br><br><div></div><br><div>这里用到了 &amp; 按位与运算<br><br>注意一下这里的 0&#215;80000000是十六进制的，0&#215;8转换成二进制就是1000 这样最高位就是1了<br><br>通过这个if条件的判断，就可以知道联合体的成员是ForwarderString 还是Ordinal<br><br>好吧，下面把我自己写的代码贴上来，虽然说有点乱，只是当做自己的笔记。大家可以不看的。因为代码写的很不工整。。。。</div><br><div></div><br><div></div><br></div><br></div><br></div><br><div><br><figure class="highlight"><figcaption><span>&lt;stdio.h&gt;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &#38;lt;windows.h&#38;gt;&#10;#include &#38;lt;tchar.h&#38;gt;&#10;#include &#38;lt;winnt.h&#38;gt;&#10;&#10;const TCHAR* FileName = L&#34;d:\PING.exe&#34;;&#10;//&#25991;&#20214;&#30446;&#24405;&#10;const TCHAR* NewFileName = L&#34;d:\PING2.exe&#34;;&#10;//&#22797;&#21046;&#30340;&#25991;&#20214;&#30446;&#24405;&#10;HANDLE hFile;&#10;//&#25991;&#20214;&#21477;&#26564;&#10;BYTE* pBase = NULL;&#10;//&#22522;&#22320;&#22336;&#10;int NumberOfSections;&#10;//&#21306;&#22359;&#34920;&#30340;&#20010;&#25968;&#10;DWORD IMPORT_RVA = NULL;&#10;//&#36755;&#20837;&#34920;&#30340;RVA&#10;DWORD IMPORT_OFFSET = NULL;&#10;//&#36755;&#20837;&#34920;&#30340;offset&#10;DWORD IN_IMPORT_RVA = NULL;&#10;//&#36755;&#20837;&#34920;&#25152;&#22312;&#30340;&#21306;&#22359;&#30340;&#36215;&#22987;RVA&#10;DWORD IN_IMPORT_OFFSET = NULL;&#10;//&#36755;&#20837;&#34920;&#25152;&#22312;&#21306;&#22359;&#30340;&#29289;&#29702;&#36215;&#22987;&#22320;&#22336;&#10;BYTE* fnReadFile();&#10;//&#35835;&#21462;&#25991;&#20214;&#10;int fnReadPE (BYTE *pBuffer);&#10;//&#35835;&#21462;PE&#25991;&#20214;&#20449;&#24687;&#10;BYTE* fnReadDosHeader(BYTE* pBuffer);&#10;//&#35835;&#21462;dos&#25991;&#20214;&#22836;&#20449;&#24687;&#10;int fnReadNTHeader(BYTE* pBuffer);&#10;//&#35835;&#21462; PE&#25991;&#20214;&#22836;&#20449;&#24687;&#10;int fnReadFileHeader(BYTE* ImageFileHeader);&#10;//&#35835;&#21462;PE&#25991;&#20214;&#22836;&#20013;&#30340;FileHeader&#32467;&#26500;&#30340;&#20449;&#24687;&#10;int fnReadOptionalHeader(BYTE* ImageOptionalHeader);&#10;//&#35835;&#21462;PE&#25991;&#20214;&#22836;&#20013;&#30340;OptionalHeader&#32467;&#26500;&#30340;&#20449;&#24687;&#10;int fnReadSectionHeader(BYTE* ImageSectionHeader);&#10;//&#35835;&#21462;&#21306;&#22359;&#34920;&#10;int fnReadImportTable(BYTE* ImportTable);&#10;//&#35835;&#21462;&#36755;&#20837;&#34920;&#10;int fnReadDllName(BYTE* PDllName);&#10;//&#35835;&#21462;DLL&#21517;&#31216;&#10;int fnReadINT(BYTE* PINT);&#10;//&#35835;&#21462;INT&#10;int fnReadFunctionName(BYTE* PFunctionName);&#10;//&#35835;&#21462;&#20989;&#25968;&#21517;&#31216;&#10;//int fnAddSectionTable(LONG offset);&#10;//&#28155;&#21152;PE&#21306;&#22359;&#34920;&#10;int Copy();&#10;//&#22797;&#21046;&#25991;&#20214;&#65292;&#38450;&#27490;&#25991;&#20214;&#34987;&#30772;&#22351;&#10;&#10;IMAGE_SECTION_HEADER  Own_Section_Header;&#10;/*&#10;Own_Section_Header.Name[Own_Section_Header] = &#34;.carl&#34;;&#10;Own_Section_Header.VirtualAddress = 9A010000 ;               // &#33410;&#21306;&#30340; RVA &#22320;&#22336;&#10;Own_Section_Header.SizeOfRawData =00100000 ;              // &#22312;&#25991;&#20214;&#20013;&#23545;&#40784;&#21518;&#30340;&#23610;&#23544;&#10;Own_Section_Header.PointerToRawData = 00020000;         // &#22312;&#25991;&#20214;&#20013;&#30340;&#20559;&#31227;&#37327;&#10;Own_Section_Header.PointerToRelocations = 00040000;     // &#22312;OBJ&#25991;&#20214;&#20013;&#20351;&#29992;&#65292;&#37325;&#23450;&#20301;&#30340;&#20559;&#31227;&#10;Own_Section_Header.PointerToLinenumbers = 00000000;   // &#34892;&#21495;&#34920;&#30340;&#20559;&#31227;&#65288;&#20379;&#35843;&#35797;&#20351;&#29992;&#22320;&#65289;&#10;Own_Section_Header.NumberOfRelocations =0000;      // &#22312;OBJ&#25991;&#20214;&#20013;&#20351;&#29992;&#65292;&#37325;&#23450;&#20301;&#39033;&#25968;&#30446;&#10;Own_Section_Header.NumberOfLinenumbers = 0000;    // &#34892;&#21495;&#34920;&#20013;&#34892;&#21495;&#30340;&#25968;&#30446;&#10;Own_Section_Header.Characteristics = 20000060;              // &#33410;&#23646;&#24615;&#22914;&#21487;&#35835;&#65292;&#21487;&#20889;&#65292;&#21487;&#25191;&#34892;&#31561;&#10;*/&#10;int main()&#10;&#123;&#10;&#9;Copy();&#10;&#9;BYTE* pBuffer = fnReadFile();&#10;&#10;&#9;fnReadPE (pBuffer);&#10;&#10;&#9;return 0;&#10;&#125;&#10;&#10;BYTE* fnReadFile()&#10;&#123;&#10;&#9;printf(&#34;&#26144;&#23556;&#25991;&#20214;...n&#34;);&#10;&#9;hFile = CreateFile(NewFileName, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);&#10;&#9;//&#35835;&#21462;&#25991;&#20214;&#10;&#9;if (hFile == INVALID_HANDLE_VALUE)&#10;&#9;&#123;&#10;&#9;&#9;printf(&#34;&#25171;&#24320;&#25991;&#20214;&#20986;&#38169;n&#34;);&#10;&#9;&#9;return 0;&#10;&#9;&#125;&#10;&#9;DWORD dwFileSize = GetFileSize(hFile, NULL);&#10;&#9;//&#33719;&#24471;&#25991;&#20214;&#22823;&#23567;&#10;&#9;BYTE* pBuffer = new BYTE[dwFileSize];&#10;&#9;//new&#30456;&#24403;&#20110;malloc&#10;&#9;DWORD dwSizeOfRead;&#10;&#10;&#9;if(!ReadFile(hFile, pBuffer, dwFileSize, &#38;amp;dwSizeOfRead, NULL))&#10;&#9;&#123;&#10;&#9;&#9;printf(&#34;&#35835;&#21462;&#25991;&#20214;&#20986;&#38169;n&#34;);&#10;&#9;&#9;pBase = NULL;&#10;&#9;&#9;return 0;&#10;&#9;&#125;&#10;&#9;pBase = pBuffer;&#10;&#9;return pBase;&#10;&#9;//&#22522;&#22320;&#22336;&#10;&#125;&#10;&#10;int fnReadPE(BYTE *pBuffer)&#10;&#123;&#10;&#9;printf(&#34;&#35835;&#21462;PE&#20449;&#24687;...n&#34;);&#10;&#9;BYTE* pBaseNTHeader = fnReadDosHeader(pBuffer);&#10;&#9;//&#35843;&#29992;fnReadDosHeader&#20989;&#25968;&#33719;&#21462;Dos&#22836;&#20449;&#24687;,&#24182;&#19988;&#33719;&#24471;PE&#25991;&#20214;&#22836;&#30340;&#22522;&#22320;&#22336;&#10;&#9;if (!pBaseNTHeader)&#10;&#9;&#123;&#10;&#9;&#9;return 1;&#10;&#9;&#125;&#10;&#10;&#9;if (!fnReadNTHeader(pBaseNTHeader))&#10;&#9;&#9;//&#35835;&#21462;PE&#25991;&#20214;&#22836;&#20449;&#24687;&#10;&#9;&#123;&#10;&#9;&#9;return 1;&#10;&#9;&#125;&#10;&#9;return 0;&#10;&#125;&#10;&#10;BYTE* fnReadDosHeader(BYTE* pBuffer)&#10;//&#35835;&#21462;dos&#25991;&#20214;&#22836;&#20449;&#24687;&#10;&#123;&#10;&#9;printf(&#34;&#35835;&#21462;DOS&#25991;&#20214;&#22836;...n&#34;);&#10;&#9;PIMAGE_DOS_HEADER SrcImageDosHeader = (PIMAGE_DOS_HEADER)pBuffer;&#10;&#9;if (SrcImageDosHeader-&#38;gt;e_magic != IMAGE_DOS_SIGNATURE)&#10;&#9;&#123;&#10;&#9;&#9;return 0;&#10;&#9;&#125;&#10;&#9;else&#10;&#9;&#123;&#10;&#9;&#9;printf(&#34;IMAGE_DOS_HEADER&#32467;&#26500;n&#34;);&#10;&#9;&#9;printf(&#34;e_magic   :%04x   DOS&#21487;&#25191;&#34892;&#25991;&#20214;&#26631;&#35760;n&#34;,SrcImageDosHeader-&#38;gt;e_magic);&#10;&#9;&#9;printf(&#34;e_cblp    :%04x   Bytes on last page of filen&#34;,SrcImageDosHeader-&#38;gt;e_cblp);&#10;&#9;&#9;printf(&#34;e_cp      :%04x   Page in filen&#34;, SrcImageDosHeader-&#38;gt;e_cp);&#10;&#9;&#9;printf(&#34;e_crlc    :%04x   Relocationsn&#34;, SrcImageDosHeader-&#38;gt;e_crlc);&#10;&#9;&#9;printf(&#34;e_cparhdr :%04x   Size of header in paragraphsn&#34;, SrcImageDosHeader-&#38;gt;e_cparhdr);&#10;&#9;&#9;printf(&#34;e_minalloc:%04x   Minimum extra paragraphs neededn&#34;, SrcImageDosHeader-&#38;gt;e_minalloc);&#10;&#9;&#9;printf(&#34;e_maxalloc:%04x   Maximum extra paragraphs neededn&#34;, SrcImageDosHeader-&#38;gt;e_maxalloc);&#10;&#9;&#9;printf(&#34;e_ss      :%04x   Initial (relative) SS value DOS&#20195;&#30721;&#30340;&#21021;&#22987;&#21270;&#22534;&#26632;SSn&#34;, SrcImageDosHeader-&#38;gt;e_ss);&#10;&#9;&#9;printf(&#34;e_sp      :%04x   Initial SP value DOS&#20195;&#30721;&#30340;&#21021;&#22987;&#21270;&#22534;&#26632;&#25351;&#38024;SPn&#34;, SrcImageDosHeader-&#38;gt;e_sp);&#10;&#9;&#9;printf(&#34;e_csum    :%04x   Checksumn&#34;, SrcImageDosHeader-&#38;gt;e_csum);&#10;&#9;&#9;printf(&#34;e_ip      :%04x   Initial IP value DOS&#20195;&#30721;&#30340;&#21021;&#22987;&#21270;&#25351;&#38024;&#20837;&#21475;n&#34;, SrcImageDosHeader-&#38;gt;e_ip);&#10;&#9;&#9;printf(&#34;e_cs      :%04x   Initial (relative) CS value DOS&#20195;&#30721;&#30340;&#21021;&#22987;&#22534;&#26632;&#20837;&#21475;n&#34;, SrcImageDosHeader-&#38;gt;e_cs);&#10;&#9;&#9;printf(&#34;e_lfarlc  :%04x   File address of elocation tablen&#34;, SrcImageDosHeader-&#38;gt;e_lfarlc);&#10;&#9;&#9;printf(&#34;e_ovno    :%04x   Overlay numbern&#34;, SrcImageDosHeader-&#38;gt;e_ovno);&#10;&#9;&#9;printf(&#34;e_res[4]  :%04x, %04x, %04x, %04x   Reserved wordsn&#34;, SrcImageDosHeader-&#38;gt;e_res[0],SrcImageDosHeader-&#38;gt;e_res[1],SrcImageDosHeader-&#38;gt;e_res[2],SrcImageDosHeader-&#38;gt;e_res[3]);&#10;&#9;&#9;printf(&#34;e_oemid   :%04x   OEM identifier (for e_oeminfo)n&#34;, SrcImageDosHeader-&#38;gt;e_oemid);&#10;&#9;&#9;printf(&#34;e_oeminfo :%04x   OEM information; e_oemid specificn&#34;, SrcImageDosHeader-&#38;gt;e_oeminfo);&#10;&#9;&#9;printf(&#34;e_res2[10]:%04x,%04x,%04x,%04x,%04x,%04x,%04x,%04x,%04x,%04x,   Reserved wordsn&#34;, SrcImageDosHeader-&#38;gt;e_res2[0],SrcImageDosHeader-&#38;gt;e_res2[1],SrcImageDosHeader-&#38;gt;e_res2[2],SrcImageDosHeader-&#38;gt;e_res2[3],SrcImageDosHeader-&#38;gt;e_res2[4],SrcImageDosHeader-&#38;gt;e_res2[5],SrcImageDosHeader-&#38;gt;e_res2[6],SrcImageDosHeader-&#38;gt;e_res2[7],SrcImageDosHeader-&#38;gt;e_res2[8],SrcImageDosHeader-&#38;gt;e_res2[9]);&#10;&#9;&#9;printf(&#34;e_lfanew  :%04x   File address of new exe header &#25351;&#21521;PE&#25991;&#20214;&#22836;n&#34;, SrcImageDosHeader-&#38;gt;e_lfanew);&#10;&#9;&#125;&#10;&#9;LONG  test = (LONG) (SrcImageDosHeader-&#38;gt;e_lfanew);&#10;&#9;//fnAddSectionTable(test);//PE&#25991;&#20214;&#22836;&#30340;&#24320;&#22987;&#20301;&#32622;&#10;&#10;&#9;return (BYTE*) (pBuffer + SrcImageDosHeader-&#38;gt;e_lfanew);&#10;&#125;&#10;&#10;int fnReadNTHeader(BYTE* pBaseNTBuffer)&#10;&#123;&#10;&#9;printf(&#34;&#35835;&#21462;PE&#25991;&#20214;&#22836;...n&#34;);&#10;&#9;PIMAGE_NT_HEADERS SrcImageNTHeader = (PIMAGE_NT_HEADERS)(pBaseNTBuffer);&#10;&#9;if (SrcImageNTHeader-&#38;gt;Signature != IMAGE_NT_SIGNATURE)&#10;&#9;&#123;&#10;&#9;&#9;return 1;&#10;&#9;&#125;&#10;&#9;else&#10;&#9;&#123;&#10;&#9;&#9;printf(&#34;IMAGE_NT_HEADERS&#32467;&#26500;n&#34;);&#10;&#9;&#9;printf(&#34;Signature   :%08xn&#34;, SrcImageNTHeader-&#38;gt;Signature);&#10;&#9;&#9;fnReadFileHeader((BYTE*)&#38;amp;SrcImageNTHeader-&#38;gt;FileHeader);&#10;&#9;&#9;//&#35835;&#21462;FileHeader&#32467;&#26500;&#30340;&#20449;&#24687;&#10;&#9;&#9;fnReadOptionalHeader((BYTE*) &#38;amp;SrcImageNTHeader-&#38;gt;OptionalHeader);&#10;&#9;&#9;//&#35835;&#21462;OptionalHeader&#32467;&#26500;&#30340;&#20449;&#24687;&#10;&#9;&#9; fnReadSectionHeader((BYTE*)IMAGE_FIRST_SECTION(pBaseNTBuffer));&#10;&#9;&#9; //&#35835;&#21462;&#21306;&#22359;&#34920;&#10;&#9;&#9; fnReadImportTable((BYTE*) (pBase+IMPORT_OFFSET));&#10;&#9;&#125;&#10;&#9;return 0;&#10;&#125;&#10;&#10;int fnReadFileHeader(BYTE* ImageFileHeader)&#10;&#123;&#10;&#10;&#9;PIMAGE_FILE_HEADER SrcImageFileHeader = (PIMAGE_FILE_HEADER)ImageFileHeader;&#10;&#9;printf(&#34;IMAGE_FILE_HEADERS&#32467;&#26500;n&#34;);&#10;&#9;printf(&#34;Machine:              %04xn&#34;,  SrcImageFileHeader-&#38;gt;Machine);&#10;&#9;printf(&#34;NumberOfSections:     %04xn&#34;,  SrcImageFileHeader-&#38;gt;NumberOfSections);&#10;&#9;printf(&#34;TimeDateStamp:        %08xn&#34;,  SrcImageFileHeader-&#38;gt;TimeDateStamp);&#10;&#9;printf(&#34;PointerToSymbolTable: %08xn&#34;,  SrcImageFileHeader-&#38;gt;PointerToSymbolTable);&#10;&#9;printf(&#34;NumberOfSymbols:      %08xn&#34;,  SrcImageFileHeader-&#38;gt;NumberOfSymbols);&#10;&#9;printf(&#34;SizeOfOptionalHeader: %04xn&#34;,  SrcImageFileHeader-&#38;gt;SizeOfOptionalHeader);&#10;&#9;printf(&#34;Characteristics:      %04xn&#34;,  SrcImageFileHeader-&#38;gt;Characteristics);&#10;&#9;NumberOfSections = SrcImageFileHeader-&#38;gt;NumberOfSections;&#10;&#9;return 0;&#10;&#125;&#10;&#10;int fnReadOptionalHeader(BYTE* ImageOptionalHeader)&#10;&#123;&#10;&#9;PIMAGE_OPTIONAL_HEADER SrcImageOptional_Header = (PIMAGE_OPTIONAL_HEADER)ImageOptionalHeader;&#10;&#9;printf(&#34;IMAGE_OPTIONAL_HEADER&#32467;&#26500;n&#34;);&#10;&#10;&#9;// Standard fields.&#10;&#9;printf(&#34;Magic:                        %04xn&#34;, SrcImageOptional_Header-&#38;gt;Magic);&#10;&#9;printf(&#34;MajorLinkerVersion:            %02xn&#34;, SrcImageOptional_Header-&#38;gt;MajorLinkerVersion);&#10;&#9;printf(&#34;MinorLinkerVersion:            %02xn&#34;, SrcImageOptional_Header-&#38;gt;MinorLinkerVersion);&#10;&#9;printf(&#34;SizeOfCode:                    %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfCode);&#10;&#9;printf(&#34;SizeOfInitializedData:        %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfInitializedData);&#10;&#9;printf(&#34;SizeOfUninitializedData:    %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfUninitializedData);&#10;&#9;printf(&#34;AddressOfEntryPoint:        %08xn&#34;, SrcImageOptional_Header-&#38;gt;AddressOfEntryPoint);&#10;&#9;printf(&#34;BaseOfCode:                    %08xn&#34;, SrcImageOptional_Header-&#38;gt;BaseOfCode);&#10;&#9;printf(&#34;BaseOfData:                    %08xn&#34;, SrcImageOptional_Header-&#38;gt;BaseOfData);&#10;&#10;&#9;// NT additional fields.&#10;&#9;printf(&#34;ImageBase:                  %08xn&#34;, SrcImageOptional_Header-&#38;gt;ImageBase);&#10;&#9;printf(&#34;SectionAlignment:           %08xn&#34;, SrcImageOptional_Header-&#38;gt;SectionAlignment);&#10;&#9;printf(&#34;FileAlignmen:               %08xn&#34;, SrcImageOptional_Header-&#38;gt;FileAlignment);&#10;&#9;printf(&#34;MajorOperatingSystemVersion:%04xn&#34;, SrcImageOptional_Header-&#38;gt;MajorOperatingSystemVersion);&#10;&#9;printf(&#34;MinorOperatingSystemVersion:%04xn&#34;, SrcImageOptional_Header-&#38;gt;MinorOperatingSystemVersion);&#10;&#9;printf(&#34;MajorImageVersion;          %04xn&#34;, SrcImageOptional_Header-&#38;gt;MajorImageVersion);&#10;&#9;printf(&#34;MinorImageVersion:          %04xn&#34;, SrcImageOptional_Header-&#38;gt;MinorImageVersion);&#10;&#9;printf(&#34;MajorSubsystemVersion:      %04xn&#34;, SrcImageOptional_Header-&#38;gt;MajorSubsystemVersion);&#10;&#9;printf(&#34;MinorSubsystemVersion:      %04xn&#34;, SrcImageOptional_Header-&#38;gt;MinorSubsystemVersion);&#10;&#9;printf(&#34;Win32VersionValue:          %08xn&#34;, SrcImageOptional_Header-&#38;gt;Win32VersionValue);&#10;&#9;printf(&#34;SizeOfImage:                %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfImage);&#10;&#9;printf(&#34;SizeOfHeaders:              %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfHeaders);&#10;&#9;printf(&#34;CheckSum:                   %08xn&#34;, SrcImageOptional_Header-&#38;gt;CheckSum);&#10;&#9;printf(&#34;Subsystem:                  %04xn&#34;, SrcImageOptional_Header-&#38;gt;Subsystem);&#10;&#9;printf(&#34;DllCharacteristics:         %04xn&#34;, SrcImageOptional_Header-&#38;gt;DllCharacteristics);&#10;&#9;printf(&#34;SizeOfStackReserve:         %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfStackReserve);&#10;&#9;printf(&#34;SizeOfStackCommit:          %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfStackCommit);&#10;&#9;printf(&#34;SizeOfHeapReserve:          %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfHeapCommit);&#10;&#9;printf(&#34;SizeOfHeapCommit:           %08xn&#34;, SrcImageOptional_Header-&#38;gt;SizeOfHeapCommit);&#10;&#9;printf(&#34;LoaderFlags:                %08xn&#34;, SrcImageOptional_Header-&#38;gt;LoaderFlags);&#10;&#9;printf(&#34;NumberOfRvaAndSizes:        %08xn&#34;, SrcImageOptional_Header-&#38;gt;NumberOfRvaAndSizes);&#10;&#9;//&#33719;&#24471;&#25968;&#25454;&#30446;&#24405;&#34920;&#20013;&#36755;&#20837;&#34920;&#30340;&#22823;&#23567;&#21644;RVA&#22320;&#22336;&#10;&#9;printf(&#34;IMAGE_DIRECTORY_ENTRY_EXPOET Size:   %08xn&#34;, SrcImageOptional_Header-&#38;gt;DataDirectory[1].Size);&#10;&#9;printf(&#34;IMAGE_DIRECTORY_ENTRY_EXPOET VirtualAddress(RVA):   %08xn&#34;, SrcImageOptional_Header-&#38;gt;DataDirectory[1].VirtualAddress);&#10;&#9;IMPORT_RVA = SrcImageOptional_Header-&#38;gt;DataDirectory[1].VirtualAddress;&#10;&#9;return 0;&#10;&#125;&#10;&#10;int fnReadSectionHeader(BYTE* ImageSectionHeader)&#123;&#10;&#9;int i = 0;&#10;&#9;int NUMBER_OF_RVA = NULL;&#10;&#9;//&#33719;&#24471;&#36755;&#20837;&#34920;&#25152;&#22312;&#30340;&#21306;&#22359;&#20301;&#32622;&#10;&#9;PIMAGE_SECTION_HEADER SrcImageSectionHeader = (PIMAGE_SECTION_HEADER) ImageSectionHeader;&#10;&#9;//&#25968;&#32452;&#21517;&#21487;&#20197;&#30475;&#25104;&#26159;&#25351;&#38024;&#65292;&#25152;&#20197;&#19979;&#38754;&#21487;&#20197;&#29992;&#25968;&#32452;&#30340;&#26041;&#24335;&#26469;&#34920;&#31034;&#30456;&#24403;&#20110; &#65288;i+1&#65289; *sizeof(PIMAGE_SECTION_HEADER)&#10;&#9;printf(&#34;IMAGE_SECTION_HEADER&#32467;&#26500;n&#34;);&#10;&#9;for (i = 0; i &#38;lt; NumberOfSections; i++)&#10;&#9;&#123;&#10;&#9;&#9;char SectionName[9];&#10;&#9;&#9;memset(SectionName, 0, sizeof(SectionName));&#10;&#9;&#9;memcpy(SectionName, SrcImageSectionHeader[i].Name, 8);&#10;&#9;&#9;printf(&#34;name:%sn&#34;, SectionName);&#10;&#9;&#9;printf(&#34;Misc:                %08xn&#34;, SrcImageSectionHeader[i].Misc);&#10;&#9;&#9;printf(&#34;VirtualAddres:       %08xn&#34;, SrcImageSectionHeader[i].VirtualAddress);&#10;&#9;&#9;printf(&#34;SizeOfRawData:       %08xn&#34;, SrcImageSectionHeader[i].SizeOfRawData);&#10;&#9;&#9;printf(&#34;PointerToRawData:    %08xn&#34;, SrcImageSectionHeader[i].PointerToRawData);&#10;&#9;&#9;printf(&#34;PointerToRelocations:%08xn&#34;, SrcImageSectionHeader[i].PointerToRelocations);&#10;&#9;&#9;printf(&#34;PointerToLinenumbers:%08xn&#34;, SrcImageSectionHeader[i].PointerToLinenumbers);&#10;&#9;&#9;printf(&#34;NumberOfRelocations: %04xn&#34;, SrcImageSectionHeader[i].NumberOfRelocations);&#10;&#9;&#9;printf(&#34;NumberOfLinenumbers: %04xn&#34;, SrcImageSectionHeader[i].NumberOfLinenumbers);&#10;&#9;&#9;printf(&#34;Characteristics:     %08xn&#34;, SrcImageSectionHeader[i].Characteristics);&#10;&#9;&#9;if (i &#38;lt; NumberOfSections - 1)&#10;&#9;&#9;if (IMPORT_RVA &#38;gt;= SrcImageSectionHeader[i].VirtualAddress &#38;amp;&#38;amp; IMPORT_RVA &#38;lt; SrcImageSectionHeader[i+1].VirtualAddress)&#10;&#9;&#9;&#9;NUMBER_OF_RVA = i;&#10;&#9;&#125;&#10;&#9;printf(&#34;&#36755;&#20837;&#34920;&#25152;&#22312;&#30340;&#21306;&#22359;&#26159;&#22312;&#31532;%d&#20010;&#21306;&#22359;n&#34;, NUMBER_OF_RVA+1);&#10;&#9;IMPORT_OFFSET = IMPORT_RVA - (SrcImageSectionHeader[NUMBER_OF_RVA].VirtualAddress - SrcImageSectionHeader[NUMBER_OF_RVA].PointerToRawData);&#10;&#10;&#9;//printf(&#34;%08xn&#34;, SrcImageSectionHeader[NUMBER_OF_RVA].VirtualAddress);&#10;&#9;//printf(&#34;%08xn&#34;, SrcImageSectionHeader[NUMBER_OF_RVA].PointerToRawData);&#10;&#10;&#9;IN_IMPORT_RVA = SrcImageSectionHeader[NUMBER_OF_RVA].VirtualAddress;&#10;&#9;//&#36755;&#20837;&#34920;&#25152;&#22312;&#30340;&#21306;&#22359;&#30340;&#36215;&#22987;RVA&#10;&#9;IN_IMPORT_OFFSET = SrcImageSectionHeader[NUMBER_OF_RVA].PointerToRawData;&#10;&#9;//&#36755;&#20837;&#34920;&#25152;&#22312;&#21306;&#22359;&#30340;&#29289;&#29702;&#36215;&#22987;&#22320;&#22336;&#10;&#10;&#9;//printf(&#34;&#36755;&#20837;&#34920;&#30340;RVA&#26159;%08xn&#34;, IMPORT_RVA);&#10;&#9;//printf(&#34;&#36755;&#20837;&#34920;&#30340;offset&#26159;%08xn&#34;, IMPORT_OFFSET);&#10;&#9;return 0;&#10;&#125;&#10;&#10;int fnReadImportTable(BYTE* ImportTable)&#10;&#123;&#10;&#9;PIMAGE_IMPORT_DESCRIPTOR SrcImageImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)ImportTable;&#10;&#9;printf(&#34;&#36755;&#20837;&#34920;&#20869;&#23481;.....n&#34;);&#10;&#9;for (int i = 0; SrcImageImportDescriptor[i].OriginalFirstThunk != 0; i++)&#10;&#9;//IID&#26368;&#21518;&#19968;&#20010;&#32467;&#26500;&#22914;&#26524;&#20840;&#37096;&#20026;0&#26631;&#24535;&#30528;&#32467;&#26463;&#10;&#9;&#123;&#10;&#9;&#9;printf(&#34;OriginalFirstThunk is %08xn&#34;,SrcImageImportDescriptor[i].OriginalFirstThunk);&#10;&#9;&#9;printf(&#34;TimeDataStamp is %08xn&#34;, SrcImageImportDescriptor[i].TimeDateStamp);&#10;&#9;&#9;printf(&#34;ForwarderChain is %08xn&#34;,SrcImageImportDescriptor[i].ForwarderChain);&#10;&#9;&#9;printf(&#34;Name is %08xn&#34;, SrcImageImportDescriptor[i].Name);&#10;&#9;&#9;printf(&#34;FirstChunk is  %08xn &#34;,SrcImageImportDescriptor[i].FirstThunk);&#10;&#9;&#9;printf(&#34;n&#34;);&#10;&#10;&#9;&#9;fnReadDllName((BYTE*)(SrcImageImportDescriptor[i].Name - IN_IMPORT_RVA + IN_IMPORT_OFFSET + pBase));&#10;&#9;&#9;fnReadINT((BYTE*) (SrcImageImportDescriptor[i].OriginalFirstThunk - IN_IMPORT_RVA + IN_IMPORT_OFFSET + pBase) );&#10;&#10;&#9;&#9;//BYTE * SrcImageThunkData = SrcImageImportDescriptor[i].OriginalFirstThunk;&#10;&#9;&#9;//PIMAGE_THUNK_DATA SrcImageThunkData = &#10;&#10;&#9;&#125;&#10;&#9;return 0;&#10;&#125;&#10;&#10;int fnReadDllName(BYTE* PDllName)&#10;&#123;&#10;&#9;char* Dll;&#10;&#9;Dll = (char*)PDllName;&#10;&#9;printf(&#34;Dll name is %sn&#34;, Dll);&#10;&#9;printf(&#34;n&#34;);&#10;&#9;return 0;&#10;&#125;&#10;&#10;int fnReadINT(BYTE* PINT)&#10;&#123;&#10;&#9;PIMAGE_THUNK_DATA SrcImageThunkData = (PIMAGE_THUNK_DATA) PINT;&#10;&#9;for (int i = 0; SrcImageThunkData[i].u1.AddressOfData != 0; i++)&#10;&#9;&#123;&#10;&#9;&#9;//printf(&#34;IMAGE_THUNK_DATA INT  is  %08xn&#34;, SrcImageThunkData[i].u1);&#10;&#10;&#9;&#9;PIMAGE_IMPORT_BY_NAME SrcImageImportByName = (PIMAGE_IMPORT_BY_NAME)(SrcImageThunkData[i].u1.AddressOfData - IN_IMPORT_RVA + IN_IMPORT_OFFSET + pBase);&#10;&#9;&#9;if ( ! (SrcImageThunkData[i].u1.Ordinal &#38;amp; 0x80000000))&#10;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;//&#36825;&#37324;&#30340;8&#26159;16&#36827;&#21046;&#30340;&#65292;&#36716;&#25442;&#20026;2&#36827;&#21046;&#23601;&#26159;1000&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;char* FunctionName;&#10;&#9;&#9;&#9;FunctionName = (char*)(SrcImageImportByName) + sizeof(char) * 2;&#10;&#9;&#9;&#9;printf(&#34;Function name is %sn&#34;, FunctionName);&#10;&#9;&#9;&#9;printf(&#34;n&#34;);&#9;&#9;&#9;&#10;&#9;&#9;&#125;&#10;&#9;&#9;/*&#10;&#9;&#9;else&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;printf(&#34;%08xn&#34;,SrcImageThunkData[i].u1.Ordinal &#38;amp; 0x80000000);&#9;&#10;&#9;&#9;&#125;&#10;&#9;&#9;*/&#10;&#9;&#125;&#10;&#10;&#9;//fnReadFunctionName((BYTE*) (SrcImageThunkData-&#38;gt;u1.AddressOfData - IN_IMPORT_RVA + IN_IMPORT_OFFSET + pBase) );&#10;&#9;return 0;&#10;&#125;&#10;int fnReadFunctionName(BYTE* PFunctionName)&#10;&#123;&#10;&#9;char* FunctionName;&#10;&#9;FunctionName = (char*)PFunctionName;&#10;&#9;printf(&#34;Function name is %sn&#34;, FunctionName);&#10;&#9;printf(&#34;n&#34;);&#10;&#9;return 0;&#10;&#125;&#10;/*&#10;int fnAddSectionTable(LONG offset)&#10;&#123;&#10;&#9;DWORD dwSizeOfWrite;&#10;&#9;DWORD add = 0x6C726163;&#10;&#9;LPDWORD lpNumberOfBytesWritten = NULL;&#10;&#9;PIMAGE_SECTION_HEADER p = &#38;amp;Own_Section_Header;&#10;&#9;//BYTE* ChangeAddress = ImageSectionTable - 2 *sizeof(BYTE);&#10;&#9;//BYTE* lpWriteBuffer = ImageSectionTable - 8 * sizeof(BYTE);&#10;&#10;&#9;//Own_Section_Header.Name[Own_Section_Header] = &#34;.carl&#34;;&#10;&#9;//Own_Section_Header.VirtualAddress = 9A010000 ;               // &#33410;&#21306;&#30340; RVA &#22320;&#22336;&#10;&#9;Own_Section_Header.SizeOfRawData =00100000 ;              // &#22312;&#25991;&#20214;&#20013;&#23545;&#40784;&#21518;&#30340;&#23610;&#23544;&#10;&#9;Own_Section_Header.PointerToRawData = 00020000;         // &#22312;&#25991;&#20214;&#20013;&#30340;&#20559;&#31227;&#37327;&#10;&#9;Own_Section_Header.PointerToRelocations = 00040000;     // &#22312;OBJ&#25991;&#20214;&#20013;&#20351;&#29992;&#65292;&#37325;&#23450;&#20301;&#30340;&#20559;&#31227;&#10;&#9;Own_Section_Header.PointerToLinenumbers = 00000000;   // &#34892;&#21495;&#34920;&#30340;&#20559;&#31227;&#65288;&#20379;&#35843;&#35797;&#20351;&#29992;&#22320;&#65289;&#10;&#9;Own_Section_Header.NumberOfRelocations =0000;      // &#22312;OBJ&#25991;&#20214;&#20013;&#20351;&#29992;&#65292;&#37325;&#23450;&#20301;&#39033;&#25968;&#30446;&#10;&#9;Own_Section_Header.NumberOfLinenumbers = 0000;    // &#34892;&#21495;&#34920;&#20013;&#34892;&#21495;&#30340;&#25968;&#30446;&#10;&#9;Own_Section_Header.Characteristics = 20000060;              // &#33410;&#23646;&#24615;&#22914;&#21487;&#35835;&#65292;&#21487;&#20889;&#65292;&#21487;&#25191;&#34892;&#31561;&#10;&#10;&#9;SetFilePointer( hFile,  offset,  NULL,&#9;FILE_BEGIN ); &#10;&#9;if (WriteFile(hFile,  p,  1 * sizeof(Own_Section_Header), &#38;amp;dwSizeOfWrite, NULL ))&#10;&#9;&#9;printf(&#34;&#27491;&#30830;&#20889;&#20837;&#25991;&#20214;n&#34;);&#10;&#9;else&#10;&#9;&#9;printf(&#34;&#20889;&#20837;&#25991;&#20214;&#38169;&#35823;n&#34;);&#10;&#10;&#9;return 0;&#10;&#125;&#10;*/&#10;&#10;int Copy()&#10;&#123;&#10;&#9;BOOL Flag = TRUE;&#10;&#10;&#9;if(CopyFile(FileName, NewFileName, Flag))&#10;&#9;&#9;printf(&#34;&#25104;&#21151;&#22797;&#21046;&#25991;&#20214;n&#34;);&#10;&#9;else&#10;&#9;&#9;printf(&#34;&#22797;&#21046;&#25991;&#20214;&#22833;&#36133;n&#34;);&#10;&#9;return 0;&#10;&#125;</span><br></pre></td></tr></table></figure><br><br></div><br></div></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/15/PE格式之千里追踪输入表/" itemprop="url">
                PE格式之千里追踪输入表
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-15T20:49:11+08:00" content="2012-04-15">
            2012-04-15
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>高数考完了，终于可以轻松的写代码了。哈哈</p>
<p>终于开始写输入表了。输入表是我们项目的重头戏。首先还是先介绍下输入表的基本知识。</p>
<p>自己写的话有点麻烦，还是copy一下小甲鱼辛辛苦苦打出来的课件吧</p>
<p>输入表结构</p>
<p>PE文件头的 IMAGE_OPTIONAL_HEADER 结构中的 DataDirectory(数据目录表) 的第二个成员就是指向输入表的。而输入表是以一个 IMAGE_IMPORT_DESCRIPTOR(简称IID) 的数组开始。每个被 PE文件链接进来的 DLL文件都分别对应一个 IID数组结构。在这个 IID数组中，并没有指出有多少个项(就是没有明确指明有多少个链接文件)，但它最后是以一个全为NULL(0) 的 IID 作为结束的标志。</p>
<p>我们首先来找到这个输入表的地址：还是首先附上上次的那张图片：</p>
<p>如果看不清楚的话，这里给个链接，是我自己的博客里面的，放大应该就看的清楚了</p>
<p><a href="http://miibotree.com/?p=226" target="_blank" rel="external">http://miibotree.com/?p=226</a></p>
<p>在PE头那里我们可以看到数据目录表，(用红框框圈起来的那里) IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]</p>
<p>接着红色的箭头指向了我们的数据目录表的数据结构</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_EXPORT <span class="number">0</span> <span class="comment">// Export Directory</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_IMPORT <span class="number">1</span> <span class="comment">// Import Directory （输入表，我们所需要的）</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_RESOURCE <span class="number">2</span> <span class="comment">// Resource Directory</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_EXCEPTION <span class="number">3</span> <span class="comment">// Exception Directory</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_SECURITY <span class="number">4</span> <span class="comment">// Security Directory</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_BASERELOC <span class="number">5</span> <span class="comment">// Base Relocation Table</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_DEBUG <span class="number">6</span> <span class="comment">// Debug Directory</span></span><br><span class="line"><span class="comment">// IMAGE_DIRECTORY_ENTRY_COPYRIGHT 7 // (X86 usage)</span></span><br><span class="line"><span class="hexcolor">#def</span>i ne IMAGE_DIRECTORY_ENTRY_ARCHITECTURE <span class="number">7</span> <span class="comment">// Architecture Specific Data</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_GLOBALPTR <span class="number">8</span> <span class="comment">// RVA of GP</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_TLS <span class="number">9</span> <span class="comment">// TLS Directory</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG <span class="number">10</span> <span class="comment">// Load Configuration Directory</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT <span class="number">11</span> <span class="comment">// Bound Import Directory in headers</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_IAT <span class="number">12</span> <span class="comment">// Import Address Table</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT <span class="number">13</span> <span class="comment">// Delay Load Import Descriptors</span></span><br><span class="line"><span class="hexcolor">#def</span>ine IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR <span class="number">14</span> <span class="comment">// COM Runtime descriptor</span></span><br></pre></td></tr></table></figure>
<p>然后每个数据目录表的结构成员有两个</p>
<p>typedef struct _IMAGE_DATA_DIRECTORY {</p>
<p>DWORD VirtualAddress; //输入表的RVA</p>
<p>DWORD Size;</p>
<p>} IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</p>
<p>这里的VirtualAddress就是我们的输入表的RVA了</p>
<p>得到RVA只是第一步，我们接下来要判断输入表在哪个区块里面。</p>
<p>当然这个时候我们必须要做的就是读取区块的信息了。区块的数据结构如下（可以在图里面找到哦）</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_SECTION_HEADER &#123;</span><br><span class="line">BYTE Name[IMAGE_SIZEOF_SHORT_NAME]<span class="comment">;</span></span><br><span class="line">union &#123;</span><br><span class="line">DWORD PhysicalAddress<span class="comment">;</span></span><br><span class="line">DWORD VirtualSize<span class="comment">;</span></span><br><span class="line">&#125; Misc<span class="comment">;</span></span><br><span class="line">DWORD VirtualAddress<span class="comment">; //区块的RVA</span></span><br><span class="line">DWORD SizeOfRawData<span class="comment">;</span></span><br><span class="line">DWORD PointerToRawData<span class="comment">;</span></span><br><span class="line">DWORD PointerToRelocations<span class="comment">;</span></span><br><span class="line">DWORD PointerToLinenumbers<span class="comment">;</span></span><br><span class="line">WORD NumberOfRelocations<span class="comment">;</span></span><br><span class="line">WORD NumberOfLinenumbers<span class="comment">;</span></span><br><span class="line">DWORD Characteristics<span class="comment">;</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>通过输入表的RVA与区块的RVA比较，我们就能知道输入表在哪个区块里面。</p>
<p>好，第二步已经完成了。</p>
<p>现在是最关键的第三步：</p>
<p>这里必须明确掌握RVA， VA， offset。因为这个是PE文件的最重点。下面再引用一下小甲鱼的课件：</p>
<p>RVA 和文件偏移的转换</p>
<p>在前边我们探讨过RVA 这个词，但对于初次接触PE 文件的朋友来说，显得尤其陌生和无奈。中国人不喜欢老外的缩写，但总要**着接受……不过，在有了前边知识的铺垫之后，现在来谈这个概念大家伙应该能够得心应手了。起码不用显得那么的费解和无奈~</p>
<p>RVA 是相对虚拟地址（Relative Virtual Address）的缩写，顾名思义，它是一个“相对地址”。PE 文件中的各种数据结构中涉及地址的字段大部分都是以 RVA 表示的，有木有？？</p>
<p>更为准确的说，RVA 是当PE 文件被装载到内存中后，某个数据位置相对于文件头的偏移量。举个例子，如果 Windows 装载器将一个PE 文件装入到 00400000h 处的内存中，而某个区块中的某个数据被装入 0040<strong>xh 处，那么这个数据的 RVA 就是（0040</strong>xh &#8211; 00400000h ）= **xh，反过来说，将 RVA 的值加上文件被装载的基地址，就可以找到数据在内存中的实际地址。</p>
<p>看图说话：</p>
<p>很明显，我们发现，DOS 文件头、PE 文件头和区块表的偏移位置与大小均没有变化。而各个区块映射到内存后，其偏移位置就发生了变化。</p>
<p>RVA 使得文件装入内存后的数据定位变得方便，然而却给我们要定位位于磁盘上的静态PE 文件带来了麻烦。举个例子说话：……由于例子在视频中，这里争取时间我就不写啦，大伙看参考视频演示吧。</p>
<p>如何换算 RVA 和文件偏移呢？</p>
<p>当处理PE 文件时候，任何的 RVA 必须经过到文件偏移的换算，才能用来定位并访问文件中的数据，但换算却无法用一个简单的公式来完成，事实上，唯一可用的方法就是最土最笨的方法：</p>
<p>步骤一：循环扫描区块表得出每个区块在内存中的起始 RVA（根据IMAGE_SECTION_HEADER 中的VirtualAddress 字段），并根据区块的大小（根据IMAGE_SECTION_HEADER 中的SizeOfRawData 字段）算出区块的结束 RVA（两者相加即可），最后判断目标 RVA 是否落在该区块内。</p>
<p>步骤二：通过步骤一定位了目标 RVA 处于具体的某个区块中后，那么用目标 RVA 减去该区块的起始 RVA ，这样就能得到目标 RVA 相对于起始地址的偏移量 RVA2.</p>
<p>步骤三：在区块表中获取该区块在文件中所处的偏移地址（根据IMAGE_SECTION_HEADER 中的PointerToRawData 字段这个字段是物理偏移地址将这个偏移值加上步骤二得到的 RVA2 值，就得到了真正的文件偏移地址。</p>
<p>当然这里理解起来可能比较困难，大家可以看看小甲鱼的视频然后看看加密与解密的那本书最后动手实践来慢慢理解的。</p>
<p>将这个 真正的文件偏移地址加上基地址就是输入表的地址了。</p>
<p>如此一来，我们千里迢迢终于追踪到了输入表的地址了。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/15/修改导入表HOOK-API（ring3-iat-exe-hook-Messagebox）/" itemprop="url">
                修改导入表HOOK API（ring3_iat_exe_hook_Messagebox）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-15T19:04:26+08:00" content="2012-04-15">
            2012-04-15
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p><span style="color: #000000; font-size: x-small;"><span style="font-family: Verdana;">IAT即Import Address Table 是PE（可以理解为EXE）的输入地址表，我们知道一个程序运行时可以要调用多个模块，或都说要调用许多API函数，但这些函数不一定都在EXE本身中，例如你调用<span style="font-family: Verdana;">Messagebox</span>来显示一个对话框时，你只需要调用它，你并没有编写<span style="font-family: Verdana;">Messagebox</span>的函数的实现过程，<span style="font-family: Verdana;">Messagebox</span>的函数的实现过程实际上是在<span style="color: #c60a00;"><span style="color: #c60a00;">user32</span>.dll这个库文件中，</span>当这个程序运行时会在user32.dll中找到<span style="font-family: Verdana;">Messagebox</span>并调用它。</span></span></p>
<p><span style="color: #000000; font-size: x-small;"><span style="font-family: Verdana;">那么具体的调入过程是怎样的呢？下面来谈谈其中的重要环节即：<span style="font-family: Verdana;">IMAGE_IMPORT_BY_NAME</span>，那么<span style="font-family: Verdana;">IMAGE_IMPORT_BY_NAME</span>的<span style="font-size: x-small;">结构到底是什么样子的呢</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">:？下面是引入表图</span></span></span></p>
<p>&nbsp;</p>
<table border="0" cellspacing="1"><br><tbody><br><tr><br><th bgcolor="#006666" width="152"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">OriginalFirstThunk</span></th><br><th width="58"><span style="color: #ffffff;">　</span></th><br><th bgcolor="#006666" width="183"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_IMPORT_BY_NAME</span></th><br><th width="27"><span style="color: #ffffff;">　</span></th><br><th bgcolor="#006666" width="152"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">FirstThunk</span></th><br></tr><br><tr><br><td align="center" width="152"><br><br><span style="color: #ffffff;">|</span><br><br></td><br><td align="center" width="58"><span style="color: #ffffff;">　</span></td><br><td align="center" width="183"><span style="color: #ffffff;">　</span></td><br><td align="center" width="27"><span style="color: #ffffff;">　</span></td><br><td align="center" width="152"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">|</span></span></td><br></tr><br><tr><br><td align="center" width="152"><br><table border="1" cellpadding="2"><br><tbody><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8230;</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br></tbody><br></table><br></td><br><td align="center" width="58"><br><table border="0" cellpadding="2"><br><tbody><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br></tbody><br></table><br></td><br><td align="center" width="183"><br><table border="1" cellpadding="2"><br><tbody><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function 1</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function 2</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function 3</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">Function 4</span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8230;</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function n</span></span></td><br></tr><br></tbody><br></table><br></td><br><td align="center" width="27"><br><table border="0" cellpadding="2"><br><tbody><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&lt;&#8212;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&lt;&#8212;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&lt;&#8212;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&lt;&#8212;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&lt;&#8212;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&lt;&#8212;</span></td><br></tr><br></tbody><br></table><br></td><br><td align="center" width="152"><br><table border="1" cellpadding="2"><br><tbody><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8230;</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #000000;"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br></tbody><br></table><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="color: #000000;"><span style="font-size: x-small;">首先不要被</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_THUNK_DATA</strong></span><span style="font-size: x-small;">这个名字弄糊涂</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">: </span><span style="font-size: x-small;">它仅是指向 </span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_IMPORT_BY_NAME </strong></span><span style="font-size: x-small;">结构的</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">RVA</span><span style="font-size: x-small;">。</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>OriginalFirstThunk</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">和 </span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>FirstThunk</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">所指向的这两个数组大小取决于</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">PE</span><span style="font-size: x-small;">文件从</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">DLL</span><span style="font-size: x-small;">中引入函数的数目。比如，如果</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">PE</span><span style="font-size: x-small;">文件从</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">kernel32.dll</span><span style="font-size: x-small;">中引入</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">10</span><span style="font-size: x-small;">个函数，那么</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_IMPORT_DESCRIPTOR</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">结构的 </span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>Name1</strong></span><span style="font-size: x-small;">域包含指向字符串</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8220;kernel32.dll&#8221;</span><span style="font-size: x-small;">的</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">RVA</span><span style="font-size: x-small;">，同时每个</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_THUNK_DATA</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">数组有</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">10</span><span style="font-size: x-small;">个元素。</span></span><span style="color: #000000;"><span style="font-size: x-small;">为什么我们需要两个完全相同的数组</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">? </span><span style="font-size: x-small;">为了回答该问题，我们需要了解当</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">PE</span><span style="font-size: x-small;">文件被装载到内存时，</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">PE</span><span style="font-size: x-small;">装载器将查找</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_THUNK_DATA</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">和 </span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_IMPORT_BY_NAME</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">这些结构数组，以此决定引入函数的地址。然后用引入函数真实地址来替代由</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>FirstThunk</strong></span><span style="font-size: x-small;">指向的</span><span style="font-size: x-small;"><strong> </strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"><strong>IMAGE_THUNK_DATA</strong></span><span style="font-family: 'MS Sans Serif'; font-size: x-small;"> </span><span style="font-size: x-small;">数组里的元素值。因此当</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">PE</span><span style="font-size: x-small;">文件准备执行时，上图已转换成</span><span style="font-family: 'MS Sans Serif'; font-size: x-small;">:</span></span></p>
<p>&nbsp;</p>
<table border="0" cellspacing="1"><br><tbody><br><tr><br><th bgcolor="#006666"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">OriginalFirstThunk</span></th><br><th><span style="color: #ffffff;">　</span></th><br><th bgcolor="#006666"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_IMPORT_BY_NAME</span></th><br><th><span style="color: #ffffff;">　</span></th><br><th bgcolor="#006666"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">FirstThunk</span></th><br></tr><br><tr><br><td align="center"><br><br><span style="color: #ffffff;">|</span><br><br></td><br><td align="center"><span style="color: #ffffff;">　</span></td><br><td align="center"><span style="color: #ffffff;">　</span></td><br><td align="center"><span style="color: #ffffff;">　</span></td><br><td align="center"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">|</span></span></td><br></tr><br><tr><br><td align="center"><br><table border="1" cellpadding="2"><br><tbody><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8230;</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">IMAGE_THUNK_DATA</span></span></td><br></tr><br></tbody><br></table><br></td><br><td align="center"><br><table border="0" cellpadding="2"><br><tbody><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">&#8212;&gt;</span></td><br></tr><br></tbody><br></table><br></td><br><td align="center"><br><table border="1" cellpadding="2"><br><tbody><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function 1</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function 2</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function 3</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff; font-family: 'MS Sans Serif'; font-size: x-small;">Function 4</span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8230;</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#660066"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Function n</span></span></td><br></tr><br></tbody><br></table><br></td><br><td align="center"><br><table border="0" cellpadding="2"><br><tbody><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff;">   </span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff;">　</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff;">　</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff;">　</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff;">　</span></td><br></tr><br><tr><br><td align="center" nowrap="nowrap"><span style="color: #ffffff;">　</span></td><br></tr><br></tbody><br></table><br></td><br><td align="center"><br><table border="1" cellpadding="2"><br><tbody><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Address of Function 1</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Address of Function 2</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Address of Function 3</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">Address of Function 4</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #ffffff;"><span style="font-family: 'MS Sans Serif'; font-size: x-small;">&#8230;</span></span></td><br></tr><br><tr><br><td align="center" bgcolor="#666600"><span style="color: #000000; font-family: 'MS Sans Serif'; font-size: x-small;"><span style="color: #ffffff;">Address of Function n</span></span></td><br></tr><br></tbody><br></table><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p>我们现在要做的是把后面的地址改成我们自己的函数地址，例如当EXE调用Messagebox时让它转入我们的函数，我们处理完后再转入真正的函数地址。</p>
<p>因此API HOOK和其它HOOK存在本质的区别，可以理解为API劫持，说一行道一万不如动手去实践，下面代码演示了如何HOOK本进程中的Messagebox，当本EXE调用Messagebox时会先转入到我们的函数中，请看清是怎样找到PE的引入表并修改的。</p>
<div><br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">#include</span> <span class="subst">&amp;</span><span class="literal">lt</span>;stdio<span class="built_in">.</span>h<span class="subst">&amp;</span><span class="literal">gt</span>;</span><br><span class="line"><span class="variable">#include</span> <span class="subst">&amp;</span><span class="literal">lt</span>;windows<span class="built_in">.</span>h<span class="subst">&amp;</span><span class="literal">gt</span>;</span><br><span class="line"><span class="variable">#include</span> <span class="subst">&amp;</span><span class="literal">lt</span>;Dbghelp<span class="built_in">.</span>h<span class="subst">&amp;</span><span class="literal">gt</span>;</span><br><span class="line"><span class="variable">#pragma</span> comment(lib,<span class="string">"Dbghelp.lib"</span>)</span><br><span class="line"><span class="variable">#pragma</span> comment(lib,<span class="string">"User32.lib"</span>)</span><br><span class="line">typedef int (__stdcall <span class="subst">*</span>OLD_MessageBox)( HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption,UINT uType );</span><br><span class="line">OLD_MessageBox g_procOldMessageBox <span class="subst">=</span> <span class="built_in">NULL</span>;</span><br><span class="line">int __stdcall HOOK_MessageBox( HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption,UINT uType)</span><br><span class="line">&#123;</span><br><span class="line">printf(<span class="string">"%st%drn"</span>,__FUNCTION__,__LINE__);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NULL</span> <span class="subst">!=</span> g_procOldMessageBox)</span><br><span class="line"><span class="keyword">return</span> g_procOldMessageBox(hWnd,lpText,<span class="string">"不好意思,hook到了!"</span>,uType);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> MessageBox(hWnd,lpText,lpCaption,uType); ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int replace_IAT(const char <span class="subst">*</span>pDllName,const char <span class="subst">*</span>pApiName,bool bReplace)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">HANDLE</span> hProcess <span class="subst">=</span> <span class="tag">::GetModuleHandle</span> (<span class="built_in">NULL</span>);</span><br><span class="line">DWORD dwSize <span class="subst">=</span> <span class="number">0</span>;</span><br><span class="line">PIMAGE_IMPORT_DESCRIPTOR pImageImport <span class="subst">=</span> (PIMAGE_IMPORT_DESCRIPTOR)ImageDirectoryEntryToData(hProcess,<span class="literal">TRUE</span>,</span><br><span class="line">IMAGE_DIRECTORY_ENTRY_IMPORT,<span class="subst">&amp;</span>amp;dwSize);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NULL</span> <span class="subst">==</span> pImageImport)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">PIMAGE_IMPORT_BY_NAME pImageImportByName <span class="subst">=</span> <span class="built_in">NULL</span>;</span><br><span class="line">PIMAGE_THUNK_DATA  pImageThunkOriginal <span class="subst">=</span> <span class="built_in">NULL</span>;</span><br><span class="line">PIMAGE_THUNK_DATA  pImageThunkReal  <span class="subst">=</span> <span class="built_in">NULL</span>;</span><br><span class="line"><span class="keyword">while</span> (pImageImport<span class="subst">-&amp;</span><span class="literal">gt</span>;Name)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> <span class="subst">==</span> strcmpi((char<span class="subst">*</span>)((PBYTE)hProcess<span class="subst">+</span>pImageImport<span class="subst">-&amp;</span><span class="literal">gt</span>;Name),pDllName))</span><br><span class="line">&#123;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line"><span class="subst">++</span>pImageImport;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="subst">!</span> pImageImport<span class="subst">-&amp;</span><span class="literal">gt</span>;Name)</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">pImageThunkOriginal <span class="subst">=</span> (PIMAGE_THUNK_DATA)((PBYTE)hProcess<span class="subst">+</span>pImageImport<span class="subst">-&amp;</span><span class="literal">gt</span>;OriginalFirstThunk  );</span><br><span class="line">pImageThunkReal <span class="subst">=</span> (PIMAGE_THUNK_DATA)((PBYTE)hProcess<span class="subst">+</span>pImageImport<span class="subst">-&amp;</span><span class="literal">gt</span>;FirstThunk   );</span><br><span class="line"><span class="keyword">while</span> (pImageThunkOriginal<span class="subst">-&amp;</span><span class="literal">gt</span>;u1<span class="built_in">.</span>Function)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ((pImageThunkOriginal<span class="subst">-&amp;</span><span class="literal">gt</span>;u1 <span class="built_in">.</span>Ordinal <span class="subst">&amp;</span>amp; IMAGE_ORDINAL_FLAG) <span class="subst">!=</span> IMAGE_ORDINAL_FLAG)</span><br><span class="line">&#123;</span><br><span class="line">pImageImportByName <span class="subst">=</span> (PIMAGE_IMPORT_BY_NAME)((PBYTE)hProcess<span class="subst">+</span>pImageThunkOriginal<span class="subst">-&amp;</span><span class="literal">gt</span>;u1 <span class="built_in">.</span>AddressOfData );</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> <span class="subst">==</span> strcmpi(pApiName,(char<span class="subst">*</span>)pImageImportByName<span class="subst">-&amp;</span><span class="literal">gt</span>;Name))</span><br><span class="line">&#123;</span><br><span class="line">MEMORY_BASIC_INFORMATION mbi_thunk;</span><br><span class="line">VirtualQuery(pImageThunkReal, <span class="subst">&amp;</span>amp;mbi_thunk, sizeof(MEMORY_BASIC_INFORMATION));</span><br><span class="line">VirtualProtect(mbi_thunk<span class="built_in">.</span>BaseAddress,mbi_thunk<span class="built_in">.</span>RegionSize, PAGE_READWRITE, <span class="subst">&amp;</span>amp;mbi_thunk<span class="built_in">.</span><span class="keyword">Protect</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span> <span class="subst">==</span> bReplace)</span><br><span class="line">&#123;</span><br><span class="line">g_procOldMessageBox <span class="subst">=</span>(OLD_MessageBox) pImageThunkReal<span class="subst">-&amp;</span><span class="literal">gt</span>;u1<span class="built_in">.</span>Function;</span><br><span class="line">pImageThunkReal<span class="subst">-&amp;</span><span class="literal">gt</span>;u1<span class="built_in">.</span>Function <span class="subst">=</span> (DWORD)HOOK_MessageBox;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">pImageThunkReal<span class="subst">-&amp;</span><span class="literal">gt</span>;u1<span class="built_in">.</span>Function <span class="subst">=</span> (DWORD)g_procOldMessageBox;</span><br><span class="line">DWORD dwOldProtect;</span><br><span class="line">VirtualProtect(mbi_thunk<span class="built_in">.</span>BaseAddress, mbi_thunk<span class="built_in">.</span>RegionSize, mbi_thunk<span class="built_in">.</span><span class="keyword">Protect</span>, <span class="subst">&amp;</span>amp;dwOldProtect);</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="subst">++</span>pImageThunkOriginal;</span><br><span class="line"><span class="subst">++</span>pImageThunkReal;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">replace_IAT(<span class="string">"User32.dll"</span>,<span class="string">"MessageBoxA"</span>,<span class="literal">true</span>);</span><br><span class="line">MessageBox(<span class="built_in">NULL</span>,<span class="string">"EnumIAT User32.dll MessageBoxA true;"</span>,<span class="string">"没有Hook"</span>,MB_OK);</span><br><span class="line">replace_IAT(<span class="string">"User32.dll"</span>,<span class="string">"MessageBoxA"</span>,<span class="literal">false</span>);</span><br><span class="line">MessageBox(<span class="built_in">NULL</span>,<span class="string">"EnumIAT User32.dll MessageBoxA false;"</span>,<span class="string">"没有Hook"</span>,MB_OK);</span><br><span class="line"><span class="keyword">return</span> getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></div>

<p><span style="color: #000000; font-size: x-small;"><span style="font-family: Verdana;">上面的代码修改一下随可用于全局HOOK，但我不看好IAT HOOK，虽然<span style="font-family: Verdana;">WINDOWS核心编程</span>看好这种做法。因为现在主流操作系统是XP和WINDOWS2003，都是数据执行保护（也可能某个补丁前没有这个功能），它们会保护多数进程在内在中不被修改，所以IAT全局HOOK会被系统拦截从而失败，但也同时发现它能保护进程却不保护模块，因此用INLINE HOOK可能会更可行些。但IAT的原理和思想仍值得进一步学习。</span></span></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/10/Writefile与SetFilePointer函数的使用/" itemprop="url">
                Writefile与SetFilePointer函数的使用
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-10T15:05:50+08:00" content="2012-04-10">
            2012-04-10
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>尝试着在磁盘中修改PE文件。用到writefile和SetFilePointer这两个函数</p>
<p>下面先来看看这两个函数：</p>
<p>&nbsp;</p>
<h3 id="Syntax">Syntax</h3><div><br><div><br><div id="CodeSnippetContainerCode_9dc9e9ae-75e0-44ce-950a-ebefc039620b" dir="ltr"><br><div><br><figure class="highlight"><figcaption><span>WINAPI SetFilePointer(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  __in         HANDLE hFile,&#10;  __in         LONG lDistanceToMove,&#10;  __inout_opt  PLONG lpDistanceToMoveHigh,&#10;  __in         DWORD dwMoveMethod&#10;);</span><br></pre></td></tr></table></figure><br><br></div><br></div><br></div><br></div>

<h3 id="Parameters">Parameters</h3><dl><br><dt>hFile [in]</dt><br><dd>A handle to the file.The file handle must be created with the GENERIC_READ or GENERIC_WRITE access right. For more information, see <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364399(v=vs.85" target="_blank" rel="external">File Security and Access Rights</a>.aspx).</dd><br><dt>lDistanceToMove [in]</dt><br><dd>The low order 32-bits of a signed value that specifies the number of bytes to move the file pointer.If lpDistanceToMoveHigh is not NULL, lpDistanceToMoveHigh andlDistanceToMove form a single 64-bit signed value that specifies the distance to move.If lpDistanceToMoveHigh is NULL, lDistanceToMove is a 32-bit signed value. A positive value forlDistanceToMove moves the file pointer forward in the file, and a negative value moves the file pointer back.<p></p><br></dd><br><dt>lpDistanceToMoveHigh [in, out, optional]</dt><br><dd>A pointer to the high order 32-bits of the signed 64-bit distance to move.If you do not need the high order 32-bits, this pointer must be set to NULL.When not NULL, this parameter also receives the high order DWORD of the new value of the file pointer. For more information, see the Remarks section in this topic.<p></p><br></dd><br><dt>dwMoveMethod [in]</dt><br><dd>The starting point for the file pointer move.This parameter can be one of the following values.<p></p><br><table><br><tbody><br><tr><br><th>Value</th><br><th>Meaning</th><br></tr><br><tr><br><td><br><dl><br><dt>FILE_BEGIN</dt><br><dt>0</dt><br></dl><br></td><br><td>The starting point is zero or the beginning of the file.</td><br></tr><br><tr><br><td><br><dl><br><dt>FILE_CURRENT</dt><br><dt>1</dt><br></dl><br></td><br><td>The starting point is the current value of the file pointer.</td><br></tr><br><tr><br><td><br><dl><br><dt>FILE_END</dt><br><dt>2</dt><br></dl><br></td><br><td>The starting point is the current end-of-file position.</td><br></tr><br></tbody><br></table><br></dd><br></dl>

<p>这个函数跟c语言里面的fseek函数类似，是利用偏移量确定文件指针的位置。一般我们在第二个参数 lDistanceToMove设置偏移量，如果偏移量不够，大于32位，我们可以用第三个参数设置64位高字节，这样第二个参数和第三个参数同时组成64位的偏移量。具体方法大家可以参考下面这个博客：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">```</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;### Syntax&#10;&#10;&#60;div&#62;&#10;&#60;div&#62;&#60;/div&#62;&#10;&#60;div&#62;&#10;&#60;div&#62;&#60;/div&#62;&#10;&#60;div id=&#34;CodeSnippetContainerCode_6d3d6ee3-114c-4d26-8561-be67fd365c5d&#34; dir=&#34;ltr&#34;&#62;&#10;&#60;div&#62;&#10;```BOOL WINAPI WriteFile(&#10;  __in         HANDLE hFile,&#10;  __in         LPCVOID lpBuffer,&#10;  __in         DWORD nNumberOfBytesToWrite,&#10;  __out_opt    LPDWORD lpNumberOfBytesWritten,&#10;  __inout_opt  LPOVERLAPPED lpOverlapped&#10;);</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Parameters-1">Parameters</h3><dl><br><dt>hFile [in]</dt><br><dd>A handle to the file or I/O device (for example, a file, file stream, physical disk, volume, console buffer, tape drive, socket, communications resource, mailslot, or pipe).The hFile parameter must have been created with the write access. For more information, see <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa446632(v=vs.85" target="_blank" rel="external">Generic Access Rights</a>.aspx) and <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364399(v=vs.85" target="_blank" rel="external">File Security and Access Rights</a>.aspx).For asynchronous write operations, hFile can be any handle opened with the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85" target="_blank" rel="external">CreateFile</a>.aspx) function using the FILE_FLAG_OVERLAPPED flag or a socket handle returned by the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms740506(v=vs.85" target="_blank" rel="external">socket</a>.aspx) or <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms737526(v=vs.85" target="_blank" rel="external">accept</a>.aspx) function.<p></p><br></dd><br><dt>lpBuffer [in]</dt><br><dd>A pointer to the buffer containing the data to be written to the file or device.This buffer must remain valid for the duration of the write operation. The caller must not use this buffer until the write operation is completed.</dd><br><dt>nNumberOfBytesToWrite [in]</dt><br><dd>The number of bytes to be written to the file or device.A value of zero specifies a null write operation. The behavior of a null write operation depends on the underlying file system or communications technology.<p></p><br>&gt; <div>Windows Server 2003 and Windows XP: Pipe write operations across a network are limited in size per write. The amount varies per platform. For x86 platforms it&#8217;s 63.97 MB. For x64 platforms it&#8217;s 31.97 MB. For Itanium it&#8217;s 63.95 MB. For more information regarding pipes, see the Remarks section.</div><br></dd><br><dt>lpNumberOfBytesWritten [out, optional]</dt><br><dd>A pointer to the variable that receives the number of bytes written when using a synchronous hFile parameter. WriteFile sets this value to zero before doing any work or error checking. Use NULL for this parameter if this is an asynchronous operation to avoid potentially erroneous results.This parameter can be NULL only when the lpOverlapped parameter is not NULL.For more information, see the Remarks section.<p></p><br></dd><br><dt>lpOverlapped [in, out, optional]</dt><br><dd>A pointer to an <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684342(v=vs.85" target="_blank" rel="external">OVERLAPPED</a>.aspx)structure is required if the hFile parameter was opened with FILE_FLAG_OVERLAPPED, otherwise this parameter can be NULL.For an hFile that supports byte offsets, if you use this parameter you must specify a byte offset at which to start writing to the file or device. This offset is specified by setting the Offset and OffsetHigh members of the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684342(v=vs.85" target="_blank" rel="external">OVERLAPPED</a>.aspx)structure. For an hFile that does not support byte offsets, Offset and OffsetHigh are ignored.To write to the end of file, specify both the Offset and OffsetHigh members of the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684342(v=vs.85" target="_blank" rel="external">OVERLAPPED</a>.aspx) structure as 0xFFFFFFFF. This is functionally equivalent to previously calling the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85" target="_blank" rel="external">CreateFile</a>.aspx) function to open hFile using FILE_APPEND_DATA access.<p></p><br><br>For more information about different combinations of lpOverlapped and FILE_FLAG_OVERLAPPED, see the Remarks section and the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365747(v=vs.85" target="_blank" rel="external">Synchronization and File Position</a>.aspx#synchronization_and_file_position) section.<br><br></dd><br></dl>

<p>自己的英语不好，一开始的时候一直不能理解最后两个参数的用法。</p>
<p>要了解最后两个参数。我们首先了解下异步和同步的概念。</p>
<p>这里讲的异步和同步的概念是狭义的，只是针对这个函数而言。</p>
<p>如果我们把最后一个参数lpOverlapped 设置为NULL，也就是同步的，那么就是等待数据写入内存完毕以后函数才返回。</p>
<p>如果我们把最后一个参数设置为FILE_FLAG_OVERLAPPED，那么首先必须在createfile函数里面标明异步操作 FILE_APPEND_DATA 这个属性</p>
<p>如果是异步操作，那么函数不会等待数据写入到内存中才继续执行，而是不管有没有写入都继续执行。这也就是所谓的异步，也就是多线程的处理。</p>
<p>我们一般的操作是不用异步操作的，所以直接设置最后一个参数是NULL。</p>
<p>然后倒数第二个参数的作用是什么呢？</p>
<p>lpNumberOfBytesWritten</p>
<p>这个参数的作用就是如果成功的写入了，那么写入内存的数据大小就会保存到这个指针所指向的变量里面。</p>
<p>如果我们设置了最后一个参数是NULL，也就是说我们使用的是同步操作，那么必须设置这个值。</p>
<p>如果我们设置最后一个参数是FILE_FLAG_OVERLAPPED，那么可以设置这个参数是NULL</p>
<p>自己有讲的不明白的地方，大家也可以参考下面这个博客：</p>
<p><a href="http://www.cppblog.com/SpringSnow/archive/2009/02/09/73334.html" target="_blank" rel="external">http://www.cppblog.com/SpringSnow/archive/2009/02/09/73334.html</a></p>
<p>``````</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/04/09/对于参加信息安全全国邀请赛课题选择的一些看法/" itemprop="url">
                对于参加信息安全全国邀请赛课题选择的一些看法
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-04-09T22:37:21+08:00" content="2012-04-09">
            2012-04-09
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>自己最近跟着老师和学长一起参加了一个信息安全的全国邀请赛。我们目前在做的课题是下面这个课题：</p>
<p><strong>基于人机特征的透明文件保护系统</strong></p>
<p>这个课题看起来好像很牛，其实核心的技术东西都已经是别人已经做过的东西了。</p>
<p>比如对于PE文件的分析的相关技术，安卓手机端的指纹验证等等。</p>
<p>我们做课题参加比赛应该也是可以算的上是一次<strong>发明创新</strong>了。</p>
<p>那么我们现在做的发明只能说是<strong>改进性发明</strong>了。因为技术上的东西都是现成的有资料可以找到的。如果说想要<strong>原创技术</strong>，那么恐怕难度会比较大。</p>
<p>而改进性的发明最重要的就是下面这两点：</p>
<p><span style="text-decoration: underline;"><strong>创新性和实用性。</strong></span></p>
<p>老师让我们看了一下以往几届的人家比赛的项目，发现我们现在正在做的东西基本上人家在10年的时候已经做过了,有些甚至是一模一样的。</p>
<p>那么既然是改进性的发明，说的难听点是加个包装（当然我们也不能否认项目的技术含量）。</p>
<p>问题就是如何加包装。</p>
<p>我自己的技术当然还不是很厉害，但是像醒哥说的，如果你想做个很有创意的东西，首先你不要被技术所局限。<strong>因为当你被技术所局限的时候，很多创意就会因为你自己以为的技术上的无法达到而被扼杀。</strong></p>
<p>我自己找了下面两个例子：</p>
<p>第一个例子是关于创新性方面的：</p>
<p><span style="color: #3366ff;"><strong>再见了，用户名和密码</strong></span></p>
<p>还在为登录各大网站要输入用户名和密码而烦恼？还在担心自己用户名、密码，以及支付账号等私人信息泄漏？OneID试图为你创建一个多设备的验证系统，从而一劳永逸的解决这些问题。</p>
<p>基于一种高级的非对称密码学原理，<a href="http://www.oneid.com/" target="_blank" rel="external">OneID</a>可以在电脑、手机和平板电脑等多个设备终端上验证用户身份。这些设备一起工作保证了用户的私人信息安全。</p>
<p><a href="http://tech2ipo.com/47152/" target="_blank" rel="external">http://tech2ipo.com/47152/</a></p>
<p>这个是OneID的官网，目前好像还处在公测中:</p>
<p><a href="http://www.oneid.com/" target="_blank" rel="external">http://www.oneid.com/</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>第二个例子是关于实用性方面的：</p>
<h1 id="由拖库攻击谈口令字段的加密策略"><span style="color: #3366ff; font-size: x-small;">由拖库攻击谈口令字段的加密策略</span></h1><p>这个是这篇博客的地址</p>
<h3 id="加“一粒盐”"><span style="color: #339966;">加“一粒盐”</span></h3><p></p>
<h3 id="一人一密"><span style="color: #339966;">一人一密</span></h3><h3 id="一站一密"><span style="color: #339966;">一站一密</span></h3><p><a href="http://www.fishc.com/a/bianchengjiqiao/heike/1135.html" target="_blank" rel="external">http://www.fishc.com/a/bianchengjiqiao/heike/1135.html</a></p>
<p>下面这个是google上面的<span style="color: #339966;">安天密码混合器</span>的介绍页面</p>
<div id="pname"><a href="http://code.google.com/p/password-mixer/" target="_blank" rel="external">password-mixer</a></div><br><div id="psum"><a href="http://code.google.com/p/password-mixer/" target="_blank" rel="external">Antiy Password Mixer &#8211; 用于WEB站点密码存放的安全算法应用范例</a><p></p><br><br>然后自己只是从课题上面想了些东西，不知道大家对我的这些想法有什么看法，有什么意见和建议希望大家指正，谢谢。<br></div></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/15/">&laquo;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/17/">&raquo;</a>
  </nav>


            </div>

            

            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/about me.JPG" alt="Miibotree" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Miibotree</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">211</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">111</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Miibotree</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  

  



  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>



<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



  
  

  







<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
