<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>




  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Miibotree'thinking">
<meta property="og:url" content="http://yoursite.com/page/14/index.html">
<meta property="og:site_name" content="Miibotree'thinking">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Miibotree'thinking">
<meta name="twitter:description">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

    <title> Miibotree'thinking </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->




<div class="container one-column 
   page-home 
">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Miibotree'thinking</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-about"></i> <br />
            关于
          </a>
        </li>
      
    </ul>
  

  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/25/关于-预编译头/" itemprop="url">
                关于 预编译头
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-25T22:31:39+08:00" content="2012-06-25">
            2012-06-25
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><div></div>

<p>今天在做工程的时候没有理解预编译头的概念，导致出现了</p>
<p>什么是预编译头？</p>
<p>如何使用预编译头？</p>
<p><a href="http://blog.csdn.net/gouki04/article/details/6219822" target="_blank" rel="external">http://blog.csdn.net/gouki04/article/details/6219822</a></p>
<p><a href="http://hi.baidu.com/gamedot/item/324631427f21c912886d10d1" target="_blank" rel="external">http://hi.baidu.com/gamedot/item/324631427f21c912886d10d1</a></p>
<p><a href="http://www.cppblog.com/robinson119/archive/2007/04/26/22873.html" target="_blank" rel="external">http://www.cppblog.com/robinson119/archive/2007/04/26/22873.html</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>: ค้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/25/给VC应用程序换皮肤的几种方法/" itemprop="url">
                给VC应用程序换皮肤的几种方法
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-25T22:17:17+08:00" content="2012-06-25">
            2012-06-25
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>这几天想给我们的主界面换好看一点的皮肤。下面介绍三种可能实现的方法：</p>
<p>1.使用Skin++</p>
<p>Skin++，系统软件，采用独特的软件界面开发技术，让原本复杂繁琐的界面编程变得轻松自如，随着换肤技术的不断进步，Skin++不仅是功能强大的换 肤控件，而且是一款非常通用的换肤插件。只需要在您的程序中添加一句代码，Skin++就能让您的界面焕然一新，并拥有多种主题风格和色调的动态切换功 能。</p>
<p><a href="http://miibotree.com/wp-content/uploads/2012/06/QQ截图20120625220004.png" target="_blank" rel="external"><img src="http://miibotree.com/wp-content/uploads/2012/06/QQ截图20120625220004.png" alt="" title="QQ截图20120625220004"></a></p>
<p>2.使用SkinSharp</p>
<p>据说skinsharp的作者本来想进Skin++公司，结果人家不让进。所以那作者顿时火了，花了几年时间一个人写出了SkinSharp。作者自己陈述说自己花了两年的时间来研究滚动条。做出来的效果跟Skin++有的一拼。</p>
<p><a href="http://miibotree.com/wp-content/uploads/2012/06/QQ截图20120625220846.png" target="_blank" rel="external"><img src="http://miibotree.com/wp-content/uploads/2012/06/QQ截图20120625220846.png" alt="" title="QQ截图20120625220846"></a></p>
<p>他们的基本原理是差不多的，都是Hook WM_PAINT等消息。</p>
<p>3.使用Html的MFC模版框架</p>
<p>MFC可以加载DHTML，也就是说可以直接引用html css 和js代码。虽然这种方法支持动态的js，但是使用起来比较复杂。</p>
<p><a href="http://miibotree.com/wp-content/uploads/2012/06/QQ截图20120625221455.png" target="_blank" rel="external"><img src="http://miibotree.com/wp-content/uploads/2012/06/QQ截图20120625221455.png" alt="" title="QQ截图20120625221455"></a></p>
<p>html与windows之间用映射来实现。</p>
<p>必须学习CDHtmlDlg类的实现。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/20/艺术气息。。。。/" itemprop="url">
                艺术气息。。。。
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-20T19:24:36+08:00" content="2012-06-20">
            2012-06-20
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>要做一个软件的界面，去图书馆借了很多关于软件人机交互界面设计方面的书本。。。</p>
<p>纯粹欣赏艺术。。。</p>
<p>找到下面几个网站。</p>
<p><a href="http://delicious.com" target="_blank" rel="external">http://delicious.com</a></p>
<p><a href="http://www.wordle.net" target="_blank" rel="external">http://www.wordle.net</a></p>
<p>wordle貌似必须要用代理才能创造自己的图片。</p>
<p>开启代理，自己随便搞了张图片，它使用java生成的，下面两个我自己搞的链接只有用代理浏览才能看的到。</p>
<p><a href="http://www.wordle.net/show/wrdl/5448899/SDKprogram" target="_blank" rel="external">http://www.wordle.net/show/wrdl/5448899/SDKprogram</a></p>
<p><a href="http://miibotree.com/wp-content/uploads/2012/06/miibotreepic.png" target="_blank" rel="external"><img src="http://miibotree.com/wp-content/uploads/2012/06/miibotreepic.png" alt="" title="miibotreepic"></a></p>
<p><a href="http://miibotree.com/wp-content/uploads/2012/06/SDKpic.png" target="_blank" rel="external"><img src="http://miibotree.com/wp-content/uploads/2012/06/SDKpic.png" alt="" title="SDKpic"></a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/17/C服务端与java客户端的socket通信注意事项/" itemprop="url">
                C服务端与java客户端的socket通信注意事项
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-17T22:08:35+08:00" content="2012-06-17">
            2012-06-17
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>今天这个项目需要c服务端与java客户端进行socket通信。</p>
<p>中间遇到了很多问题。</p>
<p>首先搜索了一下</p>
<p><a href="http://blog.sina.com.cn/s/blog_55934df80100i55l.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_55934df80100i55l.html</a></p>
<p>有以下几点要注意的地方：</p>
<p>1.大端与小端的转换。具体可以参看这个博客<a href="http://www.cnblogs.com/AilsaDream/archive/2009/06/04/1496326.html" target="_blank" rel="external">http://www.cnblogs.com/AilsaDream/archive/2009/06/04/1496326.html</a></p>
<p>我的客户端是用c写的，属于小端模式，而TCP和java都是大端模式。所以服务器端在发送int  WORD  或者是double等数据类型的时候必须先将小端转换成大端模式，而在接受到数据以后必须将这些类型再重新转换成小端模式。具体转换可以看下面这个列表。</p>
<p><span style="font-size: x-small;">¨          #define ntohs(n)     //16位数据类型网络字节顺序到主机字节顺序的转换</span></p>
<p><span style="font-size: x-small;">¨          #define htons(n)     //16位数据类型主机字节顺序到网络字节顺序的转换</span></p>
<p><span style="font-size: x-small;">¨          #define ntohl(n)      //32位数据类型网络字节顺序到主机字节顺序的转换</span></p>
<p><span style="font-size: x-small;">¨          #define htonl(n)      //32位数据类型主机字节顺序到网络字节顺序的转换</span></p>
<p>&nbsp;</p>
<p>2.结构体对齐。具体可以参看这个博客<a href="http://blog.csdn.net/linphusen/article/details/6385211" target="_blank" rel="external">http://blog.csdn.net/linphusen/article/details/6385211</a></p>
<p><a href="http://blog.sina.com.cn/s/blog_74a271040100u15p.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_74a271040100u15p.html</a></p>
<figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">My_Send_Chinese</span></span>&#123;</span><br><span class="line"><span class="built_in">byte</span> Type;</span><br><span class="line">WORD size;</span><br><span class="line">char data[<span class="number">4</span>];</span><br><span class="line">&#125;Send_Chinese;</span><br></pre></td></tr></table></figure>
<p>我遇到的问题是这样的。当我在发送数据的时候，我定义了成员Type = 0x 41通过抓包工具发现Type发送过去的数据是0x 41 cc</p>
<p>导致java端接收的时候出错。那么这里为什么会出现一个多出来的cc 呢？</p>
<p>这是结构体对齐所导致的。具体大家可以看上面那个链接。</p>
<p><span style="font-family: 宋体;">先让我们看四个重要的基本概念：</span></p>
<p><span style="font-family: 宋体;">1.</span><span style="font-family: 宋体;">数据类型自身的对齐值：对于char型数据，其自身对齐值为1，对于short型为2，对于int,float,double类型，其自身对齐值为4，单位字节。</span></p>
<p><span style="font-family: 宋体;">2.</span><span style="font-family: 宋体;">结构体或者类的自身对齐值：其成员中自身对齐值最大的那个值。</span></p>
<p><span style="font-family: 宋体;">3.</span><span style="font-family: 宋体;">指定对齐值：#pragma pack (value)时的指定对齐值value。</span></p>
<p><span style="font-family: 宋体;">4.</span><span style="font-family: 宋体;">数据成员、结构体和类的有效对齐值：自身对齐值和指定对齐值中小的那个值。</span></p>
<p>解决的办法是添加下面这句：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> pack (1)</span></span><br></pre></td></tr></table></figure>
<p>理由就是上面的4条重要规则。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/16/利用CreateProcess创建子进程，WaitForSingleObject函数判断进程是否结束/" itemprop="url">
                利用CreateProcess创建子进程，WaitForSingleObject函数判断进程是否结束
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-16T21:36:26+08:00" content="2012-06-16">
            2012-06-16
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>接着上几天的那个问题。</p>
<p>以前都是用WinExec或者是system函数创建的子进程，这次用CreateProcess来获得它的句柄。</p>
<p>CreateProcess函数。这个函数有10个参数。汗~~~~。其实我们主要用到的就是第一个参数，第二个参数，还有最后一个参数。</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOL WINAPI CreateProcess(</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span><span class="number">_</span>opt     LPCTSTR lpApplicationName,</span><br><span class="line">  <span class="number">__</span>inout<span class="number">_</span>opt  LPTSTR lpCommandLine,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span><span class="number">_</span>opt     LPSECURITY<span class="number">_</span>ATTRIBUTES lpProcessAttributes,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span><span class="number">_</span>opt     LPSECURITY<span class="number">_</span>ATTRIBUTES lpThreadAttributes,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span>         BOOL bInheritHandles,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span>         DWORD dwCreationFlags,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span><span class="number">_</span>opt     LPVOID lpEnvironment,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span><span class="number">_</span>opt     LPCTSTR lpCurrentDirectory,</span><br><span class="line">  <span class="number">__</span><span class="keyword">in</span>         LPSTARTUPINFO lpStartupInfo,</span><br><span class="line">  <span class="number">__</span><span class="keyword">out</span>        LPPROCESS<span class="number">_</span>INFORMATION lpProcessInformation</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>第一个参数是要打开的应用程序的路径，第二个参数是命令行参数。最后一个参数是用来返回新创建的进程的句柄。</p>
<p>自己仔细看了一下《windows核心编程》这本书。但是不怎么看的懂。。。因为毕竟10个参数要全部看懂的话就比较困难的。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">HANDLE OpenNewFile(LPSTR NewFilePath)</span><br><span class="line">&#123;</span><br><span class="line">	STARTUPINFOA si = &#123; <span class="keyword">sizeof</span>(si) &#125;;  </span><br><span class="line">	SECURITY_ATTRIBUTES saProcess, saThread;  </span><br><span class="line">	PROCESS_INFORMATION piProcess;  </span><br><span class="line"></span><br><span class="line">	saProcess<span class="variable">.nLength</span> = <span class="keyword">sizeof</span>(saProcess);  </span><br><span class="line">	saProcess<span class="variable">.lpSecurityDescriptor</span> = <span class="literal">NULL</span>;  </span><br><span class="line">	saProcess<span class="variable">.bInheritHandle</span> = <span class="literal">TRUE</span>;  </span><br><span class="line"></span><br><span class="line">	saThread<span class="variable">.nLength</span> = <span class="keyword">sizeof</span>(saThread);  </span><br><span class="line">	saThread<span class="variable">.lpSecurityDescriptor</span> = <span class="literal">NULL</span>;  </span><br><span class="line">	saThread<span class="variable">.bInheritHandle</span> = <span class="literal">FALSE</span>;  </span><br><span class="line"></span><br><span class="line">	CHAR Command[<span class="number">100</span>];</span><br><span class="line">	strcpy(Command, <span class="string">"notepad.exe "</span>);</span><br><span class="line">	strcat(Command, NewFilePath);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">BOOL</span>   fRet =CreateProcessA(<span class="string">"C:\WINDOWS\SYSTEM32\NOTEPAD.EXE"</span>,</span><br><span class="line">		Command,  <span class="literal">NULL</span>,   <span class="literal">NULL</span>,   <span class="literal">FALSE</span>,   <span class="literal">NULL</span>,   <span class="literal">NULL</span>,   <span class="literal">NULL</span>,  &amp;<span class="preprocessor">#038;si, &amp;#038;piProcess);   </span></span><br><span class="line">	<span class="keyword">if</span>(fRet == <span class="literal">TRUE</span>)   </span><br><span class="line">		<span class="keyword">return</span>(piProcess<span class="variable">.hProcess</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这段代码的前面初始化部分是copy《windows核心编程》的。参数LPSTR NewFilePath 是文件的路径名称。</p>
<p>然后这个函数返回一个新创建的进程的句柄</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HRes = OpenNewFile<span class="list">(<span class="keyword">NewFilePath</span>)</span><span class="comment">;// 获得创建新进程打开notepad文件的句柄</span></span><br><span class="line"></span><br><span class="line">WaitForSingleObject<span class="list">(<span class="keyword">HRes</span>, INFINITE)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>下面是WaitForSingleObject这个函数原型：</p>
<p>DWORD WINAPI WaitForSingleObject(</p>
<p>　　__in HANDLE hHandle,</p>
<p>　　__in DWORD dwMilliseconds</p>
<p>　　);</p>
<p>这个函数很简单，第一个参数就是句柄，第二个参数是等待多少时间（以毫秒计算）。这样就达到了阻塞的效果。</p>
<p>如果是INFNITE,就是等到进程终止的时候才进行下面的代码，否则就一直阻塞等待。</p>
<p>这样一来问题就很好的解决了。</p>
<p>如果是直接用notepad打开某个文件，怎么知道它关闭了呢？其实思路应该还是跟上面的一样，就是首先获得这个进程的句柄，判断这个句柄是否存在，如果不存在，那么应该就是结束了。</p>
<p>接下来再来解决上篇博客里写的那个问题。我首先用notepad文件打开一个.txt文件。然后再用CreateFile打开这个文件，并且设置第三个参数为0，就是设置共享模式为不共享，这个时候使用CreateFile能打开文件并且获得一个句柄，这就说明这个时候notepad程序已经关闭了.txt文件。</p>
<p>不知道自己讲的对不对，有什么错误还恳请大家指正。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/14/如何判断一个文件是否被关闭？/" itemprop="url">
                如何判断一个文件是否被关闭？
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-14T22:18:38+08:00" content="2012-06-14">
            2012-06-14
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>做项目的时候遇到了下面这个问题：如何判断一个打开的txt文件是否被关闭？</p>
<p>在打开一个txt文件的时候，notepad程序是自动通过文件路径的参数首先复制文件，然后马上就关闭了文件通道，这个时候打开的其实只是notepad程序而不是文件本身。文件本身的打开与关闭是一瞬间的事情。也就是说notepad程序在读取了文件以后就马上将文件关闭了。</p>
<p>那么我们判断一个txt文件是否被关闭其实就是判断这个notepad这个进程是否关闭。</p>
<p>所以一开始自己想是不是要判断进程是否被关闭。这样一来还得遍历进程判断notepad程序&#8230;而且进程名称全部都是notepad, 难道还要通过获取进程ID的方法吗？。。。。</p>
<p>这个方式似乎比较复杂，然后自己百度了一把看看还有没有什么更好的办法。</p>
<p>最后找到了下面这个方法：</p>
<p><a href="http://topic.csdn.net/t/20030804/05/2104986.html" target="_blank" rel="external">http://topic.csdn.net/t/20030804/05/2104986.html</a></p>
<p>利用Windows API判断文件共享锁定状态</p>
<blockquote>
<p>锁是操作系统为实现数据共享而提供的一种安全机制，它使得不同的应用程序，不同的计算机之间可以安全有效地共享和交换数据。要保证安全有效地操作共享数据，必须在相应的操作前判断锁的类型，然后才能确定数据是否可读或可写，从而为开发出健壮的程序提供切实依据。</p>
<p>同样，在Windows中，文件可以共享模式打开，它也涉及到锁的操作问题。根据Windows中文件共享时加锁范围的大小，锁可分为全局锁和局部锁；全局锁以锁定文件全部内容为特征，而局部锁以锁定文件的局部内容为特征，且文件的锁定区域不可重复。根据Windows中文件共享时锁的操作权限分类，锁可分为：读锁，写锁，读写锁（可读可写，全局锁）。</p>
<p>利用上述文件中锁的区域不可重复的特性，我们可尝试给指定文件加一全局锁。若加锁成功，说明指定文件未被其它进程锁定；否则，说明有其它进程锁定了该文件。这里，我们利用两个Windows Api文件操作函数：OpenFile和CreateFile来实现锁定状态的判断。</p>
</blockquote>
<p>具体对CreateFile的第三个参数的共享模式认识还不是很深刻。。。回头再好好看看windows核心编程。。。</p>
<p>&nbsp;</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/13/自动获取U盘文件/" itemprop="url">
                自动获取U盘文件
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-13T21:59:43+08:00" content="2012-06-13">
            2012-06-13
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>期末考试终于全部考完了，终于开始写代码了。</p>
<p>这几天先解决一下这个历史遗留问题。问题是这样的：PC 端自动获取USB设备盘符并且读取特定文件夹下面的文件。</p>
<p>首先找到下面这些资料来参考：</p>
<p>如何获得U盘盘符：</p>
<p><a href="http://topic.csdn.net/u/20081118/14/dc0ab5bd-3a1d-4868-bb1e-4ff638fc82c2.html" target="_blank" rel="external">http://topic.csdn.net/u/20081118/14/dc0ab5bd-3a1d-4868-bb1e-4ff638fc82c2.html</a></p>
<p><a href="http://hi.baidu.com/harry945/blog/item/7905377f5b40490229388a2a.html" target="_blank" rel="external">http://hi.baidu.com/harry945/blog/item/7905377f5b40490229388a2a.html</a></p>
<p><a href="http://www.doc88.com/p-941579862185.html" target="_blank" rel="external">http://www.doc88.com/p-941579862185.html</a></p>
<p><a href="http://msdn.microsoft.com/en-us/library/aa363480%28VS.85%29.aspx" target="_blank" rel="external">http://msdn.microsoft.com/en-us/library/aa363480%28VS.85%29.aspx</a></p>
<p>方法有很多。这里介绍一下一个比较简单的方法：</p>
<p>首先是捕捉WM_DEVICECHANGE消息：</p>
<p>DBT_DEVICEARRIVAL表示有新的移动设备进入。</p>
<p>找到了下面这段c++代码如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以找usb设备为例,取得的usb盘符放在UsbRoot里面，len为UsbRoot字符数组的长度</span></span><br><span class="line">BOOL GetUsbRoot(<span class="keyword">CHAR</span>* UsbRoot,<span class="keyword">SHORT</span> len)</span><br><span class="line">&#123;</span><br><span class="line">DWORD dwDriveStrLen = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">CHAR</span> *pDriveName = <span class="keyword">NULL</span>;</span><br><span class="line">UINT Drive = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (UsbRoot == <span class="keyword">NULL</span> || len &amp;lt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">&#125;</span><br><span class="line">dwDriveStrLen = ::GetLogicalDriveStrings(<span class="number">0</span>,<span class="keyword">NULL</span>);<span class="comment">//取得你计算机上盘符数目</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> == dwDriveStrLen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">CHAR</span> *szDriveNameBuff = (<span class="keyword">CHAR</span>*)malloc(dwDriveStrLen);<span class="comment">//根据你机器上的磁盘数目分配内存</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">NULL</span> == szDriveNameBuff)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">&#125;</span><br><span class="line">memset(szDriveNameBuff,<span class="number">0</span>,sizeof(szDriveNameBuff));</span><br><span class="line">::GetLogicalDriveStrings(dwDriveStrLen,szDriveNameBuff);<span class="comment">//取得你计算机上所有盘符</span></span><br><span class="line">pDriveName = szDriveNameBuff;</span><br><span class="line"><span class="keyword">while</span> (*pDriveName != <span class="keyword">NULL</span>)<span class="comment">//遍历所有盘符，找到你需要的设备</span></span><br><span class="line">&#123;</span><br><span class="line">Drive = ::GetDriveType(pDriveName);</span><br><span class="line"><span class="keyword">switch</span> (Drive)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> DRIVE_UNKNOWN:<span class="comment">//未知设备</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DRIVE_NO_ROOT_DIR:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DRIVE_REMOVABLE:<span class="comment">//usb设备</span></span><br><span class="line"><span class="comment">//如果为usb，在这里进行相关处理</span></span><br><span class="line"><span class="comment">//break;</span></span><br><span class="line"><span class="keyword">case</span> DRIVE_FIXED:<span class="comment">//硬盘</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DRIVE_REMOTE:<span class="comment">//网络硬盘,如：局域网服务器上的盘</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DRIVE_CDROM:<span class="comment">//光驱</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DRIVE_RAMDISK:<span class="comment">//RAM 盘</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">pDriveName += strlen(pDriveName) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (szDriveNameBuff != <span class="keyword">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">free(szDriveNameBuff);</span><br><span class="line">szDriveNameBuff = <span class="keyword">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是自己的实现方法，当U盘设备插入的时候隐藏并且自动读取所有文件到指定的文件夹下面：</p>
<p>（一）</p>
<p>首先是捕捉WM_DEVICECHANGE消息：</p>
<p>DBT_DEVICEARRIVAL表示有新的移动设备进入。</p>
<p>（二）</p>
<p>GetLogicalDriveStrings 获得所有盘符，然后挨个判断是不是可移动设备。</p>
<p>（三）</p>
<p>复制USB文件到自己电脑上。这里有些不完善。。</p>
<p>（四）</p>
<p>设置窗口隐藏。在D盘创建一个文件夹CopyFromUSB。当文件复制完成以后自动关闭程序</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">/*------------------------------------------------------------</span><br><span class="line">   自动读取USB设备指定文件</span><br><span class="line">   作者:Miibotree</span><br><span class="line">  ------------------------------------------------------------*/</span><br><span class="line"></span><br><span class="line">#include &amp;lt<span class="comment">;windows.h&amp;gt;</span></span><br><span class="line">#include &amp;lt<span class="comment">;Dbt.h&amp;gt;</span></span><br><span class="line">#include &amp;lt<span class="comment">;WinBase.h&amp;gt;</span></span><br><span class="line"></span><br><span class="line">LRESULT CALLBACK WndProc (HWND, UINT, WPARAM, LPARAM) <span class="comment">;</span></span><br><span class="line">int SearchDrive()<span class="comment">;</span></span><br><span class="line">int ReadUSBFile(LPCWSTR lpFileName)<span class="comment">;</span></span><br><span class="line">int SearchAllFile(LPWSTR lpSource, LPWSTR lpDest)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">int WINAPI WinMain (HINSTANCE hInstance, HINSTANCE hPrevInstance,</span><br><span class="line">                    PSTR szCmdLine, int iCmdShow)</span><br><span class="line">&#123;</span><br><span class="line">     static TCHAR szAppName[] = TEXT (&amp;quot<span class="comment">;HelloWin&amp;quot;) ;</span></span><br><span class="line">     HWND         hwnd <span class="comment">;</span></span><br><span class="line">     MSG          msg <span class="comment">;</span></span><br><span class="line">     WNDCLASS     wndclass <span class="comment">;</span></span><br><span class="line"></span><br><span class="line">     wndclass.style         = CS_HREDRAW | CS_VREDRAW <span class="comment">;</span></span><br><span class="line">     wndclass.lpfnWndProc   = WndProc <span class="comment">;</span></span><br><span class="line">     wndclass.cbClsExtra    = 0 <span class="comment">;</span></span><br><span class="line">     wndclass.cbWndExtra    = 0 <span class="comment">;</span></span><br><span class="line">     wndclass.hInstance     = hInstance <span class="comment">;</span></span><br><span class="line">     wndclass.hIcon         = LoadIcon (NULL, IDI_APPLICATION) <span class="comment">;</span></span><br><span class="line">     wndclass.hCursor       = LoadCursor (NULL, IDC_ARROW) <span class="comment">;</span></span><br><span class="line">     wndclass.hbrBackground = (HBRUSH) GetStockObject (WHITE_BRUSH) <span class="comment">;</span></span><br><span class="line">     wndclass.lpszMenuName  = NULL <span class="comment">;</span></span><br><span class="line">     wndclass.lpszClassName = szAppName <span class="comment">;</span></span><br><span class="line"></span><br><span class="line">     if (!RegisterClass (&amp;amp<span class="comment">;wndclass))</span></span><br><span class="line">     &#123;</span><br><span class="line">          MessageBox (NULL, TEXT (&amp;quot<span class="comment">;This program requires Windows NT!&amp;quot;), </span></span><br><span class="line">                      szAppName, MB_ICONERROR) <span class="comment">;</span></span><br><span class="line">          return 0 <span class="comment">;</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     hwnd = CreateWindow (szAppName,                  // window class name</span><br><span class="line">                          TEXT (&amp;quot<span class="comment">;The Hello Program&amp;quot;), // window caption</span></span><br><span class="line">                          WS_OVERLAPPEDWINDOW,        // window style</span><br><span class="line">                          CW_USEDEFAULT,              // initial x position</span><br><span class="line">                          CW_USEDEFAULT,              // initial y position</span><br><span class="line">                          CW_USEDEFAULT,              // initial x size</span><br><span class="line">                          CW_USEDEFAULT,              // initial y size</span><br><span class="line">                          NULL,                       // parent window handle</span><br><span class="line">                          NULL,                       // window menu handle</span><br><span class="line">                          hInstance,                  // program instance handle</span><br><span class="line">                          NULL)<span class="comment">;                  // creation parameters</span></span><br><span class="line"></span><br><span class="line">     ShowWindow (hwnd, SW_HIDE) <span class="comment">;</span></span><br><span class="line">	 //ShowWindow (hwnd, iCmdShow) <span class="comment">;</span></span><br><span class="line">     UpdateWindow (hwnd) <span class="comment">;</span></span><br><span class="line"></span><br><span class="line">     while (GetMessage (&amp;amp<span class="comment">;msg, NULL, 0, 0))</span></span><br><span class="line">     &#123;</span><br><span class="line">          TranslateMessage (&amp;amp<span class="comment">;msg) ;</span></span><br><span class="line">          DispatchMessage (&amp;amp<span class="comment">;msg) ;</span></span><br><span class="line">     &#125;</span><br><span class="line">     return msg.wParam <span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LRESULT CALLBACK WndProc (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</span><br><span class="line">&#123;  </span><br><span class="line">	RECT rect<span class="comment">;</span></span><br><span class="line">	HDC hdc<span class="comment">;</span></span><br><span class="line">	PAINTSTRUCT ps<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">     switch (message)</span><br><span class="line">     &#123;</span><br><span class="line">     case WM_CREATE:</span><br><span class="line">          return 0 <span class="comment">;</span></span><br><span class="line"></span><br><span class="line">     case WM_PAINT:</span><br><span class="line">		  hdc = BeginPaint(hwnd, &amp;amp<span class="comment">;ps);</span></span><br><span class="line">          GetClientRect (hwnd, &amp;amp<span class="comment">;rect) ;</span></span><br><span class="line"></span><br><span class="line">          DrawText (hdc, TEXT (&amp;quot<span class="comment">;Hello, Windows 98!&amp;quot;), -1, &amp;amp;rect,</span></span><br><span class="line">                    DT_SINGLELINE | DT_CENTER | DT_VCENTER) <span class="comment">;</span></span><br><span class="line"></span><br><span class="line">          EndPaint (hwnd, &amp;amp<span class="comment">;ps) ;</span></span><br><span class="line">          return 0 <span class="comment">;</span></span><br><span class="line">	case WM_DEVICECHANGE:</span><br><span class="line">		switch (wParam)  </span><br><span class="line">		&#123;  </span><br><span class="line">		   case DBT_DEVICEARRIVAL: //设备插进来 </span><br><span class="line">		//case 	DBT_DEVTYP_DEVINST:</span><br><span class="line">				SearchDrive()<span class="comment">;</span></span><br><span class="line">				PostQuitMessage (0) <span class="comment">;</span></span><br><span class="line">				return 0<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		return 0<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">     case WM_DESTROY:</span><br><span class="line">          PostQuitMessage (0) <span class="comment">;</span></span><br><span class="line">          return 0 <span class="comment">;</span></span><br><span class="line">     &#125;</span><br><span class="line">     return DefWindowProc (hwnd, message, wParam, lParam) <span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int SearchDrive()</span><br><span class="line">&#123;</span><br><span class="line">	DWORD SectorsPerCluster<span class="comment">;</span></span><br><span class="line">	DWORD BytesPerSector<span class="comment">;</span></span><br><span class="line">	DWORD NumberOfFreeClusters<span class="comment">;</span></span><br><span class="line">	DWORD TotalNumberOfClusters<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">	UINT DriveNumber= NULL<span class="comment">;</span></span><br><span class="line">	TCHAR DriveBuffer[100]<span class="comment">;</span></span><br><span class="line">	TCHAR    *pDriveName = NULL<span class="comment">;</span></span><br><span class="line">	DWORD DriveLength = sizeof(DriveBuffer)<span class="comment">;</span></span><br><span class="line">	int iResult = GetLogicalDriveStrings(DriveLength, (LPTSTR)DriveBuffer)<span class="comment">;</span></span><br><span class="line">	if (iResult == 0)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(NULL, TEXT(&amp;quot<span class="comment">;获取盘符出错&amp;quot;), TEXT(&amp;quot;出错了&amp;quot;), MB_OK);</span></span><br><span class="line">		return 0<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriveName = DriveBuffer<span class="comment">;</span></span><br><span class="line">	while (*pDriveName != NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		DriveNumber = GetDriveType((LPCTSTR)pDriveName)<span class="comment">;</span></span><br><span class="line">		if (DriveNumber == DRIVE_REMOVABLE)</span><br><span class="line">		&#123;</span><br><span class="line">			ReadUSBFile(pDriveName)<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		 pDriveName += wcslen(pDriveName) + 1<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	return 0<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int ReadUSBFile(LPCWSTR lpFileName)</span><br><span class="line">&#123;</span><br><span class="line">	TCHAR lpDest[MAX_PATH] = L&amp;quot<span class="comment">;d:\CopyFromUSB\&amp;quot;;</span></span><br><span class="line">	CreateDirectory(lpDest, NULL)<span class="comment">;</span></span><br><span class="line">	SearchAllFile((LPWSTR)lpFileName, lpDest)<span class="comment">;</span></span><br><span class="line">	return 0<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int SearchAllFile(LPWSTR lpSource, LPWSTR lpDest)</span><br><span class="line">&#123;</span><br><span class="line">	WIN32_FIND_DATA FindFileData<span class="comment">;</span></span><br><span class="line">	HANDLE hListFile<span class="comment">;</span></span><br><span class="line">	TCHAR szFilePath[MAX_PATH] = L&amp;quot<span class="comment">; &amp;quot;;</span></span><br><span class="line">	TCHAR szFileFull[MAX_PATH]   = L&amp;quot<span class="comment">; &amp;quot;;</span></span><br><span class="line">	DWORD i = 0<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">	wcscat(szFilePath, lpSource)<span class="comment">;</span></span><br><span class="line">	wcscat(szFilePath,L&amp;quot<span class="comment">;\*.*&amp;quot;);</span></span><br><span class="line">	hListFile = FindFirstFile(szFilePath,&amp;amp<span class="comment">;FindFileData);</span></span><br><span class="line"></span><br><span class="line">	if (hListFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		return 1<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		do </span><br><span class="line">		&#123;</span><br><span class="line">			memset(szFileFull, 0, sizeof(szFileFull))<span class="comment">;</span></span><br><span class="line">			//判断隐藏的本目录. 及上级目录..</span><br><span class="line">			if (wcscmp(FindFileData.cFileName,TEXT(&amp;quot<span class="comment">;.&amp;quot;)) == 0 || wcscmp(FindFileData.cFileName,TEXT(&amp;quot;..&amp;quot;)) == 0)</span></span><br><span class="line">			&#123;</span><br><span class="line">				continue<span class="comment">;</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			wsprintf(szFileFull, L&amp;quot<span class="comment">;%s\%s&amp;quot;, lpSource, FindFileData.cFileName);</span></span><br><span class="line">			TCHAR lpDestDir[MAX_PATH]<span class="comment">;</span></span><br><span class="line">			wsprintf(lpDestDir, L&amp;quot<span class="comment">;%s\%s&amp;quot;, lpDest, FindFileData.cFileName);</span></span><br><span class="line">			CopyFile(szFileFull, lpDestDir, NULL)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">			//判断是否是文件夹</span><br><span class="line">			if (FindFileData.dwFileAttributes &amp;amp<span class="comment">; FILE_ATTRIBUTE_DIRECTORY)</span></span><br><span class="line">			&#123;</span><br><span class="line">				CreateDirectoryW(lpDestDir, NULL)<span class="comment">;</span></span><br><span class="line">				SearchAllFile(szFileFull, lpDestDir)<span class="comment">;</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; while(FindNextFile(hListFile,&amp;amp<span class="comment">;FindFileData));</span></span><br><span class="line">	&#125;</span><br><span class="line">	return 0<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/06/12/自动读取USB设备文件/" itemprop="url">
                自动读取USB设备文件
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-06-12T21:28:30+08:00" content="2012-06-12">
            2012-06-12
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>期末考试终于全部考完了，终于开始写代码了。</p>
<p>这几天先解决一下这个历史遗留问题。问题是这样的：PC 端自动获取USB设备盘符并且读取特定文件夹下面的文件。</p>
<p>首先找到下面这些资料来参考：</p>
<p>如何获得U盘盘符：</p>
<p><a href="http://topic.csdn.net/u/20081118/14/dc0ab5bd-3a1d-4868-bb1e-4ff638fc82c2.html" target="_blank" rel="external">http://topic.csdn.net/u/20081118/14/dc0ab5bd-3a1d-4868-bb1e-4ff638fc82c2.html</a></p>
<p><a href="http://hi.baidu.com/harry945/blog/item/7905377f5b40490229388a2a.html" target="_blank" rel="external">http://hi.baidu.com/harry945/blog/item/7905377f5b40490229388a2a.html</a></p>
<p><a href="http://www.doc88.com/p-941579862185.html" target="_blank" rel="external">http://www.doc88.com/p-941579862185.html</a></p>
<p><a href="http://msdn.microsoft.com/en-us/library/aa363480%28VS.85%29.aspx" target="_blank" rel="external">http://msdn.microsoft.com/en-us/library/aa363480%28VS.85%29.aspx</a></p>
<p>方法有很多。这里介绍一下一个比较简单的方法：</p>
<p>首先是捕捉WM_DEVICECHANGE消息：</p>
<p>DBT_DEVICEARRIVAL表示有新的移动设备进入。</p>
<p>找到了下面这段c++代码如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以找usb设备为例,取得的usb盘符放在UsbRoot里面，len为UsbRoot字符数组的长度</span></span><br><span class="line">BOOL GetUsbRoot(<span class="keyword">CHAR</span>* UsbRoot,<span class="keyword">SHORT</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    DWORD    dwDriveStrLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">CHAR</span>    *pDriveName = <span class="keyword">NULL</span>;</span><br><span class="line">    UINT    Drive  = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (UsbRoot == <span class="keyword">NULL</span> || len &amp;lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dwDriveStrLen = ::GetLogicalDriveStrings(<span class="number">0</span>,<span class="keyword">NULL</span>);<span class="comment">//取得你计算机上盘符数目</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == dwDriveStrLen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">CHAR</span> *szDriveNameBuff = (<span class="keyword">CHAR</span>*)malloc(dwDriveStrLen);<span class="comment">//根据你机器上的磁盘数目分配内存</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">NULL</span> == szDriveNameBuff)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    memset(szDriveNameBuff,<span class="number">0</span>,sizeof(szDriveNameBuff));</span><br><span class="line">    ::GetLogicalDriveStrings(dwDriveStrLen,szDriveNameBuff);<span class="comment">//取得你计算机上所有盘符</span></span><br><span class="line">    pDriveName = szDriveNameBuff;</span><br><span class="line">    <span class="keyword">while</span> (*pDriveName != <span class="keyword">NULL</span>)<span class="comment">//遍历所有盘符，找到你需要的设备</span></span><br><span class="line">    &#123;</span><br><span class="line">        Drive = ::GetDriveType(pDriveName);</span><br><span class="line">        <span class="keyword">switch</span> (Drive)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> DRIVE_UNKNOWN:<span class="comment">//未知设备</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DRIVE_NO_ROOT_DIR:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DRIVE_REMOVABLE:<span class="comment">//usb设备</span></span><br><span class="line">            <span class="comment">//如果为usb，在这里进行相关处理</span></span><br><span class="line">                       <span class="comment">//break;</span></span><br><span class="line">        <span class="keyword">case</span> DRIVE_FIXED:<span class="comment">//硬盘</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DRIVE_REMOTE:<span class="comment">//网络硬盘,如：局域网服务器上的盘</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DRIVE_CDROM:<span class="comment">//光驱</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DRIVE_RAMDISK:<span class="comment">//RAM 盘</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pDriveName += strlen(pDriveName) + <span class="number">1</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">if</span> (szDriveNameBuff != <span class="keyword">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        free(szDriveNameBuff);</span><br><span class="line">        szDriveNameBuff = <span class="keyword">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/05/31/忙于复习的孩子。。。/" itemprop="url">
                忙于复习的孩子。。。
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-05-31T15:01:36+08:00" content="2012-05-31">
            2012-05-31
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>明天就是6月份了，考试周马上就要开始了。</p>
<p>天天混迹6教自习。。。</p>
<p>想到去年的这个时候，也是临近高考。</p>
<p>然后一切都已经过去了，但是对于今年高考的同学来说，一切才马上就要开始。自己唯一能做的，也就是在这里给你们加油了。</p>
<p>给自己一点勉励，不要有松懈之心。</p>
<p>每当自己想松懈的时候，想想去年的自己，想想今年正在努力的同学们。</p>
<p>还有什么理由松懈呢？</p>
<p>&nbsp;</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2012/05/25/2012年5月月末总结/" itemprop="url">
                2012年5月月末总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2012-05-25T21:27:46+08:00" content="2012-05-25">
            2012-05-25
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>又到了一个月一次的月末总结的时刻啦~~~！！！</p>
<p>这个月事情很多，时间有点紧张，感觉老是不够用。所以感觉花在技术方面的时间不是很多~~又不是很多。。怎么感觉自己老是这样啊-_-</p>
<p>先说点有趣的事情好了。这个月想去买单反，然后去市区的佳能专卖店看了一下，还借了本单反的书本稍微浏览了一下。准备是考完试以后准备去买单反。不过正所谓“玩单反，穷三代。”算了不管了，穷就穷了吧，先穷了再说。。。</p>
<p>然后这个月参加了图书馆的快速找书大赛的活动，提高了自己的借书权限。呵呵，以后借书就不用愁了~~~看了几本韩寒的书本《三重门》和《他的国》。感觉还不错，但是总觉得深度差一点。</p>
<p>这个月的考试陆续开始了，体育啊，公选课的考试啊，金工啊什么的，马上就只剩下最关键的三门课程和4级了。所以打算接下来的时间尽量少写代码。。。多多复习。。。</p>
<p>最后来总结下这个月的技术活，代码猴子这个月的技术方面的总结：首先这个月主要是在写信息安全程序设计的题目，注册表编程啊，文件关联 啊，socket啊什么的。因为这跟自己现在在做的项目联系比较大，所以其实算是一边写作业一边做项目了。这样也挺好的。买了windows核心编程，虽 然看的不是很多，有些东西现在自己也看不懂，但是确实是一本好书。</p>
<p>去图书馆借了本《失控》，感觉这本书挺好看的。然后傻逼的又去9楼借了《雪舞》一些文艺小青年看的书本，又去3楼借了一些代码优化艺术的书本。感觉最近书本借的太多了，看都看不过来。。。不过看不过来总比没书本看好。呵呵</p>
<p>等到这阵子忙过去，那就要天天写代码了。再次变成代码猴子。。。。。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/">&laquo;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/15/">&raquo;</a>
  </nav>


            </div>

            

            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/about me.JPG" alt="Miibotree" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Miibotree</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">211</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">111</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Miibotree</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  

  



  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>



<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



  
  

  







<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
